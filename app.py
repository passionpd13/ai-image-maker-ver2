import streamlit as st
import requests
import random
import json
import time
import os
import re
import shutil
import zipfile
from io import BytesIO
from concurrent.futures import ThreadPoolExecutor, as_completed
from PIL import Image
from google import genai
from google.genai import types

# ==========================================
# [ì„¤ì •] í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
# ==========================================
st.set_page_config(
    page_title="ì—´ì •í”¼ë”” AI ì”¬(ì¥ë©´) ìƒì„±ê¸° (Pro)", 
    layout="wide", 
    page_icon="ğŸ¬",
    initial_sidebar_state="expanded"
)

# ==========================================
# [ë””ìì¸] ë‹¤í¬ëª¨ë“œ & Expander/ë²„íŠ¼/Status ê°€ë…ì„± ìµœì¢… ìˆ˜ì • (CSS)
# ==========================================
st.markdown("""
    <style>
    /* [1] ì•± ì „ì²´ ê°•ì œ ë‹¤í¬ëª¨ë“œ */
    .stApp {
        background-color: #0E1117 !important;
        color: #FFFFFF !important;
        font-family: 'Pretendard', sans-serif;
    }

    /* [2] ì‚¬ì´ë“œë°” í…ìŠ¤íŠ¸ í•˜ì–—ê²Œ */
    section[data-testid="stSidebar"] {
        background-color: #12141C !important;
        border-right: 1px solid #2C2F38;
    }

    .st-emotion-cache-1lsfsc6.e1x5aka44 {
        background-color: #262730 !important;
    }
    
    section[data-testid="stSidebar"] * {
        color: #FFFFFF !important;
    }

    /* [3] Expander (í”„ë¡¬í”„íŠ¸ í™•ì¸) ê°€ë…ì„± ì™„ë²½ í•´ê²° */
    [data-testid="stExpander"] {
        background-color: #1F2128 !important;
        border: 1px solid #4A4A4A !important;
        border-radius: 8px !important;
        color: #FFFFFF !important;
    }
    [data-testid="stExpander"] summary {
        color: #FFFFFF !important;
    }
    [data-testid="stExpander"] summary:hover {
        color: #FF4B2B !important; 
    }
    [data-testid="stExpander"] summary svg {
        fill: #FFFFFF !important;
    }
    [data-testid="stExpander"] details > div {
        background-color: #1F2128 !important; 
        color: #FFFFFF !important;              
    }
    [data-testid="stExpander"] p, 
    [data-testid="stExpander"] span, 
    [data-testid="stExpander"] div,
    [data-testid="stExpander"] code {
        color: #FFFFFF !important;
        background-color: transparent !important; 
    }

    /* [4] íŒŒì¼ ì—…ë¡œë” ê°€ë…ì„± í•´ê²° */
    [data-testid="stFileUploader"] {
        background-color: #262730 !important;
        border-radius: 10px;
        padding: 15px;
    }
    [data-testid="stFileUploader"] section {
        background-color: #262730 !important; 
    }
    [data-testid="stFileUploader"] div, 
    [data-testid="stFileUploader"] span, 
    [data-testid="stFileUploader"] small {
        color: #FFFFFF !important;
    }
    [data-testid="stFileUploader"] button {
        background-color: #0E1117 !important;
        color: #FFFFFF !important;
        border: 1px solid #555 !important;
    }

    /* [5] ëª¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì œëª© ì¶”ì²œ í¬í•¨) */
    .stButton > button {
        background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%) !important;
        border: none !important;
        border-radius: 8px !important;
        transition: transform 0.2s;
    }
    .stButton > button:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(255, 75, 43, 0.4);
    }
    .stButton > button * {
        color: #FFFFFF !important;
    }

    /* [6] ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .stTextInput input, .stTextArea textarea {
        background-color: #262730 !important; 
        color: #FFFFFF !important; 
        -webkit-text-fill-color: #FFFFFF !important;
        border: 1px solid #4A4A4A !important;
        caret-color: #FF4B2B !important;
    }
    .stTextInput input::placeholder, .stTextArea textarea::placeholder {
        color: #B0B0B0 !important;
        -webkit-text-fill-color: #B0B0B0 !important;
    }

    /* [7] ë“œë¡­ë‹¤ìš´(Selectbox) */
    div[data-baseweb="select"] > div {
        background-color: #262730 !important;
        color: #FFFFFF !important;
        border-color: #4A4A4A !important;
    }
    div[data-baseweb="popover"], div[data-baseweb="menu"], ul[role="listbox"] {
        background-color: #262730 !important;
    }
    div[data-baseweb="option"], li[role="option"] {
        color: #FFFFFF !important;
        background-color: #262730 !important;
    }
    li[role="option"]:hover, li[aria-selected="true"] {
        background-color: #FF4B2B !important;
        color: #FFFFFF !important;
    }

    /* [8] ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
    [data-testid="stDownloadButton"] button {
        background-color: #2C2F38 !important;
        border: 1px solid #555 !important;
    }
    [data-testid="stDownloadButton"] button * {
        color: #FFFFFF !important;
    }
    [data-testid="stDownloadButton"] button:hover {
        border-color: #FF4B2B !important;
    }
    [data-testid="stDownloadButton"] button:hover * {
        color: #FF4B2B !important;
    }

    /* [9] ê¸°íƒ€ í…ìŠ¤íŠ¸ */
    h1, h2, h3, h4, p, label, li {
        color: #FFFFFF !important;
    }
    .stCaption {
        color: #AAAAAA !important;
    }
    header[data-testid="stHeader"] {
        background-color: #0E1117 !important;
    }

    /* [10] st.status (ì‘ì—… ì§„í–‰ ìƒíƒœì°½) ê°€ë…ì„± í•´ê²° (NEW FIX) */
    [data-testid="stStatusWidget"] {
        background-color: #1F2128 !important;
        border: 1px solid #4A4A4A !important;
    }
    [data-testid="stStatusWidget"] > div {
        background-color: #1F2128 !important;
        color: #FFFFFF !important;
    }
    [data-testid="stStatusWidget"] header {
        background-color: #1F2128 !important;
    }
    [data-testid="stStatusWidget"] svg {
        fill: #FFFFFF !important;
    }
    [data-testid="stStatusWidget"] p, 
    [data-testid="stStatusWidget"] span,
    [data-testid="stStatusWidget"] summary {
        color: #FFFFFF !important;
    }
    </style>
""", unsafe_allow_html=True)


# íŒŒì¼ ì €ì¥ ê²½ë¡œ ì„¤ì •
BASE_PATH = "./web_result_files"
IMAGE_OUTPUT_DIR = os.path.join(BASE_PATH, "output_images")

# í…ìŠ¤íŠ¸ ëª¨ë¸ ì„¤ì •
GEMINI_TEXT_MODEL_NAME = "gemini-2.5-pro" 

# ==========================================
# [í•¨ìˆ˜] 3. ì´ë¯¸ì§€ ìƒì„± ê´€ë ¨ ë¡œì§
# ==========================================

def init_folders():
    for path in [IMAGE_OUTPUT_DIR]:
        if not os.path.exists(path):
            os.makedirs(path, exist_ok=True)

def split_script_by_time(script, chars_per_chunk=100):
    temp_script = script.replace(".", ".|").replace("?", "?|").replace("!", "!|") \
                        .replace("ã€‚", "ã€‚|").replace("ï¼Ÿ", "ï¼Ÿ|").replace("ï¼", "ï¼|") \
                        .replace("\n", "\n|") 

    temp_sentences = temp_script.split("|")
                                        
    chunks = []
    current_chunk = ""
    
    for sentence in temp_sentences:
        sentence = sentence.strip()
        if not sentence: continue
        
        if len(current_chunk) + len(sentence) < chars_per_chunk:
            if current_chunk:
                current_chunk += " " + sentence
            else:
                current_chunk = sentence
        else:
            if current_chunk.strip(): 
                chunks.append(current_chunk.strip())
            
            current_chunk = sentence
            
    if current_chunk.strip():
        chunks.append(current_chunk.strip())
        
    return chunks

def make_filename(scene_num, text_chunk):
    clean_line = text_chunk.replace("\n", " ").strip()
    clean_line = re.sub(r'[\\/:*?"<>|]', "", clean_line)
    
    if not clean_line:
        return f"S{scene_num:03d}_Scene.png"
    
    words = clean_line.split()
    
    if len(words) <= 1 or any(ord(c) > 12000 for c in clean_line[:10]): 
        if len(clean_line) > 16:
            summary = f"{clean_line[:10]}...{clean_line[-10:]}"
        else:
            summary = clean_line
    else:
        if len(words) <= 6:
            summary = " ".join(words)
        else:
            start_part = " ".join(words[:3])
            end_part = " ".join(words[-3:])
            summary = f"{start_part}...{end_part}"
            
            if len(summary) > 50:
                summary = summary[:50]
    
    filename = f"S{scene_num:03d}_{summary}.png"
    return filename

# ==========================================
# [í•¨ìˆ˜] í”„ë¡¬í”„íŠ¸ ìƒì„±
# ==========================================
def generate_prompt(api_key, index, text_chunk, style_instruction, video_title, genre_mode="info", target_language="Korean", target_layout="16:9 ì™€ì´ë“œ ë¹„ìœ¨"):
    scene_num = index + 1
    url = f"https://generativelanguage.googleapis.com/v1beta/models/{GEMINI_TEXT_MODEL_NAME}:generateContent?key={api_key}"
    headers = {'Content-Type': 'application/json'}

    if target_language == "Korean":
        lang_guide = "í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ 'í•œê¸€(Korean)'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤. (ë‹¤ë¥¸ ì–¸ì–´ ì ˆëŒ€ ê¸ˆì§€)"
        lang_example = "(ì˜ˆ: 'ë‰´ìš•', 'ë„ì¿„')"
    elif target_language == "English":
        lang_guide = "í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ 'ì˜ì–´(English)'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤."
        lang_example = "(ì˜ˆ: 'Seoul', 'Dokdo')"
    elif target_language == "Japanese":
        lang_guide = "í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ 'ì¼ë³¸ì–´(Japanese)'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤."
        lang_example = "(ì˜ˆ: 'ã‚½ã‚¦ãƒ«', 'ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯')"
    else:
        lang_guide = f"í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ '{target_language}'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤."
        lang_example = ""

    character_consistency_block = "" 

    vertical_force_prompt = ""
    if "9:16" in target_layout:
        vertical_force_prompt = """
    [â—â— 9:16 ì„¸ë¡œ í™”ë©´ í•„ìˆ˜ ì§€ì¹¨ (Vertical Mode) â—â—]
    1. **êµ¬ë„(Composition):** ê°€ë¡œë¡œ ë„“ì€ í’ê²½(Landscape)ì„ ì ˆëŒ€ ê·¸ë¦¬ì§€ ë§ˆì‹­ì‹œì˜¤.
    2. **ë°°ì¹˜(Placement):** í”¼ì‚¬ì²´ëŠ” í™”ë©´ ì¤‘ì•™ì— ìˆ˜ì§ìœ¼ë¡œ ë°°ì¹˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (ìœ„ì•„ë˜ë¡œ ê¸¸ê²Œ)
    3. **ì¹˜íƒ€/ë™ë¬¼ ì˜ˆì‹œ:** ë™ë¬¼ì´ ë‹¬ë¦¬ëŠ” ì¥ë©´ì´ë¼ë©´, ì˜†ëª¨ìŠµ(Side view) ëŒ€ì‹  **ì •ë©´ì—ì„œ ë‹¬ë ¤ì˜¤ëŠ” ëª¨ìŠµ(Front view)**ì„ êµ¬ë„ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ë¡œ í™”ë©´ì„ ì±„ìš°ì‹­ì‹œì˜¤.
        """

    common_header = f"""
    {character_consistency_block}
    [í™”ë©´ êµ¬ë„ ì§€ì¹¨]
    {target_layout}
    {vertical_force_prompt}
    """

    if genre_mode == "info":
        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ ë³µì¡í•œ ìƒí™©ì„ ì•„ì£¼ ì‰½ê³  ì§ê´€ì ì¸ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” 'ë¹„ì£¼ì–¼ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ë¬¸ê°€'ì´ì 'êµìœ¡ìš© ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°'ì…ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ]
    "{video_title}"

    [ê·¸ë¦¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    {style_instruction}
    
    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **ì¡°ëª…(Lighting):** ë¬´ì¡°ê±´ **'ëª°ì…ê°ìˆëŠ” ì¡°ëª…(High Key Lighting)'**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
    2. **ìƒ‰ê°(Colors):** ì„ ëª…í•œ ìƒ‰ìƒì„ ì‚¬ìš©í•˜ì—¬ ì‹œì¸ì„±ì„ ë†’ì´ì‹­ì‹œì˜¤. (ì¹™ì¹™í•˜ê±°ë‚˜ íšŒìƒ‰ì¡° í†¤ ê¸ˆì§€)
    3. **êµ¬ì„±(Composition):** ì‹œì²­ìê°€ ìƒí™©ì„ í•œëˆˆì— ì´í•´í•  ìˆ˜ ìˆë„ë¡ í”¼ì‚¬ì²´ë¥¼ í™”ë©´ ì¤‘ì•™ì— ëª…í™•í•˜ê²Œ ë°°ì¹˜í•˜ì‹­ì‹œì˜¤.
    4. **ë¶„ìœ„ê¸°(Mood):** êµìœ¡ì ì´ì§€ë§Œ ì‚¬ì‹¤ì , ì¤‘ë¦½ì ì´ë©°, ëª°ì…ê°ìˆëŠ” ë¶„ìœ„ê¸°ì—¬ì•¼ í•©ë‹ˆë‹¤. **(ì ˆëŒ€ ìš°ìš¸í•˜ê±°ë‚˜, ë¬´ì„­ê±°ë‚˜, ê¸°ê´´í•œ ëŠë‚Œ ê¸ˆì§€)**
    5. ë¶„í™œí™”ë©´ìœ¼ë¡œ ì—°ì¶œí•˜ì§€ ë§ê³  í•˜ë‚˜ì˜ í™”ë©´ìœ¼ë¡œ ì—°ì¶œí•œë‹¤.
    6. **[í…ìŠ¤íŠ¸ ì–¸ì–´]:** {lang_guide} {lang_example}
    - **[ì ˆëŒ€ ê¸ˆì§€]:** í™”ë©´ì˜ ë„¤ ëª¨ì„œë¦¬(Corners)ë‚˜ ê°€ì¥ìë¦¬(Edges)ì— ê¸€ìë¥¼ ë°°ì¹˜í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ê¸€ìëŠ” ë°˜ë“œì‹œ ì¤‘ì•™ í”¼ì‚¬ì²´ ì£¼ë³€ì—ë§Œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤.
    7. ìºë¦­í„°ì˜ ê°ì •ë„ ëŠê»´ì§„ë‹¤.
    8. íŠ¹ì • êµ­ê°€ì— ëŒ€í•œ ë‚´ìš©ì¼ì‹œ ë°°ê²½ì— êµ­ê°€ ë¶„ìœ„ê¸°ê°€ ì—°ì¶œ ì˜ë˜ê²Œ í•œë‹¤.
    9. ë°°ê²½ í˜„ì‹¤ê°(Background Realism): ë°°ê²½ì€ ë‹¨ìˆœí•œ í‰ë©´ì´ ì•„ë‹Œ, **ê¹Šì´ê°(Depth)**ê³¼ **ì§ˆê°(Texture)**ì´ ì‚´ì•„ìˆëŠ” ì…ì²´ì ì¸ ê³µê°„ìœ¼ë¡œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤. ì¶”ìƒì ì´ê±°ë‚˜ íë¦¿í•œ ë°°ê²½ ëŒ€ì‹ , ì‹¤ì œ ì¥ì†Œì— ìˆëŠ” ë“¯í•œ **êµ¬ì²´ì ì¸ í™˜ê²½ ë””í…Œì¼(ê±´ì¶• ì–‘ì‹, ìì—°ë¬¼, ì†Œí’ˆ ë°°ì¹˜, ê±°ë¦¬, ê³µê°„ê°„ ë“±)ì„ ì„ ëª…í•˜ê²Œ ë¬˜ì‚¬í•˜ì—¬ 2dì´ì§€ë§Œ í˜„ì¥ê°ì„ ê·¹ëŒ€í™”í•˜ì‹­ì‹œì˜¤.


    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ë°”íƒ•ìœ¼ë¡œ, ì´ë¯¸ì§€ ìƒì„± AIê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì¸ ë¬˜ì‚¬ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± ìš”êµ¬ì‚¬í•­]
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - **ì„¸ë¡œ ëª¨ë“œ ì‹œ:** ìºë¦­í„°ë‚˜ ì‚¬ë¬¼ì´ ì‘ì•„ ë³´ì´ì§€ ì•Šê²Œ ì¤Œì¸(Zoom-in)í•˜ì—¬ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    - **í¬í•¨ ìš”ì†Œ:**
        - **ìºë¦­í„° í–‰ë™:** ëŒ€ë³¸ì˜ ìƒí™©ì„ ì—°ê¸°í•˜ëŠ” ìºë¦­í„°ì˜ êµ¬ì²´ì ì¸ ë™ì‘.
        - **ë°°ê²½:** ìƒí™©ì„ ì„¤ëª…í•˜ëŠ” ì†Œí’ˆì´ë‚˜ ì¥ì†Œë¥¼ ëª°ì…ê° ìˆê³  ê¹Šì´ê° ìˆê²Œ 2dë¡œ êµ¬ì„±. 
        - **ì‹œê°ì  ì€ìœ :** ì¶”ìƒì ì¸ ë‚´ìš©ì¼ ê²½ìš°, ì´ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆëŠ” ì‹œê°ì  ì•„ì´ë””ì–´ (ì˜ˆ: ëˆì´ ë‚ ì•„ê°€ëŠ” ëª¨ìŠµ, ê·¸ë˜í”„ê°€ í•˜ë½í•˜ëŠ” ëª¨ìŠµ ë“±).
          í•œê¸€ ë’¤ì— (ì˜ì–´)ë¥¼ ë„£ì–´ì„œ í”„ë¡¬í”„íŠ¸ì— ì“°ì§€ ì•ŠëŠ”ë‹¤. ex) ìƒ‰ê°(Colors) x ,êµ¬ì„±(Composition) x

    
    [ì¶œë ¥ í˜•ì‹]
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´(í•œê¸€)**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - ë¶€ê°€ì ì¸ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "realistic_stickman":
        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ **'ë„·í”Œë¦­ìŠ¤ 2D ì• ë‹ˆë©”ì´ì…˜ ê°ë…'**ì…ë‹ˆë‹¤. 
    **ë°˜ë“œì‹œ '2D ê·¸ë¦¼(Digital Art)' ìŠ¤íƒ€ì¼**ì´ì–´ì•¼ í•˜ë©°, **ì‹¤ì‚¬(Photorealism)ë‚˜ 3D ë Œë”ë§ ëŠë‚Œì´ ë‚˜ë©´ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.**
    ë‹¨ìˆœí•œ ì–¼êµ´ì´ ë‘¥ê·¼ ìŠ¤í‹±ë§¨ë“¤ì„ ì£¼ì¸ê³µìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬, ë°°ê²½ê³¼ ì¡°ëª…ë§Œ ì˜í™”ì²˜ëŸ¼ ë¶„ìœ„ê¸° ìˆê²Œ ì—°ì¶œí•©ë‹ˆë‹¤.
    
    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìœ ì € ìŠ¤íƒ€ì¼ ì„ í˜¸] {style_instruction}

    [ğŸš« í•µì‹¬ ê¸ˆì§€ ì‚¬í•­ - ì ˆëŒ€ ì–´ê¸°ì§€ ë§ˆì‹œì˜¤]
    - **ì‹¤ì‚¬ ì‚¬ì§„(Real Photo), 3D ë Œë”ë§(Unreal Engine), ì‚¬ëŒ í”¼ë¶€ ì§ˆê°(Skin texture) ì ˆëŒ€ ê¸ˆì§€.**
    - ì‚¬ëŒì˜ ì½”, ì…, ê·€, ì†í†± ë“±ì„ ë¦¬ì–¼í•˜ê²Œ ë¬˜ì‚¬í•˜ì§€ ë§ˆì‹œì˜¤.
    - ë¬´ì¡°ê±´ **'ê·¸ë¦¼(Illustration/Drawing/Manhwa)'** ëŠë‚Œì´ ë‚˜ì•¼ í•©ë‹ˆë‹¤.

    [í•µì‹¬ ë¹„ì£¼ì–¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    1. **ìºë¦­í„°(Character):** - **ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ ìŠ¤í‹±ë§¨(Round-headed white stickman)**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
        - í•˜ì§€ë§Œ ì„ ì€ êµµê³  ë¶€ë“œëŸ¬ìš°ë©°, **ê·¸ë¦¼ì(Shading)**ê°€ ë“¤ì–´ê°€ ì…ì²´ê°ì´ ëŠê»´ì ¸ì•¼ í•©ë‹ˆë‹¤.
        - **ì˜ìƒ:** ëŒ€ë³¸ ìƒí™©ì— ë§ëŠ” í˜„ì‹¤ì ì¸ ì˜ìƒ(ì •ì¥, êµ°ë³µ, ì ì˜·, ì‘ì—…ë³µ ë“±)ì„ ìŠ¤í‹±ë§¨ ìœ„ì— ì…í˜€ 'ìºë¦­í„°ì„±'ì„ ë¶€ì—¬í•˜ì‹­ì‹œì˜¤.
        - ì–¼êµ´ì´ í¬ê²Œ ì˜ ë³´ì´ê²Œ ì—°ì¶œ. ì¥ë©´ë„ ì˜ ë“œëŸ¬ë‚˜ê²Œ.
        
    2. **ë°°ê²½(Background) - ê°€ì¥ ì¤‘ìš”:**
        - ë‹¨ìˆœí•œ ê·¸ë¼ë°ì´ì…˜ì´ë‚˜ ë‹¨ìƒ‰ ë°°ê²½ì„ **ì ˆëŒ€ ê¸ˆì§€**í•©ë‹ˆë‹¤.
        - **ê³ í•´ìƒë„ ì»¨ì…‰ ì•„íŠ¸(High-quality Concept Art)** ìˆ˜ì¤€ìœ¼ë¡œ ë°°ê²½ì„ ê·¸ë¦¬ì‹­ì‹œì˜¤.
        - ì˜ˆ: ì‚¬ë¬´ì‹¤ì´ë¼ë©´ ì±…ìƒì˜ ì„œë¥˜ ë”ë¯¸, ì°½ë°–ì˜ í’ê²½, ì»¤í”¼ì”ì˜ ê¹€, ë²½ì˜ ì§ˆê°ê¹Œì§€ ë¬˜ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤.
        
    3. **ì¡°ëª…(Lighting):**
        - 2Dì§€ë§Œ **ì…ì²´ì ì¸ ì¡°ëª…(Volumetric Lighting)**ê³¼ ê·¸ë¦¼ìë¥¼ ì‚¬ìš©í•˜ì—¬ ê¹Šì´ê°ì„ ë§Œë“œì‹­ì‹œì˜¤.
        - ìƒí™©ì— ë”°ë¼ ë”°ëœ»í•œ í–‡ì‚´, ì°¨ê°€ìš´ ë„¤ì˜¨ì‚¬, ì–´ë‘ìš´ ë°©ì˜ ìŠ¤íƒ ë“œ ì¡°ëª… ë“±ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì‹­ì‹œì˜¤.
        
    4. **ì—°ê¸°(Acting):**
        - ì¸í¬ê·¸ë˜í”½ì²˜ëŸ¼ ì •ë³´ë¥¼ ë‚˜ì—´í•˜ì§€ ë§ê³ , **ìºë¦­í„°ê°€ í–‰ë™(Action)í•˜ëŠ” ì¥ë©´**ì„ í¬ì°©í•˜ì‹­ì‹œì˜¤.
        - ê°ì • í‘œí˜„: ì–¼êµ´ í‘œì •ì€ ë‹¨ìˆœí•˜ê²Œ ê°€ë˜, **ì–´ê¹¨ì˜ ì²˜ì§, ì£¼ë¨¹ ì¥” ì†, ë‹¤ê¸‰í•œ ë‹¬ë¦¬ê¸°, ë¬´ë¦ ê¿‡ê¸° ë“± 'ëª¸ì§“(Body Language)'**ìœ¼ë¡œ ê°ì •ì„ ì „ë‹¬í•˜ì‹­ì‹œì˜¤.

    5. **ì–¸ì–´(Text):** {lang_guide} {lang_example} (ìë§‰ ì—°ì¶œë³´ë‹¤ëŠ” ë°°ê²½ ì† ê°„íŒ, ì„œë¥˜, í™”ë©´ ë“± ìì—°ìŠ¤ëŸ¬ìš´ í…ìŠ¤íŠ¸ ìœ„ì£¼ë¡œ)
    6. **êµ¬ë„:** ë¶„í•  í™”ë©´(Split Screen) ê¸ˆì§€. **{target_layout}** ê½‰ ì°¬ êµ¬ë„ ì‚¬ìš©.

    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ì½ê³ , ê·¸ ìƒí™©ì„ ê°€ì¥ ì˜ ë³´ì—¬ì£¼ëŠ” **í•œ ì¥ë©´ì˜ ì˜í™” ìŠ¤í‹¸ì»·** ê°™ì€ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± íŒ]
    - "A cinematic 2D shot of a round-headed stickman..." ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëŠë‚Œìœ¼ë¡œ ì‘ì„±.
    - ëŒ€ë³¸ì´ ì¶”ìƒì (ì˜ˆ: ê²½ì œ ìœ„ê¸°)ì´ë¼ë©´, ìŠ¤í‹±ë§¨ì´ í…… ë¹ˆ ì§€ê°‘ì„ ë³´ë©° ì¢Œì ˆí•˜ëŠ” êµ¬ì²´ì ì¸ ìƒí™©ìœ¼ë¡œ ì¹˜í™˜í•˜ì—¬ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - ìë§‰ ê°™ì€ ì—°ì¶œ í•˜ì§€ ì•ŠëŠ”ë‹¤. ("í™”ë©´ í•˜ë‹¨ ì¤‘ì•™ì—ëŠ” ëª…ì¡°ì²´ë¡œ **'í•„ë¦¬í•€, 1944ë…„'**ì´ë¼ëŠ” í•œê¸€ í…ìŠ¤íŠ¸ê°€ ì„ ëª…í•˜ê²Œ ìƒˆê²¨ì ¸ ìˆë‹¤" ì´ëŸ° ì—°ì¶œ í•˜ë©´ ì•ˆëœë‹¤) 

    [9:16 ì„¸ë¡œ ëª¨ë“œ íŒ]
    - ìŠ¤í‹±ë§¨ì´ í™”ë©´ì˜ 50% ì´ìƒì„ ì°¨ì§€í•˜ë„ë¡ ê°€ê¹Œì´ì„œ ì¡ìœ¼ì‹­ì‹œì˜¤.
    - ë°°ê²½ ìœ„ì£¼ê°€ ì•„ë‹ˆë¼ **ìºë¦­í„°ì˜ ì—°ê¸° ìœ„ì£¼**ë¡œ í”„ë ˆì„ì„ êµ¬ì„±í•˜ì‹­ì‹œì˜¤.

    [ì¶œë ¥ í˜•ì‹]
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´(í•œê¸€)**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - ë¶€ê°€ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "history":
        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ **ì„¸ê³„ì‚¬ì˜ ê²°ì •ì ì¸ ìˆœê°„ë“¤(í•œêµ­ì‚¬, ì„œì–‘ì‚¬, ë™ì–‘ì‚¬ ë“±)**ì„ í•œêµ­ ì‹œì²­ìì—ê²Œ ì „ë‹¬í•˜ëŠ” 'ì‹œëŒ€ê·¹ ì• ë‹ˆë©”ì´ì…˜ ê°ë…'ì…ë‹ˆë‹¤.
    ì—­ì‚¬ì  ë¹„ê·¹ì„ ë‹¤ë£¨ì§€ë§Œ, ì ˆëŒ€ë¡œ ì”ì¸í•˜ê±°ë‚˜ í˜ì˜¤ìŠ¤ëŸ½ê±°ë‚˜ ê³ ì–´í‹±í•˜ê²Œ ë¬˜ì‚¬ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ê·¸ë¦¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ìœ ì € ì§€ì • (ìµœìš°ì„  ì¤€ìˆ˜)] {style_instruction}
    
    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **[ë§¤ìš° ì¤‘ìš”] ë§¤ì²´(Medium):** ë¬´ì¡°ê±´ **í‰ë©´ì ì¸ '2D ìŠ¤í‹±ë§¨ ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´ì…˜'** ìŠ¤íƒ€ì¼ë¡œ í‘œí˜„í•˜ì‹­ì‹œì˜¤. (3D, ì‹¤ì‚¬, ëª¨ë¸ë§ ëŠë‚Œ ì ˆëŒ€ ê¸ˆì§€)
    2. **[ë§¤ìš° ì¤‘ìš”] í…ìŠ¤íŠ¸ í˜„ì§€í™”(Localization):** ë°°ê²½ì´ ì„œì–‘, ì¤‘êµ­, ì¼ë³¸ ë“± ì–´ë””ë“  ìƒê´€ì—†ì´, {lang_guide}
        - **ê¸ˆì§€:** ì§€ì •ëœ ì–¸ì–´ ì™¸ì˜ ë¬¸ì ì‚¬ìš©ì„ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤.
        - **ì˜ˆì‹œ:** {lang_example}
    3. **[ë§¤ìš° ì¤‘ìš” - ìˆœí™”ëœ í‘œí˜„] ë¹„ê·¹ì˜ ìƒì§•í™”(Symbolization of Tragedy):** ì „ìŸ, ì£½ìŒ, ê³ í†µê³¼ ê°™ì€ ë¹„ê·¹ì ì¸ ìƒí™©ì€ **ì ˆëŒ€ë¡œ ì§ì ‘ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** ë¬¼ë¦¬ì  í­ë ¥ ëŒ€ì‹ , **ìƒì‹¤ê°, í—ˆë¬´í•¨, ì• ë„**ì˜ ì •ì„œì— ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤.
        - **í•µì‹¬:** íŒŒê´´ëœ ì‹ ì²´ë‚˜ ì§ì ‘ì ì¸ ë¬´ê¸° ì‚¬ìš© ì¥ë©´ ëŒ€ì‹ , **ë‚¨ê²¨ì§„ ë¬¼ê±´(ì£¼ì¸ ì—†ëŠ” ì‹ ë°œ, ê¹¨ì§„ ì•ˆê²½), ë“œë¦¬ìš°ëŠ” ê·¸ë¦¼ì, ì‹œë“¤ì–´ë²„ë¦° ìì—°ë¬¼, í˜¹ì€ ë¹›ì´ ì‚¬ë¼ì§€ëŠ” ì—°ì¶œ** ë“±ì„ í†µí•´ ê°„ì ‘ì ìœ¼ë¡œ ìŠ¬í””ì„ í‘œí˜„í•˜ì‹­ì‹œì˜¤.
    4. **[í•µì‹¬] ë‹¤ì–‘í•œ ì¥ì†Œì™€ ì‹œëŒ€ ì—°ì¶œ(Diverse Locations):** ëŒ€ë³¸ì— ë‚˜ì˜¤ëŠ” **íŠ¹ì • ì‹œëŒ€ì™€ ì¥ì†Œì˜ íŠ¹ì§•(ê±´ì¶• ì–‘ì‹, ì˜ìƒ, ìì—°í™˜ê²½)ì„ ì •í™•íˆ í¬ì°©**í•˜ì—¬ ê·¸ë¦¬ì‹­ì‹œì˜¤.
    5. **[ìˆ˜ì •ë¨] ì ˆì œëœ ìºë¦­í„° ì—°ê¸°(Restrained Acting):** 2D ìŠ¤í‹±ë§¨ ìºë¦­í„°ëŠ” ì‹œëŒ€ì— ë§ëŠ” ì˜ìƒì„ ì…ë˜, **ê³¼ì¥ëœ í‘œì •ë³´ë‹¤ëŠ” 'ëª¸ì§“(Body Language)'ê³¼ 'ë¶„ìœ„ê¸°'ë¡œ ê°ì •ì„ í‘œí˜„**í•´ì•¼ í•©ë‹ˆë‹¤. ë¹„ê·¹ì ì¸ ìƒí™©ì—ì„œë„ ê²©ë ¬í•œ ë¶„ë…¸ë‚˜ ê³µí¬ë³´ë‹¤ëŠ” **ê¹Šì€ ìŠ¬í””, ì²´ë…, í˜¹ì€ ê°„ì ˆí•œ ê¸°ë„**ì™€ ê°™ì€ ì •ì ì¸ ê°ì •ì„ ìš°ì„ ì‹œí•˜ì‹­ì‹œì˜¤.
    6. **ì¡°ëª…(Lighting):** 2D ì‘í™” ë‚´ì—ì„œ ê·¹ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“œëŠ” **'ì‹œë„¤ë§ˆí‹± ì¡°ëª…'**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. (ì‹œëŒ€ê·¹ íŠ¹ìœ ì˜ í†¤)
    7. **[ìˆ˜ì •ë¨] ìƒ‰ê°(Colors):** **ì°¨ë¶„í•˜ê³  ì• ìƒì ì¸ ìƒ‰ê°(Somber & Melancholic Tones)**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. ê¹Šì´ ìˆë˜ ë‹¤ì–‘í•œ ì±„ë„ì˜ ìƒ‰ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬, ì—­ì‚¬ ë‹¤íë©˜í„°ë¦¬ì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ ìœ ì§€í•˜ì‹­ì‹œì˜¤. (ìê·¹ì ì¸ ë¶‰ì€ìƒ‰ ê³¼ë‹¤ ì‚¬ìš© ê¸ˆì§€)
    8. **êµ¬ì„±(Composition):** ì‹œì²­ìê°€ ìƒí™©ì„ í•œëˆˆì— ì´í•´í•  ìˆ˜ ìˆë„ë¡ í•µì‹¬ í”¼ì‚¬ì²´ë¥¼ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜í•˜ì‹­ì‹œì˜¤. ë¶„í™œí™”ë©´(Split screen)ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.
    - **[ì ˆëŒ€ ê¸ˆì§€]:** í…ìŠ¤íŠ¸ê°€ í™”ë©´ì˜ ë„¤ ëª¨ì„œë¦¬(Corners)ë‚˜ ê°€ì¥ìë¦¬ì— ë°°ì¹˜ë˜ëŠ” ê²ƒì„ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤. (ìë§‰ ê³µê°„ í™•ë³´)
    9. **[ë§¤ìš° ì¤‘ìš”] ë°°ê²½ë³´ë‹¤ **'ì¸ë¬¼(Character)'ì´ ë¬´ì¡°ê±´ ìš°ì„ **ì…ë‹ˆë‹¤. ìºë¦­í„°ê°€ í™”ë©´ì„ ì¥ì•…í•´ì•¼ í•©ë‹ˆë‹¤.
    10. ìƒí˜¸ì‘ìš©í•˜ëŠ” ì†Œí’ˆ (Interactive Props): ìŠ¤í‹±ë§¨ ìºë¦­í„°ê°€ ëŒ€ë³¸ ì† ì¤‘ìš”í•œ ì‚¬ë¬¼ê³¼ ì–´ë–»ê²Œ ìƒí˜¸ì‘ìš©í•˜ëŠ”ì§€ ëª…í™•íˆ ê·¸ë¦¬ì‹­ì‹œì˜¤. ì‚¬ë¬¼ì€ ë‹¨ìˆœí•˜ì§€ë§Œ ê·¸ íŠ¹ì§•ì´ ëª…í™•í•´ì•¼ í•©ë‹ˆë‹¤.
    11. ìºë¦­í„° ì—°ì¶œ : ìŠ¤í‹±ë§¨ì€ ì‹œëŒ€ë¥¼ ë°˜ì˜í•˜ëŠ” ì˜ìƒê³¼ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì—°ì¶œí•œë‹¤.
    
    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ë°”íƒ•ìœ¼ë¡œ, ì´ë¯¸ì§€ ìƒì„± AIê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì¸ ë¬˜ì‚¬ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± ìš”êµ¬ì‚¬í•­]
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - 9:16 ë¹„ìœ¨ì¼ ê²½ìš°, ì—­ì‚¬ì  ì¸ë¬¼(ìŠ¤í‹±ë§¨)ì˜ **ìƒë°˜ì‹  ìœ„ì£¼**ë¡œ ë¬˜ì‚¬í•˜ì—¬ í‘œì •(ëˆˆë§¤)ì´ë‚˜ ì†ì§“ì´ ì˜ ë³´ì´ê²Œ í•˜ì‹­ì‹œì˜¤.
    - **í¬í•¨ ìš”ì†Œ:**
        - **í…ìŠ¤íŠ¸ ì§€ì‹œ:** (ì¤‘ìš”) ì´ë¯¸ì§€ì— ë“¤ì–´ê°ˆ í…ìŠ¤íŠ¸ë¥¼ ë°˜ë“œì‹œ **'{target_language}'**ë¡œ ëª…ì‹œí•˜ì‹­ì‹œì˜¤.
            - í…ìŠ¤íŠ¸ëŠ” ê·¸ë˜í”½ ì—°ì¶œì´ ì•„ë‹ˆë¼ í™”ë©´ì˜ ì‚¬ë¬¼ì— ìì—°ìŠ¤ëŸ½ê²Œ ì—°ì¶œë˜ê²Œ í•œë‹¤.
        - **ì•ˆì „í•œ ë¬˜ì‚¬:** ì”ì¸í•œ ì¥ë©´ì€ ì€ìœ ì ìœ¼ë¡œ í‘œí˜„í•˜ì—¬ í•„í„°ë§ì„ í”¼í•˜ì‹­ì‹œì˜¤.
        - **ì‹œëŒ€ì  ë°°ê²½:** ëŒ€ë³¸ì˜ ì‹œëŒ€(ê³ ëŒ€/ì¤‘ì„¸/ê·¼ëŒ€)ì™€ ì¥ì†Œ(ë™ì–‘/ì„œì–‘)ë¥¼ ëª…í™•íˆ ë°˜ì˜í•œ ë°°ê²½ ë¬˜ì‚¬.
        - **[ìˆ˜ì •ë¨] ì ˆì œëœ ìºë¦­í„° ì—°ê¸° ë¬˜ì‚¬:**
            - ìŠ¤í‹±ë§¨ì˜ ì–¼êµ´ì€ **ë‹¨ìˆœí•œ ì„ ìœ¼ë¡œ í‘œí˜„ëœ ìŠ¬í”ˆ ëˆˆë§¤, êµ³ê²Œ ë‹¤ë¬¸ ì…ë§¤** ì •ë„ë¡œ ì ˆì œí•˜ì—¬ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤. (ê¸°ê´´í•œ í‘œì • ë¬˜ì‚¬ ê¸ˆì§€)
            - ìŠ¤í‹±ë§¨ì˜ ì‹œëŒ€ì  ì˜ìƒê³¼ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì—°ì¶œí•œë‹¤.
            - **ê°ì •ì€ ëª¸ì§“ìœ¼ë¡œ í‘œí˜„í•˜ì‹­ì‹œì˜¤.** (ì˜ˆ: ê³ ê°œë¥¼ ê¹Šì´ ìˆ™ì¸ ëª¨ìŠµ, ì–¼êµ´ì„ ê°ì‹¸ ì¥” ì†, í˜ì—†ì´ ì¶• ëŠ˜ì–´ì§„ ì–´ê¹¨, ë¬´ë¦ ê¿‡ê³  ê¸°ë„í•˜ëŠ” ìì„¸ ë“± ì •ì ì¸ ë™ì‘ ìœ„ì£¼)
        - ë°°ê²½ ë³´ë‹¤ëŠ” ëŒ€ë³¸ì— ì–´ìš¸ë¦¬ëŠ” ì¸ë¬¼ë“¤ê³¼ ìƒí™© ì—°ì¶œì— ë” ì´ˆì ì„ ë§ì¶˜ë‹¤.
        - ìë§‰ ê°™ì€ ì—°ì¶œ í•˜ì§€ ì•ŠëŠ”ë‹¤. ("í™”ë©´ í•˜ë‹¨ ì¤‘ì•™ì—ëŠ” ëª…ì¡°ì²´ë¡œ **'í•„ë¦¬í•€, 1944ë…„'**ì´ë¼ëŠ” í•œê¸€ í…ìŠ¤íŠ¸ê°€ ì„ ëª…í•˜ê²Œ ìƒˆê²¨ì ¸ ìˆë‹¤" ì´ëŸ° ì—°ì¶œ í•˜ë©´ ì•ˆëœë‹¤) 
    
    [ğŸ­ ìºë¦­í„° ê°ì • ì—°ê¸° ì§€ì¹¨ (Character Acting Guide) - ì¤‘ìš”]
    **ì–¼êµ´ í‘œì •ì´ ë‹¨ìˆœí•œ ìŠ¤í‹±ë§¨ì´ë¯€ë¡œ, 'ëª¸ì§“(Body Language)'ìœ¼ë¡œ ê°ì •ì„ í‘œí˜„í•˜ëŠ” ë° ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤.**
    
    - ê¸ˆì§€: í”¼(Blood), ì¶œí˜ˆ, ì‹œì²´(Corpse, Dead body), ì˜ë¦° ë¨¸ë¦¬(Decapitation), ê³ ë¬¸, ìì‚´, ë¼ˆ/í•´ê³¨(Skeleton), ë‚´ì¥, ë¦¬ì–¼í•œ ì´/ì¹¼(Weapon).
    - **ì¶”ê°€ ê¸ˆì§€:** ê³¼ë„í•˜ê²Œ ì¼ê·¸ëŸ¬ì§„ ì–¼êµ´ í‘œì •, ê³µí¬ì— ì§ˆë ¤ ë¹„ëª… ì§€ë¥´ëŠ” ì… ëª¨ì–‘ ë“± ìê·¹ì ì¸ ì–¼êµ´ ë¬˜ì‚¬.
    - ê¸ˆì§€: ë‚˜ì¹˜(Nazi), ìš±ì¼ê¸° ë“± ì •ì¹˜ì ìœ¼ë¡œ ê·¹ë„ë¡œ ë¯¼ê°í•œ ì‹¬ë³¼.
    
    [ğŸ›¡ï¸ ê²€ì—´ íšŒí”¼ë¥¼ ìœ„í•œ 'ì‹œê°ì  ì€ìœ (Visual Metaphors)' ê°€ì´ë“œ]
    ëŒ€ë³¸ ë‚´ìš©ì´ ë¹„ê·¹ì ì´ê±°ë‚˜ í­ë ¥ì ì¼ ê²½ìš°, ë°˜ë“œì‹œ ì•„ë˜ì˜ **ë¶€ë“œëŸ¬ìš´ ìƒì§•ë¬¼**ë¡œ ëŒ€ì²´í•˜ì—¬ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    
    [ì¶œë ¥ í˜•ì‹]
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - ë¶€ê°€ì ì¸ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
    - (ì§€ë¬¸) ê°™ì€ ë¶€ì—°ì„¤ëª… ì—°ì¶œ ì§€ì‹œì–´ëŠ” ì œì™¸í•œë‹¤.

    - í”„ë¡¬í”„íŠ¸ì— 'ì–¼êµ´ì´ ë‘¥ê·¼ 2d ìŠ¤í‹±ë§¨' ë¬´ì¡°ê±´ ë“¤ì–´ê°„ë‹¤.
        """

    elif genre_mode == "3d_docu":
        vertical_zoom_guide = ""
        if "9:16" in target_layout:
            vertical_zoom_guide = """
    5. **[9:16 ì„¸ë¡œ ëª¨ë“œ í•„ìˆ˜ ì§€ì¹¨ - ì¸ë¬¼ í™•ëŒ€]:**
        - ìŠ¤ë§ˆíŠ¸í° í™”ë©´(ì„¸ë¡œ) íŠ¹ì„±ìƒ ì¸ë¬¼ì´ ë©€ë¦¬ ìˆìœ¼ë©´ ì‹œì¸ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤.
        - **ì¹´ë©”ë¼ë¥¼ í”¼ì‚¬ì²´(ë§ˆë„¤í‚¹) ê°€ê¹Œì´(Close-up, Medium Shot) ë°°ì¹˜í•˜ì—¬, ë¨¸ë¦¬ì™€ ìƒë°˜ì‹ ì´ í™”ë©´ì˜ 50% ì´ìƒì„ ì°¨ì§€í•˜ë„ë¡ ê½‰ ì°¨ê²Œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤.**
        - ë‹¤ì–‘í•œ ì¥ì†Œ í‘œí˜„ì„ ë””í…Œì¼ í•˜ê²Œ, ê·¸ë¦¬ê³  ì‚¬ë¬¼ ë¬˜ì‚¬ë„ ë””í…Œì¼í•˜ê²Œ.
        - ì „ì‹  ìƒ·(Full Shot)ê³¼ í´ë¡œì¦ˆì—… ìœ„ì£¼ë¡œ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
            """

        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ 'Unreal Engine 5'ë¥¼ ì‚¬ìš©í•˜ëŠ” 3D ì‹œë„¤ë§ˆí‹± ì•„í‹°ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
    í˜„ëŒ€ ì‚¬íšŒì˜ ì´ìŠˆë‚˜ ë¯¸ìŠ¤í„°ë¦¬í•œ í˜„ìƒì„ ê³ í€„ë¦¬í‹° 3D ê·¸ë˜í”½ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìœ ì € ìŠ¤íƒ€ì¼ ì„ í˜¸] {style_instruction}

    [í•µì‹¬ ë¹„ì£¼ì–¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    1. **í™”í’ (Art Style):** "A realistic 3D game cinematic screenshot", "Unreal Engine 5 render style", "8k resolution", "Highly detailed texture".
    2. **ìºë¦­í„° ë””ìì¸ (Character Design):** - ë“±ì¥ì¸ë¬¼ì˜ ë¨¸ë¦¬ëŠ” ë°˜ë“œì‹œ **"ë§¤ëˆí•˜ê³  í•˜ì–€, ì´ëª©êµ¬ë¹„ê°€ ì—†ëŠ” ë§ˆë„¤í‚¹ ë¨¸ë¦¬ (Smooth white featureless mannequin head)"**ì—¬ì•¼ í•©ë‹ˆë‹¤.
        - **ì–¼êµ´ ë¬˜ì‚¬ ê¸ˆì§€:** ëˆˆ, ì½”, ì…ì´ ì ˆëŒ€ ì—†ì–´ì•¼ í•©ë‹ˆë‹¤ (Blank face, No eyes/nose/mouth).
        - **ì˜ìƒ:** í•˜ì§€ë§Œ ëª¸ì—ëŠ” **í˜„ì‹¤ì ì¸ ì˜ìƒ(ì •ì¥, ê°€ë””ê±´, ì²­ë°”ì§€, ìœ ë‹ˆí¼ ë“±)**ì„ ì…í˜€ì„œ ê¸°ë¬˜í•˜ê³  í˜„ëŒ€ì ì¸ ëŠë‚Œì„ ì¤ë‹ˆë‹¤.
    3. **ì¡°ëª… ë° ë¶„ìœ„ê¸° (Lighting & Mood):** - "Cinematic lighting", "Dim lighting", "Volumetric fog".
        - ë‹¤ì†Œ ì–´ë‘¡ê³ , ë°ê¸°ë„ í•˜ë©°, ë¯¸ìŠ¤í„°ë¦¬í•˜ë©°, ì§„ì§€í•œ ë¶„ìœ„ê¸°ë¥¼ ì—°ì¶œí•˜ì‹­ì‹œì˜¤.
    4. **ì–¸ì–´ (Text):** {lang_guide} {lang_example} (ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ë¬˜ì‚¬ëŠ” ì¤„ì´ê³  ìƒí™© ë¬˜ì‚¬ì— ì§‘ì¤‘)
    {vertical_zoom_guide}

    [9:16 ì„¸ë¡œ ëª¨ë“œ í•„ìˆ˜ ì§€ì¹¨]
    - ë§ˆë„¤í‚¹ ìºë¦­í„°ë¥¼ **'í¬íŠ¸ë ˆì´íŠ¸ ìƒ·(Portrait Shot)'**ìœ¼ë¡œ ì¡ìœ¼ì‹­ì‹œì˜¤.
    - ì „ì‹ ë³´ë‹¤ëŠ” **ìƒë°˜ì‹  í´ë¡œì¦ˆì—…**ì´ í›¨ì”¬ íš¨ê³¼ì ì…ë‹ˆë‹¤.

    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ë°”íƒ•ìœ¼ë¡œ, ìœ„ ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± íŒ]
    - í”„ë¡¬í”„íŠ¸ ì‹œì‘ ë¶€ë¶„ì— ë°˜ë“œì‹œ **"ì–¸ë¦¬ì–¼ ì—”ì§„ 5 ìŠ¤íƒ€ì¼, Realistic 3D game screenshot, Smooth white featureless mannequin head character"** í‚¤ì›Œë“œê°€ í¬í•¨ë˜ë„ë¡ ë¬¸ì¥ì„ êµ¬ì„±í•˜ì‹­ì‹œì˜¤.
    - ëŒ€ë³¸ì˜ ìƒí™©(ì¢Œì ˆ, ì„±ê³µ, íšŒì˜, í­ë½ ë“±)ì„ ë§ˆë„¤í‚¹ ìºë¦­í„°ê°€ ì—°ê¸°í•˜ë„ë¡ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.

    [ì¶œë ¥ í˜•ì‹]
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´(í•œê¸€)**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤. (ë‹¨, Unreal Engine 5 ê°™ì€ í•µì‹¬ ì˜ë‹¨ì–´ëŠ” í˜¼ìš© ê°€ëŠ¥)
    - ë¶€ê°€ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
    - (ì§€ë¬¸) ê°™ì€ ë¶€ì—°ì„¤ëª… ì—°ì¶œ ì§€ì‹œì–´ëŠ” ì œì™¸í•œë‹¤.
        """
        
    elif genre_mode == "scifi":
        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ 'Fern', 'AiTelly', 'Blackfiles' ì±„ë„ ìŠ¤íƒ€ì¼ì˜ **ê¹”ë”í•˜ê³  ëª…í™•í•œ '3D í…Œí¬ë‹ˆì»¬ ì• ë‹ˆë©”ì´í„°'**ì…ë‹ˆë‹¤.
    ë³µì¡í•œ ê¸°ê³„ë‚˜ ê³¼í•™ ì›ë¦¬ë¥¼ ì„¤ëª…í•˜ë˜, **ì—”ì§€ë‹ˆì–´/ê³¼í•™ì ìºë¦­í„°ì˜ í–‰ë™**ì„ í†µí•´ ì‹œì²­ìì˜ ì´í•´ë¥¼ ë•ìŠµë‹ˆë‹¤. (ì–´ë‘¡ê³  ê³¼í•œ ì‹œë„¤ë§ˆí‹± X, ë°ê³  ëª…í™•í•œ êµìœ¡ìš© O)

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìœ ì € ìŠ¤íƒ€ì¼ ì„ í˜¸] {style_instruction}

    [í•µì‹¬ ë¹„ì£¼ì–¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    1. **í™”í’ (Art Style):** "3D Technical Animation", "Blender Cycles Render", "Clean rendering", "High detail".
    2. **ë¶„ìœ„ê¸° ë° ì¡°ëª… (Atmosphere & Lighting):**
        - **"Clean Studio Lighting", "Bright", "Educational"**.
        - ê·¸ë¦¼ìê°€ ë„ˆë¬´ ì§™ê±°ë‚˜ ì–´ë‘ì›Œì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ëª¨ë“  ë¶€í’ˆê³¼ ì¸ë¬¼ì´ ëª…í™•í•˜ê²Œ ë³´ì—¬ì•¼ í•©ë‹ˆë‹¤.
    3. **í”¼ì‚¬ì²´ (Subject) - ê¸°ê³„ì™€ ì¸ë¬¼ì˜ ì¡°í™”:**
        - **ê¸°ê³„/êµ¬ì¡°ë¬¼:** ë‹¨ë©´ë„(Cutaway), íˆ¬ì‹œë„(X-ray view), ë¶„í•´ë„(Exploded view)ë¥¼ ì ê·¹ í™œìš©í•˜ì—¬ ë‚´ë¶€ ì‘ë™ ì›ë¦¬ë¥¼ ë³´ì—¬ì£¼ì‹­ì‹œì˜¤.
        - **[ì¤‘ìš”] ì¸ë¬¼(Characters):** ëŒ€ë³¸ ë‚´ìš©ì— ë§ì¶° ì—”ì§€ë‹ˆì–´, ê³¼í•™ì, ì‘ì—…ìë¥¼ 3d ê²Œì„ ìºë¦­í„° ì²˜ëŸ¼ ë“±ì¥ì‹œí‚¤ì‹­ì‹œì˜¤.
            - **ë³µì¥:** ì•ˆì „ëª¨, ì‹¤í—˜ ê°€ìš´, ì‘ì—…ë³µ ë“± ì „ë¬¸ì ì¸ ë³µì¥.
            - **í–‰ë™:** ë‹¨ìˆœíˆ ì„œ ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ê¸°ê³„ë¥¼ ì¡°ì‘í•˜ê±°ë‚˜, íŠ¹ì • ë¶€ìœ„ë¥¼ ê°€ë¦¬í‚¤ë©° ì„¤ëª…í•˜ê±°ë‚˜, ë‹¨ë©´ì„ ê´€ì°°í•˜ëŠ” ë“± 'ê¸°ëŠ¥ì ì¸ í–‰ë™'**ì„ ì·¨í•´ì•¼ í•©ë‹ˆë‹¤.
    4. **ì¹´ë©”ë¼ (Camera):** "Clear view", "Isometric view"(ì„ íƒì ), "Slight zoom"(ë””í…Œì¼ ê°•ì¡°). ê³¼ë„í•œ ì•„ì›ƒí¬ì»¤ì‹±(ì‹¬ë„)ì€ ìì œí•˜ê³  ì „ì²´ì ìœ¼ë¡œ ì¨í•˜ê²Œ ë³´ì—¬ì£¼ì‹­ì‹œì˜¤.
    5. **ì–¸ì–´ (Text):** {lang_guide} {lang_example} (í™”ì‚´í‘œì™€ í•¨ê»˜ ë¶€í’ˆ ëª…ì¹­ì„ ì§€ì‹œí•  ë•Œë§Œ ìµœì†Œí•œìœ¼ë¡œ ì‚¬ìš©)

    [9:16 ì„¸ë¡œ ëª¨ë“œ ì§€ì¹¨]
    - ê¸°ê³„ ì „ì²´ë¥¼ ë³´ì—¬ì£¼ë ¤ í•˜ì§€ ë§ê³ , **ì‘ë™í•˜ëŠ” í•µì‹¬ ë¶€í’ˆì„ í™•ëŒ€(Zoom-in)**í•˜ì—¬ ì„¸ë¡œ í™”ë©´ì— ê½‰ ì°¨ê²Œ ë³´ì—¬ì£¼ì‹­ì‹œì˜¤.
    - ìœ„ì•„ë˜ ê³µê°„ì„ í™œìš©í•˜ì—¬ ë¶€í’ˆì´ ë¶„í•´ë˜ëŠ” ëª¨ìŠµ(Exploded view)ì„ ìˆ˜ì§ìœ¼ë¡œ ë°°ì¹˜í•˜ì‹­ì‹œì˜¤.

    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ë°”íƒ•ìœ¼ë¡œ, ë§ˆì¹˜ ê³µí•™ êµìœ¡ ì˜ìƒì˜ í•œ ì¥ë©´ ê°™ì€ 3D í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± íŒ]
    - í”„ë¡¬í”„íŠ¸ ì‹œì‘ ë¶€ë¶„ì— ë°˜ë“œì‹œ **"3D technical animation, Blender Cycles render, Clean studio lighting, Cutaway view"** í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ì‹­ì‹œì˜¤.
    - **ì¸ë¬¼ ë“±ì¥ ì‹œ í–‰ë™ ë¬˜ì‚¬ ì˜ˆì‹œ:** "ì•ˆì „ëª¨ë¥¼ ì“´ ì—”ì§€ë‹ˆì–´ê°€ ê±°ëŒ€í•œ í„°ë¹ˆì˜ ë‹¨ë©´ì„ ì†ìœ¼ë¡œ ê°€ë¦¬í‚¤ê³  ìˆë‹¤", "ê³¼í•™ìê°€ ì‹¤í—˜ ì¥ë¹„ë¥¼ ì¡°ì‘í•˜ë©° ë°ì´í„°ë¥¼ í™•ì¸í•˜ëŠ” ëª¨ìŠµ".
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.

    [ì¶œë ¥ í˜•ì‹]
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´(í•œê¸€)**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤. (ë‹¨, Cutaway, X-ray view ê°™ì€ í•µì‹¬ ì˜ë‹¨ì–´ëŠ” í˜¼ìš© ê°€ëŠ¥)
    - ë¶€ê°€ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "paint_explainer":
        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ ìœ íŠœë¸Œ 'The Paint Explainer' ì±„ë„ ìŠ¤íƒ€ì¼ì˜ **'ê¹”ë”í•˜ê³  ì§ê´€ì ì¸ ìŠ¤í‹±ë§¨ ë””ì§€í„¸ ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°'**ì…ë‹ˆë‹¤.
    ë³µì¡í•œ ì´ì•¼ê¸°ë¥¼ **'ì •ëˆëœ ì„ ê³¼ ë‹¤ì±„ë¡œìš´ í”Œë« ì»¬ëŸ¬'**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œì²­ìê°€ ì§ê´€ì ìœ¼ë¡œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ê·¸ë ¤ì•¼ í•©ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] {style_instruction}

    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **[í•µì‹¬ - ë°°ê²½] 'ë‹¨ìˆœí™”ëœ 2D í”Œë« ë°°ê²½(Simple 2D Flat Background)'ìœ¼ë¡œ ì±„ìš°ì‹­ì‹œì˜¤.**
        - ë°°ê²½ì„ í•˜ì–—ê²Œ ë¹„ì›Œë‘ì§€ ë§ˆì‹­ì‹œì˜¤.
        - ëŒ€ë³¸ ì¥ì†Œì— ë§ì¶° í•˜ëŠ˜, ë•…, ë²½, ë°”ë‹¥ ë“±ì„ ë‹¨ìˆœí•œ ë©´ìœ¼ë¡œ ë¶„í• í•˜ì—¬ ì¹ í•˜ì‹­ì‹œì˜¤. (ì˜ˆ: íŒŒë€ í•˜ëŠ˜ê³¼ ì´ˆë¡ ë•… / ë² ì´ì§€ìƒ‰ ë²½ê³¼ ê°ˆìƒ‰ ë°”ë‹¥)
        - ë³µì¡í•œ ì§ˆê°ì´ë‚˜ ê·¸ë¼ë°ì´ì…˜ ì—†ì´ **ê¹”ë”í•œ ë‹¨ìƒ‰ ì±„ìš°ê¸°(Flat Color Fill)**ë¡œ í‘œí˜„í•˜ì‹­ì‹œì˜¤.
          
    2. **[í•µì‹¬ - ì‘í™” ìŠ¤íƒ€ì¼] 'ê¹”ë”í•˜ê³  ë§¤ë„ëŸ¬ìš´ ì„ (Clean & Smooth Lines)':**
        - **ì ˆëŒ€ ê¸ˆì§€:** ë§ˆìš°ìŠ¤ë¡œ ëŒ€ì¶© ê·¸ë¦° ë“¯í•œ ì‚ëš¤ë¹¼ëš¤í•œ ì„ , ê±°ì¹œ ìŠ¤ì¼€ì¹˜ ëŠë‚Œì„ ë°°ì œí•˜ì‹­ì‹œì˜¤.
        - **ì§€í–¥ì :** ë²¡í„° ì´ë¯¸ì§€ì²˜ëŸ¼ **ì„ ì´ ë§¤ë„ëŸ½ê³  ì •ëˆë˜ì–´ ìˆì–´ì•¼ í•˜ë©°**, ë‘ê»˜ê°€ ì¼ì •í•˜ê³  ê¹”ë”í•´ì•¼ í•©ë‹ˆë‹¤.
        - ê·¸ë¦¼ìì™€ ëª…ì•”ì„ ê·¸ë¦¬ì§€ ì•ŠëŠ” **ì™„ì „í•œ í‰ë©´(Flat Design)** ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì‹­ì‹œì˜¤.

    3. **[í•µì‹¬ - ìºë¦­í„°] 'ìŠ¤í‹±ë§¨':**
        - ë¨¸ë¦¬ëŠ” í•˜ì–€ìƒ‰ ë™ê·¸ë¼ë¯¸, ëª¸í†µê³¼ íŒ”ë‹¤ë¦¬ëŠ” ì„ ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ë‹¨ìˆœí•œ êµ¬ì¡°ì…ë‹ˆë‹¤.
        - ë°°ê²½ì— ë¬»íˆì§€ ì•Šë„ë¡ **êµµê³  ì„ ëª…í•œ ê²€ì€ìƒ‰ ì™¸ê³½ì„ (Bold Black Outline)**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
        - ìƒí™©ì— ë”°ë¼ ìºë¦­í„°ì—ê²Œ ìƒ‰ê¹” ìˆëŠ” ë‹¨ìˆœí•œ ì˜ìƒì„ ì…í˜€ ê°€ì‹œì„±ì„ ë†’ì—¬ë„ ì¢‹ìŠµë‹ˆë‹¤.
        - **í–‰ë™(Body Language):** ì •ì ì¸ ìì„¸ë¥¼ í”¼í•˜ì‹­ì‹œì˜¤. **ì˜¨ëª¸ì„ ì‚¬ìš©í•œ ì—­ë™ì ì¸ í¬ì¦ˆ**ë¡œ ìƒí™©ì„ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
        - **ê°€ì‹œì„± í™•ë³´:** ê°ì • í‘œí˜„ì´ ì¤‘ìš”í•œ ì¥ë©´ì—ì„œëŠ” ìºë¦­í„°ë¥¼ í™”ë©´ ì¤‘ì•™ì— **í¬ê²Œ ë°°ì¹˜í•˜ê±°ë‚˜ ì•½ê°„ì˜ í´ë¡œì¦ˆì—…**ì„ ì‚¬ìš©í•˜ì—¬ í‘œì •ì´ ì˜ ë³´ì´ë„ë¡ êµ¬ë„ë¥¼ ì¡ìœ¼ì‹­ì‹œì˜¤.

    4. **[í•µì‹¬ - ì†Œí’ˆ ë° ì‹œê°ì  ì€ìœ  (Visual Metaphor) - ê°•í™”ë¨]:**
        - ëŒ€ë³¸ì˜ í•µì‹¬ ì‚¬ë¬¼ì„ ì•„ì´ì½˜ì²˜ëŸ¼ ë‹¨ìˆœí•˜ê³  ëª…í™•í•˜ê²Œ ê³¼ì¥í•˜ì—¬ ê·¸ë¦¬ì‹­ì‹œì˜¤.
        - ì¶”ìƒì ì¸ ê°œë…ì„ ì‹œê°í™”í•˜ëŠ” **ì€ìœ (Metaphor)**ë¥¼ ì ê·¹ í™œìš©í•˜ì‹­ì‹œì˜¤.
            - (ì˜ˆ: 'ì••ë°•ê°' -> ìŠ¤í‹±ë§¨ ë¨¸ë¦¬ ìœ„ì— ê±°ëŒ€í•œ ì‡³ë©ì´ ì¶”ê°€)
        - ë§Œí™”ì  ê¸°í˜¸(í™”ì‚´í‘œ â†’, ë¬¼ìŒí‘œ ?, ëŠë‚Œí‘œ !, ë•€ë°©ìš¸ ğŸ’¦, ë°˜ì§ì„ âœ¨, ìŠ¤í”¼ë“œ ì„ )ë¥¼ ê·¸ë¦¼ ì˜†ì— ì ê·¹ì ìœ¼ë¡œ ì¶”ê°€í•˜ì—¬ ìƒí™© ì „ë‹¬ë ¥ì„ ê·¹ëŒ€í™”í•˜ì‹­ì‹œì˜¤.
    
    5. **[ìƒ‰ìƒ ì‚¬ìš©]:**
        - ì „ì²´ì ìœ¼ë¡œ ë°ê³  ì„ ëª…í•œ í”Œë« ì»¬ëŸ¬ë¥¼ ë‹¤ì–‘í•˜ê²Œ ì‚¬ìš©í•˜ë˜, ë³µì¡í•´ ë³´ì´ì§€ ì•Šê²Œ ì •ëˆëœ ìƒ‰ê°ì„ ìœ ì§€í•˜ì‹­ì‹œì˜¤.
        - í•µì‹¬ì ì¸ ì‚¬ë¬¼ì´ë‚˜ ê°•ì¡°ì ì—ëŠ” ì±„ë„ê°€ ë†’ì€ ì›ìƒ‰(ë¹¨ê°•, ë…¸ë‘, íŒŒë‘)ì„ ì‚¬ìš©í•˜ì—¬ ì‹œì„ ì„ ì§‘ì¤‘ì‹œí‚¤ì‹­ì‹œì˜¤.

    6. **[í…ìŠ¤íŠ¸ ì²˜ë¦¬] - 'êµµê³  ë‹¤ì–‘í•œ ì†ê¸€ì”¨(Bold & Varied Handwriting)':** {lang_guide} {lang_example}
        - ë”±ë”±í•œ ë””ì§€í„¸ í°íŠ¸ ëŒ€ì‹ , **ì‚¬ëŒì´ ë§ˆì¹´íœì´ë‚˜ ë¶“ìœ¼ë¡œ ê¾¹ê¾¹ ëˆŒëŸ¬ ì“´ ë“¯í•œ 'êµµì€ ì†ê¸€ì”¨ ëŠë‚Œ'**ìœ¼ë¡œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤.
        - ìƒí™©ì— ë”°ë¼ **ê·€ì—¬ìš´ ê¸€ì”¨, ê±°ì¹œ ê¸€ì”¨, í˜ë ¤ ì“´ ê¸€ì”¨** ë“± ë‹¤ì–‘í•œ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ì—¬ ë‹¨ì¡°ë¡œì›€ì„ í”¼í•˜ì‹­ì‹œì˜¤.
        - í…ìŠ¤íŠ¸ëŠ” ë°°ê²½ ê·¸ë¦¼ì˜ ì¼ë¶€ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ì–´ìš°ëŸ¬ì ¸ì•¼ í•©ë‹ˆë‹¤.
        - í…ìŠ¤íŠ¸ ì—­ì‹œ ê¹”ë”í•œ ë””ì§€í„¸ í°íŠ¸ ëŠë‚Œìœ¼ë¡œ ê·¸ë¦¼ ì˜†ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°°ì¹˜í•˜ì‹­ì‹œì˜¤.
        - **[ì ˆëŒ€ ê¸ˆì§€]:** í™”ë©´ì˜ ë„¤ ëª¨ì„œë¦¬(Corners)ë‚˜ ê°€ì¥ìë¦¬(Edges)ì— ê¸€ìë¥¼ ë°°ì¹˜í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ê¸€ìëŠ” ë°˜ë“œì‹œ ì¤‘ì•™ í”¼ì‚¬ì²´ ì£¼ë³€ì—ë§Œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤.


    7. **[êµ¬ë„]:** ë¶„í•  í™”ë©´ ê¸ˆì§€. **{target_layout}** ë¹„ìœ¨ì˜ í™”ë©´ì„ ê½‰ ì±„ìš°ëŠ” í•˜ë‚˜ì˜ ì™„ê²°ëœ ì¥ë©´(Full Scene Illustration)ìœ¼ë¡œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤.

    [9:16 ì„¸ë¡œ ëª¨ë“œ ì§€ì¹¨]
    - **ìŠ¤í‹±ë§¨ì„ ë§¤ìš° í¬ê²Œ ê·¸ë¦¬ì‹­ì‹œì˜¤.** í™”ë©´ì˜ 2/3ë¥¼ ì°¨ì§€í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.
    - ë§í’ì„ ì´ë‚˜ ê¸°í˜¸(?, !)ë¥¼ ìºë¦­í„° ë¨¸ë¦¬ ìœ„(ìˆ˜ì§ ë°©í–¥)ì— ë°°ì¹˜í•˜ì—¬ ì„¸ë¡œ ê³µê°„ì„ í™œìš©í•˜ì‹­ì‹œì˜¤.

    [ì„ë¬´]
    ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ AIê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” **'ê¹”ë”í•œ The Paint Explainer ìŠ¤íƒ€ì¼'ì˜ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - **í•„ìˆ˜ í‚¤ì›Œë“œ ë°˜ì˜:** "Clean digital line art, smooth lines, minimal vector style, flat design aesthetic, colorful flat background, no shading, bold outlines, infographic elements (arrows, symbols), visual metaphor"
    - **ê¸ˆì§€ í‚¤ì›Œë“œ:** "crude drawing, rough sketch, ms paint style, wobbly lines, sketchy"
    - **í•œê¸€**ë¡œë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "comic_realism":
        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ **'ê³ í€„ë¦¬í‹° ì‹¤ì‚¬ ë°°ê²½ì— ìš°ìŠ¤ê½ìŠ¤ëŸ¬ìš´ í•©ì„±ì„ í•˜ëŠ” ì´ˆí˜„ì‹¤ì£¼ì˜ ì•„í‹°ìŠ¤íŠ¸'**ì…ë‹ˆë‹¤.
    ë§ˆì¹˜ ë‚´ì…”ë„ ì§€ì˜¤ê·¸ë˜í”½ ë‹¤íë©˜í„°ë¦¬ ì¥ë©´ì— ìœ ë¨¸ëŸ¬ìŠ¤í•œ ìŠ¤í‹°ì»¤ë¥¼ ë¶™ì¸ ë“¯í•œ 'ë³‘ë§›(Bizarre Humor)' ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] {style_instruction}

    [í•µì‹¬ ë¹„ì£¼ì–¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    1. **[ë² ì´ìŠ¤: ê·¹ë„ë¡œ ì‚¬ì‹¤ì ì¸ ì‹¤ì‚¬ (Hyper-Realism)]:**
        - **ë°°ê²½(Background) & ëª¸ì²´(Body):** ë¬´ì¡°ê±´ **'Unreal Engine 5 Render', '8K Photograph', 'Cinematic Lighting'** ìŠ¤íƒ€ì¼ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
        - ë™ë¬¼ì˜ í„¸, ì‚¬ëŒì˜ ì˜· ì£¼ë¦„, í”¼ë¶€ ì§ˆê°, ì£¼ë³€ í™˜ê²½(ìˆ², ë„ì‹œ ë“±)ì€ ì‚¬ì§„ì²˜ëŸ¼ ë¦¬ì–¼í•´ì•¼ í•©ë‹ˆë‹¤.

    2. **[ë°˜ì „ í¬ì¸íŠ¸ 1: ì‚¬ëŒ ì–¼êµ´ (Human Face)]:**
        - ëˆˆ (Eyes): ì™„ë²½í•œ ì›í˜•ì˜ í°ììœ„ì— ì‘ì€ ì ìœ¼ë¡œ í‘œí˜„ëœ ëˆˆë™ì(Dot pupils)ê°€ íŠ¹ì§•ì…ë‹ˆë‹¤. ì´ëŠ” **'ë¦­ ì•¤ ëª¨í‹°(Rick and Morty)'**ì™€ ê°™ì€ ì„œì–‘ ì• ë‹ˆë©”ì´ì…˜ì—ì„œ ë‹¹í™©í•˜ê±°ë‚˜ ë©ì²­í•´ ë³´ì´ëŠ” í‘œì •ì„ ì—°ì¶œí•  ë•Œ ìì£¼ ì“°ëŠ” ê¸°ë²•ì…ë‹ˆë‹¤.
        - ëª¸ê³¼ í–‰ë™ì€ ì§„ì§€í•˜ê³  ì‚¬ì‹¤ì ì´ë‹¤.
        - **Face Style Keywords:** "Simple 2D cartoon face pasted on real body", "Exaggerated expression with bold lines".
        - ìœ¤ê³½ì„  (Outlines): êµµê¸°ê°€ ì¼ì •í•œ ê²€ì€ìƒ‰ ë¼ì¸ìœ¼ë¡œ ë‹¨ìˆœí•˜ê²Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ëª…ì•”ì´ë‚˜ ì§ˆê° ë¬˜ì‚¬ê°€ ì „í˜€ ì—†ëŠ” ì „í˜•ì ì¸ 2D ë“œë¡œì‰ ë°©ì‹ì…ë‹ˆë‹¤.
        - ì±„ìƒ‰ (Coloring): ê·¸ë¼ë°ì´ì…˜ì´ë‚˜ ê·¸ë¦¼ì ì—†ì´ ë‹¨ìƒ‰(Flat color)ìœ¼ë¡œ ì±„ì›Œì ¸ ìˆë‹¤.
        
    3. **[ë°˜ì „ í¬ì¸íŠ¸ 2: ë™ë¬¼ ëˆˆ (Animal Eyes)]:**
        - ë§˜ëª¨ìŠ¤, ì‚¬ì, ê³µë£¡ ë“± ìœ„í˜‘ì ì¸ ë™ë¬¼ì´ë¼ë„ **ëˆˆ(Eyes)ì€ ë°˜ë“œì‹œ 'ë‹¨ìˆœí•œ 2D ë§Œí™” ëˆˆ'**ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
        - **Eye Style Keywords:** "2D cartoon eyes", "Simple white sclera with black dot pupils", "Silly expression".
        - **[ì°¸ì¡° ìŠ¤íƒ€ì¼]** ì œê³µëœ ë§¤ë¨¸ë“œ ì´ë¯¸ì§€ì²˜ëŸ¼, ì‹¤ì‚¬ ëˆˆ ëŒ€ì‹  **í°ìƒ‰ í°ìì™€ ê²€ì€ìƒ‰ ì  ëˆˆë™ìë¡œ ëœ ë‹¨ìˆœí•œ ë§Œí™” ëˆˆ**ì„ ì ìš©í•˜ì‹­ì‹œì˜¤.

    4. **ì¡°ëª… ë° ë¶„ìœ„ê¸°:** - ì¡°ëª…ì€ **ë§¤ìš° ì§„ì§€í•˜ê³  ì›…ì¥í•˜ê²Œ(Cinematic & Epic)** ì—°ì¶œí•˜ì—¬, ìš°ìŠ¤ê½ìŠ¤ëŸ¬ìš´ ì–¼êµ´ê³¼ ëŒ€ë¹„ë¥¼ ê·¹ëŒ€í™”í•˜ì‹­ì‹œì˜¤.
    
    5. **[í…ìŠ¤íŠ¸]:** {lang_guide} {lang_example}
        - [í•„ìˆ˜] í…ìŠ¤íŠ¸ëŠ” ê°„íŒ ì´ëŸ°ê²Œ ì•„ë‹Œì´ìƒ ê±°ì˜ ì—°ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤. íŠ¹íˆ ê·¸ë˜í”½ ê°™ì´ ìì—°ìŠ¤ëŸ½ì§€ ì•Šê²Œ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤.
        - ë§í’ì„  ì—°ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.

    [ğŸ­ ëŒ€ë³¸ ì—°ì¶œ ë° í–‰ë™ ì§€ì¹¨ (Action & Storytelling) - ì¤‘ìš”]
    ìºë¦­í„°ê°€ ë‹¨ìˆœíˆ ì„œ ìˆëŠ” ì •ì ì¸ ì¥ë©´ì€ í”¼í•˜ì‹­ì‹œì˜¤. **ëŒ€ë³¸ ë‚´ìš©ì„ 'ì˜¨ëª¸ìœ¼ë¡œ' ì—°ê¸°í•´ì•¼ í•©ë‹ˆë‹¤.**
    - ìºë¦­í„°ì˜ **ëª¸(Body)**ì€ í—ë¦¬ìš°ë“œ ì•¡ì…˜ ì˜í™”ë‚˜ ë¹„ê·¹ì ì¸ ë‹¤íë©˜í„°ë¦¬ ì£¼ì¸ê³µì²˜ëŸ¼ **ë§¤ìš° ì§„ì§€í•˜ê³  ì—­ë™ì ì¸ í¬ì¦ˆ**ë¥¼ ì·¨í•´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: ì ˆê·œí•˜ë©° ë¬´ë¦ ê¿‡ê¸°, ë‹¤ê¸‰í•˜ê²Œ ë„ë§ì¹˜ê¸°, ë¹„ì¥í•˜ê²Œ ì§€íœ˜í•˜ê¸°)
    - ëŒ€ë³¸ì„ í‘œí˜„í•˜ëŠ” ë™ë¬¼ë“¤ì˜ í–‰ë™ ì—°ì¶œ ê·¹ëŒ€í™”.

    [ğŸš¨ 9:16 ì„¸ë¡œ ëª¨ë“œ í•„ìˆ˜ ì§€ì¹¨ (Vertical Layout) ğŸš¨]
    - **í™˜ê²½(Environment)ë³´ë‹¤ ìºë¦­í„°(Character)ê°€ ìš°ì„ ì…ë‹ˆë‹¤.**
    - ê´‘í™œí•œ ì´ˆì›ì„ ë©€ë¦¬ì„œ ì°ì§€ ë§ˆì‹­ì‹œì˜¤. (ìºë¦­í„°ê°€ ì ìœ¼ë¡œ ë³´ì´ë©´ ì‹¤íŒ¨ì…ë‹ˆë‹¤.)
    - **êµ¬ë„:** ì¹´ë©”ë¼ ë Œì¦ˆë¥¼ ìºë¦­í„° ì½”ì•ê¹Œì§€ ê°€ì ¸ì˜¤ì‹­ì‹œì˜¤ (Extreme Close-up / Selfie angle).
    - **ì¹˜íƒ€/ë™ë¬¼:** ë™ë¬¼ì´ í™”ë©´ ë°–ìœ¼ë¡œ íŠ€ì–´ë‚˜ì˜¬ ë“¯ì´ **ì •ë©´ìœ¼ë¡œ ë‹¬ë ¤ì˜¤ëŠ” êµ¬ë„**ë‚˜, **ì–¼êµ´ì´ í™”ë©´ì— ì ë‹¹íˆ ì°¨ëŠ” êµ¬ë„**ë¥¼ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    - ë°°ê²½ì€ ìºë¦­í„° ë’¤ë¡œ íë¦¿í•˜ê²Œ ë‚ ì•„ê°€ê±°ë‚˜(Depth of field), ìœ„ì•„ë˜ë¡œ ë»—ì€ ë‚˜ë¬´/ê±´ë¬¼/ë¹™í•˜/ìš°ì£¼/ëˆˆ/ë„ì‹œ ë“±ì„ ì´ìš©í•´ ìˆ˜ì§ê°ì„ ì£¼ì‹­ì‹œì˜¤.

    [ì„ë¬´]
    ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ ìœ„ ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - **í•„ìˆ˜ í‚¤ì›Œë“œ í¬í•¨:** "Photorealistic 8k render, Unreal Engine 5, Cinematic lighting, Funny 2D cartoon face on realistic body, 2D cartoon eyes (white sclera, black dot pupil) on animal, Visual comedy, Meme style collage, Vertical Portrait Composition, Close-up"
    - **ìƒí™© ì—°ì¶œ:** ëŒ€ë³¸ì˜ ì‹¬ê°í•œ ìƒí™©(ì˜ˆ: ë©¸ì¢…, ì „ìŸ)ì„ ë¬˜ì‚¬í•˜ë˜, ìºë¦­í„°ë“¤ì˜ í‘œì •ì€ ë©ì²­í•˜ê±°ë‚˜(Derp) ê³¼ì¥ë˜ê²Œ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    - (ì§€ë¬¸) ê°™ì€ ë¶€ì—°ì„¤ëª… ì—°ì¶œ ì§€ì‹œì–´ëŠ” ì œì™¸í•œë‹¤.
    - **í•œê¸€**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "pink_skull":
        full_instruction = f"""
    {common_header}
    [ì—­í• ]
    ë‹¹ì‹ ì€ **'Helix' ì±„ë„ ìŠ¤íƒ€ì¼ì˜ 3D ì•„í‹°ìŠ¤íŠ¸**ì…ë‹ˆë‹¤.
    ê¸°ê´´í•˜ì§€ë§Œ ìœ ë¨¸ëŸ¬ìŠ¤í•œ **'íˆ¬ëª…í•œ í”Œë¼ìŠ¤í‹±/ìœ ë¦¬ ì¬ì§ˆì˜ í•´ê³¨'**ì´ ë“±ì¥í•˜ì—¬ ëŒ€ë³¸ì˜ ìƒí™©ì„ ì—°ê¸°í•©ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] {style_instruction}

    [í•µì‹¬ ë¹„ì£¼ì–¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    1. **[í•„ìˆ˜ - ë°°ê²½] ë¬´ì¡°ê±´ 'ë‹¨ìƒ‰ í•‘í¬ ë°°ê²½ (Solid Pink Background)'**:
        - ë°°ê²½ì€ ë³µì¡í•œ í’ê²½ì´ ì•„ë‹ˆë¼, **ê· ì¼í•œ ë¶„í™ìƒ‰(#FFC0CB ~ #FF69B4)** ìŠ¤íŠœë””ì˜¤ ë°°ê²½ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
        - ê°€êµ¬(ì†ŒíŒŒ, ì˜ì) ì™¸ì—ëŠ” ë°°ê²½ì— ë¶ˆí•„ìš”í•œ ì‚¬ë¬¼ì„ ë‘ì§€ ë§ˆì‹­ì‹œì˜¤.

    2. **[í•„ìˆ˜ - ìºë¦­í„°] íˆ¬ëª…/ë°˜íˆ¬ëª… í•´ê³¨ (Translucent Skeleton)**:
        - **ì¬ì§ˆ:** ê²‰ì€ ë§¤ë„ëŸ¬ìš´ íˆ¬ëª… í”Œë¼ìŠ¤í‹±/ìœ ë¦¬ ì¬ì§ˆì´ì§€ë§Œ, **'ë‚´ë¶€ì˜ ë¼ˆ êµ¬ì¡°(Internal Bone Structure)'**ê°€ ì€ì€í•˜ê³  ë””í…Œì¼í•˜ê²Œ ë¹„ì³ ë³´ì—¬ì•¼ í•©ë‹ˆë‹¤. (ë‹¨ìˆœí•œ íˆ¬ëª… ë©ì–´ë¦¬ X)
        - **ëˆˆ(Eyes) - ê°€ì¥ ì¤‘ìš”:** - í•´ê³¨ì˜ ëˆˆêµ¬ë©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤. 
            - ë°˜ë“œì‹œ **'ì„ ëª…í•˜ê³  í•˜ì–€ ëˆˆë™ì(Bright White Eyeballs)'**ê°€ ë°•í˜€ ìˆì–´ì•¼ í•¨. (ê²€ì€ìƒ‰ ì‘ì€ ë™ê³µ). ë©ì²­í•˜ê³  ìš°ìŠ¤ê½ìŠ¤ëŸ¬ìš´ í‘œì • í•„ìˆ˜.[ìì„¸ ë° ì—°ì¶œ]
            - **ìì„¸(Pose):** ê¸°ë³¸ì ìœ¼ë¡œ **'ì†ŒíŒŒ(Sofa)'ë‚˜ 'ì±…ìƒ(Desk) ì˜ì'ì— ì•‰ì•„ìˆëŠ”(Sitting)'** ëª¨ìŠµ ìœ„ì£¼. (ìƒí™©ì— ë”°ë¼ ì„œ ìˆê±°ë‚˜ ì¶¤ì¶”ëŠ” ì—°ì¶œ ê°€ëŠ¥).
            - ê±°ë§Œí•˜ê±°ë‚˜ í™(Hip)í•˜ê²Œ ê±¸í„°ì•‰ì€ ìì„¸.
        - [ì†Œí’ˆ ë° ë°°ê²½]
        - ê°€êµ¬: ë²¨ë²³ ì†ŒíŒŒ, ê²Œì´ë° ì˜ì, ê³ ê¸‰ ì±…ìƒ ë“± ê°€êµ¬ì˜ ë””í…Œì¼í•œ ë¬˜ì‚¬.
        - ì†Œí’ˆ: ëŒ€ë³¸ ì† ë¬¼ê±´(ëˆ, ìŒì‹, ê¸°ê³„)ì„ ì‚¬ì‹¤ì ìœ¼ë¡œ í‘œí˜„.
        - ë°°ê²½: ë¬´ì¡°ê±´ **'ë‹¨ìƒ‰ í•‘í¬(Solid Pink)'** ìœ ì§€.

    3. **[í•„ìˆ˜ - ìì„¸ ë° ê°€êµ¬ (Pose & Furniture)]**:
        - **ìì„¸:** í•´ê³¨ì€ ê³µì¤‘ì— ë–  ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **'í‘¹ì‹ í•œ ì†ŒíŒŒ(Sofa)', 'ê³ ê¸‰ ê°€ì£½ ì˜ì', 'ì±…ìƒ(Desk)'** ë“±ì— **ì•‰ì•„ ìˆëŠ”(Sitting)** êµ¬ë„ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
        - ìƒí™©ì´ ì—­ë™ì ì¼ ë•Œë§Œ ì„œ ìˆê±°ë‚˜(Standing) ì›€ì§ì´ëŠ” ìì„¸ë¥¼ ì·¨í•˜ì‹­ì‹œì˜¤.
        - ê°€êµ¬ ë¬˜ì‚¬: ì†ŒíŒŒì˜ ì£¼ë¦„, ì±…ìƒì˜ ë‚˜ë¬´ ì§ˆê° ë“± ê°€êµ¬ëŠ” ë§¤ìš° ì‚¬ì‹¤ì (Photorealistic)ì´ì–´ì•¼ í•©ë‹ˆë‹¤.

    4. **[ì†Œí’ˆ ë° ì—°ì¶œ]**:
        - í•´ê³¨ì´ ëŒ€ë³¸ì— ë‚˜ì˜¤ëŠ” **ìŒì‹, ëˆ, ìŠ¤ë§ˆíŠ¸í°, ê²Œì„ê¸° ë“±ì„ ì†ì— ë“¤ê³  ìˆê±°ë‚˜ ì±…ìƒ ìœ„ì— ì˜¬ë ¤ë‘ì–´ì•¼ í•©ë‹ˆë‹¤.**
        - ì†Œí’ˆì€ í•‘í¬ ë°°ê²½ê³¼ ëŒ€ë¹„ë˜ëŠ” **ì±„ë„ ë†’ì€ ìƒ‰ìƒ**ìœ¼ë¡œ ì‚¬ì‹¤ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.

    5. **[ì¡°ëª… ë° ë Œë”ë§]**:
        - **"Blender 3D, Octane Render, High Glossy, Subsurface Scattering"**.
        - í•´ê³¨ì˜ íˆ¬ëª…í•œ ì¬ì§ˆê³¼ ëˆˆì•Œì´ ë°˜ì§ì´ë„ë¡ **ë°ê³  ì¨í•œ ìŠ¤íŠœë””ì˜¤ ì¡°ëª…**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.

    6. **[í…ìŠ¤íŠ¸]**: {lang_guide} {lang_example}
        - í…ìŠ¤íŠ¸ëŠ” í•´ê³¨ ì˜† ê³µê°„ì´ë‚˜, í•´ê³¨ì´ ë“¤ê³  ìˆëŠ” íŒ»ë§ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°°ì¹˜í•˜ì‹­ì‹œì˜¤.

    [9:16 ì„¸ë¡œ ëª¨ë“œ ì§€ì¹¨]
    - í•´ê³¨ì´ ì˜ìì— ì•‰ì•„ ìˆëŠ” ëª¨ìŠµì´ ì˜ë¦¬ê±°ë‚˜ ì‘ì•„ ë³´ì´ì§€ ì•Šê²Œ, **'ë¬´ë¦ ìœ„ ìƒë°˜ì‹ (Medium Shot)'**ì´ë‚˜ **'ì–¼êµ´ê³¼ ìƒì²´(Close-up)'** ìœ„ì£¼ë¡œ ê½‰ ì°¨ê²Œ ì¡ìœ¼ì‹­ì‹œì˜¤.

    [ì„ë¬´]
    ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ ìœ„ ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - **í•„ìˆ˜ í‚¤ì›Œë“œ:** "3D render, Translucent clear plastic human skeleton with visible internal bones, Funny Googly eyes, Sitting on a sofa/chair, Solid Pink background, Studio lighting"
    - **í•œê¸€**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
        """

    else: # Fallback
        full_instruction = f"ìŠ¤íƒ€ì¼: {style_instruction}. ë¹„ìœ¨: {target_layout}. ëŒ€ë³¸ ë‚´ìš©: {text_chunk}. ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì‘ì„±."

    # ê³µí†µ ì‹¤í–‰ ë¡œì§
    payload = {
        "contents": [{"parts": [{"text": f"Instruction:\n{full_instruction}\n\nScript Segment:\n\"{text_chunk}\"\n\nImage Prompt (Korean Only, Safe for Work):"}]}]
    }

    try:
        response = requests.post(url, headers=headers, data=json.dumps(payload))
        if response.status_code == 200:
            try:
                prompt = response.json()['candidates'][0]['content']['parts'][0]['text'].strip()
                
                if "9:16" in target_layout:
                      prompt = "Vertical 9:16 smartphone wallpaper composition, Close-up shot, Portrait mode, (ì„¸ë¡œ í™”ë©´ ê½‰ ì°¬ êµ¬ë„), " + prompt
                      
                banned_words = ["í”¼ê°€", "í”¼ë¥¼", "ì‹œì²´", "ì ˆë‹¨", "í•™ì‚´", "ì‚´í•´", "Blood", "Kill", "Dead"]
                for bad in banned_words:
                    prompt = prompt.replace(bad, "")
            except:
                prompt = text_chunk
            return (scene_num, prompt)
        elif response.status_code == 429:
            time.sleep(2)
            return (scene_num, f"ì¼ëŸ¬ìŠ¤íŠ¸ ë¬˜ì‚¬: {text_chunk}")
        else:
            return (scene_num, f"Error generating prompt: {response.status_code}")
    except Exception as e:
        return (scene_num, f"Error: {e}")

# ==========================================
# [í•¨ìˆ˜] generate_image: API ì œí•œ(429) ì™„ë²½ ëŒ€ì‘ + ì¬ì‹œë„ ê°•í™” + ë¹„ìœ¨ ì„¤ì •
# ==========================================
def generate_image(client, prompt, filename, output_dir, selected_model_name, target_ratio="16:9"):
    full_path = os.path.join(output_dir, filename)
    
    max_retries = 5
    
    last_error_msg = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜" 

    safety_settings = [
        types.SafetySetting(
            category="HARM_CATEGORY_DANGEROUS_CONTENT",
            threshold="BLOCK_ONLY_HIGH"
        ),
        types.SafetySetting(
            category="HARM_CATEGORY_HARASSMENT",
            threshold="BLOCK_ONLY_HIGH"
        ),
        types.SafetySetting(
            category="HARM_CATEGORY_HATE_SPEECH",
            threshold="BLOCK_ONLY_HIGH"
        ),
        types.SafetySetting(
            category="HARM_CATEGORY_SEXUALLY_EXPLICIT",
            threshold="BLOCK_ONLY_HIGH"
        ),
    ]

    for attempt in range(1, max_retries + 1):
        try:
            response = client.models.generate_content(
                model=selected_model_name,
                contents=[prompt],
                config=types.GenerateContentConfig(
                    image_config=types.ImageConfig(aspect_ratio=target_ratio), 
                    safety_settings=safety_settings 
                )
            )
            
            if response.parts:
                for part in response.parts:
                    if part.inline_data:
                        img_data = part.inline_data.data
                        image = Image.open(BytesIO(img_data))
                        image.save(full_path)
                        return full_path
            
            last_error_msg = "ì´ë¯¸ì§€ ë°ì´í„° ì—†ìŒ (Blocked by Safety Filter?)"
            print(f"âš ï¸ [ì‹œë„ {attempt}/{max_retries}] {last_error_msg} ({filename})")
            time.sleep(2)
            
        except Exception as e:
            error_msg = str(e)
            last_error_msg = error_msg 
            
            if "429" in error_msg or "ResourceExhausted" in error_msg:
                wait_time = (2 * attempt) + random.uniform(0.5, 2.0)
                print(f"ğŸ›‘ [API ì œí•œ] {filename} - {wait_time:.1f}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„... (ì‹œë„ {attempt})")
                time.sleep(wait_time)
            else:
                print(f"âš ï¸ [ì—ëŸ¬] {error_msg} ({filename}) - 5ì´ˆ ëŒ€ê¸°")
                time.sleep(5)
            
    print(f"âŒ [ìµœì¢… ì‹¤íŒ¨] {filename}")
    return f"ERROR_DETAILS: {last_error_msg}"

def create_zip_buffer(source_dir):
    buffer = BytesIO()
    with zipfile.ZipFile(buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        for root, dirs, files in os.walk(source_dir):
            for file in files:
                file_path = os.path.join(root, file)
                zip_file.write(file_path, os.path.basename(file_path))
    buffer.seek(0)
    return buffer


# ==========================================
# [UI] ì‚¬ì´ë“œë°” (ìë™ ë¡œê·¸ì¸ + ì¥ë¥´ ì„ íƒ ì ìš©)
# ==========================================
with st.sidebar:
    st.header("âš™ï¸ í™˜ê²½ ì„¤ì •")
    
    api_key = st.text_input("ğŸ”‘ Google API Key", type="password", help="Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")

    st.markdown("---")
    
    st.subheader("ğŸ–¼ï¸ ì´ë¯¸ì§€ ëª¨ë¸ ì„ íƒ")
    model_choice = st.radio("ì‚¬ìš©í•  AI ëª¨ë¸:", ("Premium (Gemini 3 Pro)", "Fast (Gemini-2.5-pro)"), index=0)
    
    if "Gemini 3 Pro" in model_choice:
        SELECTED_IMAGE_MODEL = "gemini-3-pro-image-preview" 
    else:
        SELECTED_IMAGE_MODEL = "gemini-2.5-flash-image"

    st.info(f"âœ… ì„ íƒ ëª¨ë¸: `{SELECTED_IMAGE_MODEL}`")
    
    st.markdown("---")
    st.subheader("ğŸ“ í™”ë©´ ë¹„ìœ¨ ì„ íƒ")
    ratio_selection = st.radio(
        "ì˜ìƒ í™”ë©´ ë¹„ìœ¨:",
        ("16:9 (ìœ íŠœë¸Œ ê°€ë¡œí˜•)", "9:16 (ì‡¼ì¸ /ë¦´ìŠ¤ ì„¸ë¡œí˜•)"),
        index=0
    )

    if "9:16" in ratio_selection:
        TARGET_RATIO = "9:16"
        LAYOUT_KOREAN = """
        [9:16 Vertical Portrait Mode]
        - ì´ ì´ë¯¸ì§€ëŠ” ì„¸ë¡œë¡œ ê¸´ ìŠ¤ë§ˆíŠ¸í° ë°°ê²½í™”ë©´ ë¹„ìœ¨ì…ë‹ˆë‹¤.
        - ì ˆëŒ€ ê°€ë¡œë¡œ ë„“ì€ ê´‘ê°(Wide angle) êµ¬ë„ë¥¼ ì¡ì§€ ë§ˆì‹­ì‹œì˜¤.
        - **ì„¸ë¡œí˜• í¬íŠ¸ë ˆì´íŠ¸(Vertical Portrait)** êµ¬ë„ë¥¼ ì‚¬ìš©í•˜ì—¬, í”¼ì‚¬ì²´(ì¸ë¬¼/ë™ë¬¼)ê°€ í™”ë©´ì˜ ì¢Œìš°ë¥¼ ê½‰ ì±„ìš°ë„ë¡ 'í´ë¡œì¦ˆì—…(Close-up)' í•˜ì‹­ì‹œì˜¤.
        - ë¨¸ë¦¬ë¶€í„° í—ˆë¦¬ê¹Œì§€ ë³´ì—¬ì£¼ëŠ” 'ë¯¸ë””ì—„ ìƒ·' ë˜ëŠ” ì–¼êµ´ì´ ê½‰ ì°¨ëŠ” 'í´ë¡œì¦ˆì—…'ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
        """
    else:
        TARGET_RATIO = "16:9"
        LAYOUT_KOREAN = "16:9 ì™€ì´ë“œ ë¹„ìœ¨."

    st.markdown("---")
    st.subheader("â±ï¸ ì¥ë©´ ë¶„í•  ì„¤ì •")
    chunk_duration = st.slider("í•œ ì¥ë©´ë‹¹ ì§€ì† ì‹œê°„ (ì´ˆ)", 5, 60, 30, 5)
    chars_limit = chunk_duration * 8 
    
    st.markdown("---")
    
    st.subheader("ğŸ¨ ì˜ìƒ ì¥ë¥´(Mood) ì„¤ì •")

    PRESET_INFO = """ëŒ€ì‚¬ì— ì–´ìš¸ë¦¬ëŠ” 2d ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ ìŠ¤í‹±ë§¨ ì—°ì¶œë¡œ ì„¤ëª…ê³¼ ì´í•´ê°€ ì˜ë˜ëŠ” ëŠë‚Œìœ¼ë¡œ ê·¸ë ¤ì¤˜ ìƒí™©ì„ ì˜ ë‚˜íƒ€ë‚´ê²Œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ë§ê³  í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ë„ˆë¬´ ì–´ì§€ëŸ½ì§€ ì•Šê²Œ, ê¸€ì”¨ëŠ” í•µì‹¬ í‚¤ì›Œë“œ 2~3ë§Œ ë‚˜ì˜¤ê²Œ í•œë‹¤.
ê¸€ì”¨ê°€ ë„ˆë¬´ ë§ì§€ ì•Šê²Œ í•µì‹¬ë§Œ. 2D ìŠ¤í‹±ë§¨ì„ í™œìš©í•´ ëŒ€ë³¸ì„ ì„¤ëª…ì´ ì˜ë˜ê²Œ ì„¤ëª…í•˜ëŠ” ì—°ì¶œì„ í•œë‹¤. ìë§‰ ìŠ¤íƒ€ì¼ ì—°ì¶œì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
ê¸€ì”¨ê°€ ë‚˜ì˜¬ê²½ìš° í•µì‹¬ í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œë§Œ ë‚˜ì˜¤ê²Œ ë„ˆë¬´ ê¸€ì´ ë§ì§€ ì•Šë„ë¡ í•œë‹¤, ê¸€ìëŠ” ë°°ê²½ê³¼ ì‚¬ë¬¼ì— ìì—°ìŠ¤ëŸ½ê²Œ ì—°ì¶œ, ì „ì²´ ë°°ê²½ ì—°ì¶œì€ 2Dë¡œ ë””í…Œì¼í•˜ê²Œ ì…ì²´ì ì´ê³  ëª°ì…ê° ìˆê²Œ ì—°ì¶œí•´ì„œ ê·¸ë ¤ì¤˜ (16:9).
ë‹¤ì–‘í•œ ì¥ì†Œì™€ ìƒí™© ì—°ì¶œë¡œ ë°°ê²½ì„ ë””í…Œì¼í•˜ê²Œ í•œë‹¤. ë¬´ì¡°ê±´ 2D ìŠ¤í‹±ë§¨ ì—°ì¶œ."""
    
    PRESET_REALISTIC = """ê³ í€„ë¦¬í‹° ì–¼êµ¬ì´ ë‘¥ê·¼ 2D ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼, ì‚¬ì‹¤ì ì¸ ë°°ê²½ê³¼ ì¡°ëª… ì—°ì¶œ.
ìºë¦­í„°: ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ 2D ìŠ¤í‹±ë§¨ë“¤. ë‹¨ìˆœí•œ ë‚™ì„œê°€ ì•„ë‹ˆë¼, ëª…ì•”ê³¼ ë©ì–´ë¦¬ê°ì´ ëŠê»´ì§€ëŠ” 'ê³ ê¸‰ ìŠ¤í‹±ë§¨' ìŠ¤íƒ€ì¼. ì–¼êµ´ì´ í¬ê²Œ ì˜ë³´ì´ê²Œ ì—°ì¶œ.
ë°°ê²½: ë‹¨ìˆœí•œ ë‹¨ìƒ‰ ë°°ê²½ ê¸ˆì§€. ëŒ€ë³¸ì˜ ì¥ì†Œ(ì‚¬ë¬´ì‹¤, ê±°ë¦¬, ë°© ì•ˆ, ì „ì¥ ë“±)ë¥¼ 'ì‚¬ì§„'ì²˜ëŸ¼ ë””í…Œì¼í•˜ê³  ì…ì²´ì ìœ¼ë¡œ 2d ë¬˜ì‚¬.
ë¶„ìœ„ê¸°: ì •ë³´ ì „ë‹¬ë³´ë‹¤ëŠ” 'ìƒí™©ê·¹(Drama)'ì— ì§‘ì¤‘. ì˜í™”ì ì¸ ì¡°ëª…(Cinematic Lighting)ê³¼ ì‹¬ë„(Depth) í‘œí˜„.
ì—°ì¶œ: ìŠ¤í‹±ë§¨ ì—¬ëŸ¬ ìºë¦­í„°ë“¤ì´ ëŒ€ë³¸ ì† í–‰ë™ì„ ë¦¬ì–¼í•˜ê²Œ ì—°ê¸°(Acting). ê°ì • í‘œí˜„ì€ í‘œì •ë³´ë‹¤ëŠ” ì—­ë™ì ì¸ ëª¸ì§“(Body Language)ìœ¼ë¡œ ê·¹ëŒ€í™”.
ì ˆëŒ€ ê¸ˆì§€: í™”ë©´ ë¶„í• (Split Screen), í…ìŠ¤íŠ¸ ë‚˜ì—´, ë‹¨ìˆœ ì¸í¬ê·¸ë˜í”½ ìŠ¤íƒ€ì¼.
ëŒ€ë³¸ì˜ ìƒí™©ì„ ì˜ ë‚˜íƒ€ë‚´ê²Œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ë§ê³  í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ì—°ì¶œ."""

    PRESET_HISTORY = """ì—­ì‚¬ì  ì‚¬ì‹¤ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ '2D ì‹œë„¤ë§ˆí‹± ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ ìŠ¤í‹±ë§¨ ì• ë‹ˆë©”ì´ì…˜' ìŠ¤íƒ€ì¼.
ê¹Šì´ ìˆëŠ” ìƒ‰ê°(Dark & Rich Tone)ê³¼ ê·¹ì ì¸ ì¡°ëª… ì‚¬ìš©.
ìºë¦­í„°ëŠ” 2D ì‹¤ë£¨ì—£ì´ë‚˜ ìŠ¤í‹±ë§¨ì´ì§€ë§Œ ì‹œëŒ€ì— ë§ëŠ” ì˜ìƒê³¼ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì°©ìš©.
2D ìŠ¤í‹±ë§¨ì„ í™œìš©í•´ ëŒ€ë³¸ì„ ì„¤ëª…ì´ ì˜ë˜ê²Œ ì„¤ëª…í•˜ëŠ” ì—°ì¶œì„ í•œë‹¤. ìë§‰ ìŠ¤íƒ€ì¼ ì—°ì¶œì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
ì „ìŸ, ê¸°ê·¼ ë“±ì˜ ë¬˜ì‚¬ëŠ” ìƒì§•ì ì´ê³  ì€ìœ ì ìœ¼ë¡œ í‘œí˜„. ë„ˆë¬´ ê³ ì–´í‹±í•œ ì—°ì¶œì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
ë°°ê²½ ë¬˜ì‚¬ì— ë””í…Œì¼ì„ ì‚´ë ¤ ì‹œëŒ€ì  ë¶„ìœ„ê¸°ë¥¼ ê°•ì¡°. ë¬´ì¡°ê±´ ì–¼êµ´ì´ ë‘¥ê·¼ 2D ìŠ¤í‹±ë§¨ ì—°ì¶œ.
ëŒ€ë³¸ì˜ ìƒí™©ì„ ì˜ ë‚˜íƒ€ë‚´ê²Œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ë§ê³  í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ì—°ì¶œ."""

    PRESET_3D = """Unreal Engine 5 render style, Realistic 3D game cinematic screenshot.
í”¼ì‚¬ì²´: ë§¤ëˆí•˜ê³  í•˜ì–€ ì´ëª©êµ¬ë¹„ ì—†ëŠ” ë§ˆë„¤í‚¹ ë¨¸ë¦¬ (Smooth white featureless mannequin head). ëˆˆì½”ì… ì—†ìŒ.
ë³µì¥: ê°€ë””ê±´, ì²­ë°”ì§€, ì •ì¥ ë“± í˜„ì‹¤ì ì¸ ì˜ìƒì„ ì…í˜€ ê¸°ë¬˜í•œ ëŠë‚Œ ê°•ì¡°.
ì¡°ëª…: ì˜í™” ê°™ì€ ì¡°ëª… (Cinematic lighting), ë‹¤ì†Œ ì–´ë‘¡ê³  ë¶„ìœ„ê¸° ìˆëŠ”(Moody) ì—°ì¶œ.
ë°°ê²½: ë‚¡ì€ ì†ŒíŒŒ, ì–´ì§€ëŸ¬ì§„ ë°© ë“± ì‚¬ì‹¤ì ì¸ í…ìŠ¤ì²˜ì™€ ë””í…Œì¼(8k resolution), í˜„ì‹¤ì ì¸ ë‹¤ì–‘í•œ ì¥ì†Œ.
ëŒ€ë³¸ì˜ ìƒí™©ì„ ì˜ ë‚˜íƒ€ë‚´ê²Œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ë§ê³  í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ì—°ì¶œ."""

    PRESET_SCIFI = """3D Technical Animation (Fern, AiTelly Style).
í™”í’: Blender Cycles / Clean Rendering, ë°ì€ ìŠ¤íŠœë””ì˜¤ ì¡°ëª…(Clean Studio Lighting).
ì—°ì¶œ: ê¸°ê³„/ê±´ì¶•ë¬¼ì˜ ë‹¨ë©´ë„(Cutaway) ë° ì‘ë™ ì›ë¦¬ ì‹œê°í™”.
ì¸ë¬¼: ì—”ì§€ë‹ˆì–´/ê³¼í•™ì/êµì‚¬/íšŒì‚¬ì›/êµ°ì¸ ë“±ë“± ë‹¤ì–‘í•œ 3d ìºë¦­í„°ê°€ ë“±ì¥í•˜ì—¬ ê¸°ê³„ë¥¼ ì¡°ì‘í•˜ê±°ë‚˜ ì„¤ëª…í•˜ëŠ” ê¸°ëŠ¥ì  ì—­í•  ìˆ˜í–‰.
ë¶„ìœ„ê¸°: ê¹”ë”í•˜ê³ , êµìœ¡ì ì´ë©°, ëª…í™•í•¨(Clear & Educational). ê³¼ë„í•œ ê·¸ë¦¼ì ë°°ì œ.
ëŒ€ë³¸ì˜ ìƒí™©ì„ ì˜ ë‚˜íƒ€ë‚´ê²Œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ë§ê³  í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ì—°ì¶œ."""

    PRESET_PAINT = """'The Paint Explainer' ìœ íŠœë¸Œ ì±„ë„ ìŠ¤íƒ€ì¼ (Expressive Clean Stickman).
í™”í’: 'ê¹”ë”í•˜ê³  ë§¤ë„ëŸ¬ìš´ ë””ì§€í„¸ ì„ í™”(Clean Smooth Lines)'ì™€ 'êµµì€ ì†ê¸€ì”¨(Bold Handwriting)' í…ìŠ¤íŠ¸.
ë°°ê²½: í°ìƒ‰ ì—¬ë°± ê¸ˆì§€. í•˜ëŠ˜, ë•…, ë²½, ë°”ë‹¥ ë“±ì´ ë‹¨ìˆœí•˜ê²Œ ë©´ìœ¼ë¡œ êµ¬ë¶„ëœ 'í”Œë«í•œ 2D ë°°ê²½'.
ìºë¦­í„°: í•˜ì–€ìƒ‰ ì–¼êµ´ì´ ë‘¥ê·¼ 2d ìŠ¤í‹±ë§¨. **í•µì‹¬ì€ ê³¼ì¥ëœ í‘œì •ê³¼ ì—­ë™ì ì¸ í–‰ë™ìœ¼ë¡œ ê°ì •ì„ ê·¹ì ìœ¼ë¡œ ì—°ì¶œí•˜ëŠ” ê²ƒ.** ìºë¦­í„°ê°€ í¬ê²Œ ì˜ ë³´ì´ê²Œ ë°°ì¹˜.
ì±„ìƒ‰: ëª…ì•” ì—†ëŠ” 'ë‹¤ì±„ë¡œìš´ í”Œë« ì»¬ëŸ¬'ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒë™ê° ë¶€ì—¬.
ì—°ì¶œ: ì§ê´€ì ì¸ ì‚¬ë¬¼ í‘œí˜„ê³¼ ë§Œí™”ì  ê¸°í˜¸ ì ê·¹ í™œìš©.
ëŒ€ë³¸ì˜ ìƒí™©ì„ ì˜ ë‚˜íƒ€ë‚´ê²Œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ë§ê³  í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ì—°ì¶œ."""

    PRESET_COMIC_REAL = """Hyper-Realistic Environment with Comic Elements.
ë°°ê²½ê³¼ ì‚¬ë¬¼, ì‚¬ëŒ/ë™ë¬¼ì˜ ëª¸ì²´: 'ì–¸ë¦¬ì–¼ ì—”ì§„ 5' ìˆ˜ì¤€ì˜ 8K ì‹¤ì‚¬(Photorealistic). í„¸, í”¼ë¶€ ì§ˆê°, ì¡°ëª… ì™„ë²½ êµ¬í˜„.
ì‚¬ëŒ ì–¼êµ´: ëª¸ì€ ì‹¤ì‚¬ì§€ë§Œ ì–¼êµ´ë§Œ 'ë¦­ ì•¤ ëª¨í‹°(Rick and Morty) ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼'ì˜ 2D ì¹´íˆ°ìœ¼ë¡œ í•©ì„±. (ì°¸ì¡°: í° í°ìƒ‰ ëˆˆ, ê²€ì€ ì  ëˆˆë™ì, êµµì€ ëˆˆì¹, ë‹¨ìˆœí•œ ì…).
- **í‘œì •:** ë‹¹í™©, ê³µí¬, í˜¼ë€, ìˆ ì— ì·¨í•œ ë“¯í•œ 'ë³‘ë§›' í‘œì • ê°•ì¡°.
ë™ë¬¼ ëˆˆ: í„¸ê³¼ ëª¸ì€ ë‹¤íë©˜í„°ë¦¬ê¸‰ ì‹¤ì‚¬ì§€ë§Œ, ëˆˆë§Œ 'í°ìƒ‰ í°ìì™€ ê²€ì€ ì  ëˆˆë™ì'ë¡œ ëœ 2D ë§Œí™” ëˆˆìœ¼ë¡œ ì—°ì¶œ.
ë¶„ìœ„ê¸°: ê³ í€„ë¦¬í‹° ë‹¤íë©˜í„°ë¦¬ì¸ ì²™í•˜ëŠ” ë³‘ë§› ì½”ë¯¸ë””. ì§„ì§€í•œ ìƒí™©ì¼ìˆ˜ë¡ í‘œì •ì„ ë” ë‹¨ìˆœí•˜ê³  ë©ì²­í•˜ê²Œ(Derp) ì—°ì¶œ.
ì ˆëŒ€ ì´ë¯¸ì§€ì— ê¸€ì”¨ ì—°ì¶œ ì „í˜€ í•˜ì§€ ì•ŠëŠ”ë‹¤."""

    PRESET_SKULL = """3D Render, Translucent Plastic Skeleton, Solid Pink Background.
[ìºë¦­í„° ì™¸í˜•]
- ì¬ì§ˆ: íˆ¬ëª…í•œ í”Œë¼ìŠ¤í‹±/ìœ ë¦¬(Translucent Clear Plastic). ì†ì´ íˆ¬ëª…í•˜ì§€ë§Œ **ë‚´ë¶€ ë¼ˆëŒ€ì˜ êµ¬ì¡°ì™€ ìœ¤ê³½**ì€ ëšœë ·í•˜ê²Œ ë³´ì—¬ì•¼ í•¨.
- **ëˆˆ(Eyes):** í…… ë¹ˆ ëˆˆêµ¬ë© ì ˆëŒ€ ê¸ˆì§€. **'ì„ ëª…í•˜ê³  í•˜ì–€ ëˆˆë™ì(Bright White Eyeballs)'**ê°€ ë°•í˜€ ìˆì–´ì•¼ í•¨. (ê²€ì€ìƒ‰ ì‘ì€ ë™ê³µ). ë©ì²­í•˜ê³  ìš°ìŠ¤ê½ìŠ¤ëŸ¬ìš´ í‘œì • í•„ìˆ˜.[ìì„¸ ë° ì—°ì¶œ]
- **ìì„¸(Pose):** ê¸°ë³¸ì ìœ¼ë¡œ **'ì†ŒíŒŒ(Sofa)'ë‚˜ 'ì±…ìƒ(Desk) ì˜ì'ì— ì•‰ì•„ìˆëŠ”(Sitting)'** ëª¨ìŠµ ìœ„ì£¼. (ìƒí™©ì— ë”°ë¼ ì„œ ìˆê±°ë‚˜ ì¶¤ì¶”ëŠ” ì—°ì¶œ ê°€ëŠ¥).
- ê±°ë§Œí•˜ê±°ë‚˜ í™(Hip)í•˜ê²Œ ê±¸í„°ì•‰ì€ ìì„¸.
[ì†Œí’ˆ ë° ë°°ê²½]
- ê°€êµ¬: ë²¨ë²³ ì†ŒíŒŒ, ê²Œì´ë° ì˜ì, ê³ ê¸‰ ì±…ìƒ ë“± ê°€êµ¬ì˜ ë””í…Œì¼í•œ ë¬˜ì‚¬.
- ì†Œí’ˆ: ëŒ€ë³¸ ì† ë¬¼ê±´(ëˆ, ìŒì‹, ê¸°ê³„)ì„ ì‚¬ì‹¤ì ìœ¼ë¡œ í‘œí˜„.
- ë°°ê²½: ë¬´ì¡°ê±´ **'ë‹¨ìƒ‰ í•‘í¬(Solid Pink)'** ìœ ì§€."""

    if 'style_prompt_area' not in st.session_state:
        st.session_state['style_prompt_area'] = PRESET_INFO
    
    OPT_INFO = "ë°ì€ ì •ë³´/ì´ìŠˆ (Bright & Flat)"
    OPT_REALISTIC = "ìŠ¤í‹±ë§¨ ë“œë¼ë§ˆ/ì‚¬ì‹¤ì  ì—°ì¶œ (Realistic Storytelling)" 
    OPT_HISTORY = "ì—­ì‚¬/ë‹¤í (Cinematic & Immersive)"
    OPT_3D = "3D ë‹¤íë©˜í„°ë¦¬ (Realistic 3D Game Style)"
    OPT_SCIFI = "ê³¼í•™/ì—”ì§€ë‹ˆì–´ë§ (3D Tech & Character)"
    OPT_PAINT = "ì‹¬í”Œ ê·¸ë¦¼íŒ/ì¡¸ë¼ë§¨ (The Paint Explainer Style)" 
    OPT_COMIC_REAL = "ì‹¤ì‚¬ + ì½”ë¯¹ í˜ì´ìŠ¤ (Hyper Realism + Comic Face)" 
    OPT_CUSTOM = "ì§ì ‘ ì…ë ¥ (Custom Style)"
    OPT_SKULL = "í•‘í¬ 3D í•´ê³¨ (Helix Style Pink Skeleton)"

    def update_text_from_radio():
        selection = st.session_state.genre_radio_key
        if selection == OPT_INFO:
            st.session_state['style_prompt_area'] = PRESET_INFO
        elif selection == OPT_REALISTIC: 
            st.session_state['style_prompt_area'] = PRESET_REALISTIC
        elif selection == OPT_HISTORY:
            st.session_state['style_prompt_area'] = PRESET_HISTORY
        elif selection == OPT_3D:
            st.session_state['style_prompt_area'] = PRESET_3D
        elif selection == OPT_SCIFI: 
            st.session_state['style_prompt_area'] = PRESET_SCIFI
        elif selection == OPT_PAINT: 
            st.session_state['style_prompt_area'] = PRESET_PAINT
        elif selection == OPT_COMIC_REAL: 
            st.session_state['style_prompt_area'] = PRESET_COMIC_REAL
        elif selection == OPT_SKULL: 
            st.session_state['style_prompt_area'] = PRESET_SKULL

    def set_radio_to_custom():
        st.session_state.genre_radio_key = OPT_CUSTOM

    genre_select = st.radio(
        "ì½˜í…ì¸  ì„±ê²© ì„ íƒ:",
        (OPT_INFO, OPT_REALISTIC, OPT_HISTORY, OPT_3D, OPT_SCIFI, OPT_PAINT, OPT_COMIC_REAL, OPT_SKULL, OPT_CUSTOM),
        index=0,
        key="genre_radio_key",
        on_change=update_text_from_radio,
        help="í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ë©´ ìë™ìœ¼ë¡œ 'ì§ì ‘ ì…ë ¥' ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤."
    )
    
    if genre_select == OPT_INFO:
        SELECTED_GENRE_MODE = "info"
    elif genre_select == OPT_REALISTIC:
        SELECTED_GENRE_MODE = "realistic_stickman"
    elif genre_select == OPT_HISTORY:
        SELECTED_GENRE_MODE = "history"
    elif genre_select == OPT_3D:
        SELECTED_GENRE_MODE = "3d_docu"
    elif genre_select == OPT_SCIFI: 
        SELECTED_GENRE_MODE = "scifi"
    elif genre_select == OPT_PAINT: 
        SELECTED_GENRE_MODE = "paint_explainer"
    elif genre_select == OPT_COMIC_REAL:
        SELECTED_GENRE_MODE = "comic_realism"
    elif genre_select == OPT_SKULL:
        SELECTED_GENRE_MODE = "pink_skull"
    else:
        current_text = st.session_state.get('style_prompt_area', "")
        if "3D" in current_text or "Unreal" in current_text or "Realistic" in current_text:
            SELECTED_GENRE_MODE = "3d_docu"
        else:
            SELECTED_GENRE_MODE = "info" 

    st.markdown("---")

    st.subheader("ğŸŒ ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì–¸ì–´")
    target_language = st.selectbox(
        "ì´ë¯¸ì§€ ì†ì— ë“¤ì–´ê°ˆ ê¸€ì ì–¸ì–´:",
        ("Korean", "English", "Japanese"),
        index=0,
        help="ì´ë¯¸ì§€ì— í…ìŠ¤íŠ¸ê°€ ì—°ì¶œë  ë•Œ ì–´ë–¤ ì–¸ì–´ë¡œ ì ì„ì§€ ì„ íƒí•©ë‹ˆë‹¤."
    )

    st.markdown("---")

    st.subheader("ğŸ–Œï¸ í™”í’(Style) ì§€ì¹¨")
    style_instruction = st.text_area(
        "AIì—ê²Œ ì§€ì‹œí•  ê·¸ë¦¼ ìŠ¤íƒ€ì¼ (ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)", 
        key="style_prompt_area", 
        height=200,
        on_change=set_radio_to_custom 
    )

    st.markdown("---")
    max_workers = st.slider("ì‘ì—… ì†ë„(ë³‘ë ¬ ìˆ˜)", 1, 10, 5)

# ==========================================
# [UI] ë©”ì¸ í™”ë©´: ì´ë¯¸ì§€ ìƒì„±
# ==========================================
st.title("ğŸ¬ AI ì”¬(ì¥ë©´) ìƒì„±ê¸° (Pro)")
st.caption(f"ëŒ€ë³¸ì„ ë„£ìœ¼ë©´ ì¥ë©´ë³„ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. | ğŸ¨ Model: {SELECTED_IMAGE_MODEL}")

st.subheader("ğŸ“Œ ì „ì²´ ì˜ìƒ í…Œë§ˆ(ì œëª©) ì„¤ì •")
st.caption("ì´ë¯¸ì§€ ìƒì„± ì‹œ ì´ ì œëª©ì´ 'ì „ì²´ì ì¸ ë¶„ìœ„ê¸° ê¸°ì¤€'ì´ ë©ë‹ˆë‹¤.")

if 'video_title' not in st.session_state:
    st.session_state['video_title'] = ""
if 'title_candidates' not in st.session_state:
    st.session_state['title_candidates'] = []

col_title_input, col_title_btn = st.columns([4, 1])

with col_title_btn:
    st.write("") 
    st.write("") 
    if st.button("ğŸ’¡ ì œëª© 5ê°œ ì¶”ì²œ", type="primary", help="ì…ë ¥í•œ í‚¤ì›Œë“œë‚˜ ëŒ€ë³¸ì„ ë°”íƒ•ìœ¼ë¡œ ì œëª©ì„ ì¶”ì²œí•©ë‹ˆë‹¤.", use_container_width=True):
        current_user_title = st.session_state.get('video_title', "").strip()
        
        if not api_key:
            st.error("API Key í•„ìš”")
        else:
            client = genai.Client(api_key=api_key)
            with st.spinner("AIê°€ ìµœì ì˜ ì œëª©ì„ ê³ ë¯¼ ì¤‘ì…ë‹ˆë‹¤..."):
                
                if current_user_title:
                    prompt_instruction = f"""
                    [Target Topic]
                    "{current_user_title}"
                    [Task]
                    Generate 5 click-bait YouTube video titles based on the Target Topic above.
                    ì‚¬ìš©ìê°€ ì…ë ¥í•œê±°ë‘ ìµœëŒ€í•œ ë¹„ìŠ·í•œ ì œëª©ìœ¼ë¡œ ì¶”ì²œ, 'ëª°ë½'ì´ ë“¤ì–´ê°„ ê²½ìš° ë§¨ ë’¤ì— ëª°ë½ìœ¼ë¡œ ëë‚˜ê²Œ í•œë‹¤.
                    """
                    context_data = "No script provided. Base it solely on the topic."

                else:
                    prompt_instruction = f"""
                    [Task]
                    Generate 5 catchy YouTube video titles in Korean based on general trending topics.
                    """
                    context_data = ""

                title_prompt = f"""
                [Role] You are a YouTube viral marketing expert.
                {prompt_instruction}
                
                [Script Context]
                {context_data}
                
                [Output Format]
                - Output ONLY the list of 5 titles.
                - No numbering (1., 2.), just 5 lines of text.
                - Language: Korean
                """
                
                try:
                    resp = client.models.generate_content(
                        model=GEMINI_TEXT_MODEL_NAME, 
                        contents=title_prompt
                    )
                    candidates = [line.strip() for line in resp.text.split('\n') if line.strip()]
                    clean_candidates = []
                    import re
                    for c in candidates:
                        clean = re.sub(r'^\d+\.\s*', '', c).replace('*', '').replace('"', '').strip()
                        if clean: clean_candidates.append(clean)
                    
                    st.session_state['title_candidates'] = clean_candidates[:5]
                except Exception as e:
                    st.error(f"ì˜¤ë¥˜ ë°œìƒ: {e}")

with col_title_input:
    st.text_input(
        "ì˜ìƒ ì œëª© (ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ìš°ì¸¡ ë²„íŠ¼ìœ¼ë¡œ ì¶”ì²œë°›ìœ¼ì„¸ìš”)",
        key="video_title", 
        placeholder="ì œëª© í˜¹ì€ ë§Œë“¤ê³  ì‹¶ì€ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë¶€ìë“¤ì˜ ìŠµê´€)"
    )

if st.session_state['title_candidates']:
    st.info("ğŸ‘‡ AIê°€ ì¶”ì²œí•œ ì œëª©ì…ë‹ˆë‹¤. í´ë¦­í•˜ë©´ ì ìš©ë©ë‹ˆë‹¤.")

    def apply_title(new_title):
        st.session_state['video_title'] = new_title
        st.session_state['title_candidates'] = [] 

    for idx, title in enumerate(st.session_state['title_candidates']):
        col_c1, col_c2 = st.columns([4, 1])
        with col_c1:
            st.markdown(f"**{idx+1}. {title}**")
        with col_c2:
            st.button(
                "âœ… ì„ íƒ", 
                key=f"sel_title_{idx}", 
                on_click=apply_title, 
                args=(title,), 
                use_container_width=True
            )
    
    if st.button("âŒ ëª©ë¡ ë‹«ê¸°"):
        st.session_state['title_candidates'] = []

script_input = st.text_area(
    "ğŸ“œ ì´ë¯¸ì§€ë¡œ ë§Œë“¤ ëŒ€ë³¸ ì…ë ¥", 
    height=300, 
    placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ì§ì ‘ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...",
    key="image_gen_input"
)

if 'generated_results' not in st.session_state:
    st.session_state['generated_results'] = []
if 'is_processing' not in st.session_state:
    st.session_state['is_processing'] = False

def clear_generated_results():
    st.session_state['generated_results'] = []

start_btn = st.button("ğŸš€ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘", type="primary", width="stretch", on_click=clear_generated_results)

if start_btn:
    if not api_key:
        st.error("âš ï¸ Google API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    elif not script_input:
        st.warning("âš ï¸ ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        st.session_state['generated_results'] = [] 
        st.session_state['is_processing'] = True
        
        if os.path.exists(IMAGE_OUTPUT_DIR):
            try:
                shutil.rmtree(IMAGE_OUTPUT_DIR)
            except:
                pass
        init_folders() 
        
        client = genai.Client(api_key=api_key)
        
        status_box = st.status("ì‘ì—… ì§„í–‰ ì¤‘...", expanded=True)
        progress_bar = st.progress(0)
        
        status_box.write(f"âœ‚ï¸ ëŒ€ë³¸ ë¶„í•  ì¤‘...")
        chunks = split_script_by_time(script_input, chars_per_chunk=chars_limit)
        total_scenes = len(chunks)
        status_box.write(f"âœ… {total_scenes}ê°œ ì¥ë©´ìœ¼ë¡œ ë¶„í•  ì™„ë£Œ.")
        
        current_video_title = st.session_state.get('video_title', "").strip()
        if not current_video_title:
            current_video_title = "ì „ë°˜ì ì¸ ëŒ€ë³¸ ë¶„ìœ„ê¸°ì— ì–´ìš¸ë¦¬ëŠ” ë°°ê²½ (Context based on the script)"

        status_box.write(f"ğŸ“ í”„ë¡¬í”„íŠ¸ ì‘ì„± ì¤‘ ({GEMINI_TEXT_MODEL_NAME}) - ëª¨ë“œ: {SELECTED_GENRE_MODE} / ë¹„ìœ¨: {TARGET_RATIO}...") 
        prompts = []
        with ThreadPoolExecutor(max_workers=10) as executor:
            futures = []
            
            for i, chunk in enumerate(chunks):
                futures.append(executor.submit(
                    generate_prompt, 
                    api_key, 
                    i, 
                    chunk, 
                    style_instruction, 
                    current_video_title, 
                    SELECTED_GENRE_MODE,
                    target_language,
                    LAYOUT_KOREAN      
                ))
            
            for i, future in enumerate(as_completed(futures)):
                prompts.append(future.result())
                progress_bar.progress((i + 1) / (total_scenes * 2))
        
        prompts.sort(key=lambda x: x[0])
        
        status_box.write(f"ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘ ({SELECTED_IMAGE_MODEL})... (API ë³´í˜¸ë¥¼ ìœ„í•´ ì²œì²œíˆ ì§„í–‰ë©ë‹ˆë‹¤)")
        results = []
        
        with ThreadPoolExecutor(max_workers=max_workers) as executor:
            future_to_meta = {}
            for s_num, prompt_text in prompts:
                idx = s_num - 1
                orig_text = chunks[idx]
                fname = make_filename(s_num, orig_text)
                
                time.sleep(0.1) 
                
                future = executor.submit(
                    generate_image, 
                    client, 
                    prompt_text, 
                    fname, 
                    IMAGE_OUTPUT_DIR, 
                    SELECTED_IMAGE_MODEL,
                    TARGET_RATIO 
                )
                future_to_meta[future] = (s_num, fname, orig_text, prompt_text)
            
            completed_cnt = 0
            for future in as_completed(future_to_meta):
                s_num, fname, orig_text, p_text = future_to_meta[future]
                
                result = future.result() 
                
                if result and "ERROR_DETAILS" not in result:
                    path = result 
                    results.append({
                        "scene": s_num,
                        "path": path,
                        "filename": fname,
                        "script": orig_text,
                        "prompt": p_text
                    })
                else:
                    error_reason = result.replace("ERROR_DETAILS:", "") if result else "ì›ì¸ ë¶ˆëª… (None ë°˜í™˜)"
                    st.error(f"ğŸš¨ Scene {s_num} ì‹¤íŒ¨!\nì´ìœ : {error_reason}")
                    st.caption(f"ë¬¸ì œì˜ íŒŒì¼ëª…: {fname}")

                completed_cnt += 1
                progress_bar.progress(0.5 + (completed_cnt / total_scenes * 0.5))
        
        results.sort(key=lambda x: x['scene'])
        st.session_state['generated_results'] = results
        
        status_box.update(label="âœ… ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", state="complete", expanded=False)
        st.session_state['is_processing'] = False
        
# ==========================================
# [ìˆ˜ì •ëœ UI] ê²°ê³¼ì°½ ë° ê°œë³„ ì¬ìƒì„± ê¸°ëŠ¥
# ==========================================
if st.session_state['generated_results']:
    st.divider()
    st.header(f"ğŸ“¸ ê²°ê³¼ë¬¼ ({len(st.session_state['generated_results'])}ì¥)")
    
    # ------------------------------------------------
    # 1. ì¼ê´„ ì‘ì—… ë²„íŠ¼ ì˜ì—­ (ìˆ˜ì •ë¨: ê½‰ ì°¨ê²Œ)
    # ------------------------------------------------
    st.write("---")
    st.subheader("âš¡ ì›í´ë¦­ ì¼ê´„ ë‹¤ìš´ë¡œë“œ")
    
    zip_data = create_zip_buffer(IMAGE_OUTPUT_DIR)
    # [ìˆ˜ì •] ì „ì²´ ë„ˆë¹„ë¥¼ ì‚¬ìš©í•˜ì—¬ ë²„íŠ¼ì„ ê¸¸ê²Œ ë°°ì¹˜
    st.download_button(
        label="ğŸ“¦ ì „ì²´ ì´ë¯¸ì§€ ZIP ë‹¤ìš´ë¡œë“œ (Click to Download All)", 
        data=zip_data, 
        file_name="all_images.zip", 
        mime="application/zip", 
        use_container_width=True # ì „ì²´ ë„ˆë¹„ ì‚¬ìš©
    )

    # ------------------------------------------------
    # 2. ê°œë³„ ë¦¬ìŠ¤íŠ¸ ë° [ì¬ìƒì„±] ê¸°ëŠ¥ (ìˆ˜ì •ë¨: í”„ë¡¬í”„íŠ¸ í¸ì§‘ ë°˜ì˜)
    # ------------------------------------------------
    for index, item in enumerate(st.session_state['generated_results']):
        with st.container(border=True):
            cols = st.columns([1, 2])
            
            # [ì™¼ìª½] ì´ë¯¸ì§€ ë° ì¬ìƒì„± ë²„íŠ¼
            with cols[0]:
                try: 
                    if TARGET_RATIO == "16:9":
                        st.image(item['path'], use_container_width=True)
                    else:
                        sub_c1, sub_c2, sub_c3 = st.columns([1, 2, 1]) 
                        with sub_c2:
                            st.image(item['path'], use_container_width=True)
                except: 
                    st.error("ì´ë¯¸ì§€ ì—†ìŒ")
                
                # [NEW] ì´ë¯¸ì§€ ê°œë³„ ì¬ìƒì„± ë²„íŠ¼
                if st.button(f"ğŸ”„ ì´ ì¥ë©´ë§Œ ì´ë¯¸ì§€ ë‹¤ì‹œ ìƒì„±", key=f"regen_img_{index}", use_container_width=True):
                    if not api_key:
                        st.error("API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.")
                    else:
                        with st.spinner(f"Scene {item['scene']} ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ì¤‘..."):
                            client = genai.Client(api_key=api_key)
                            
                            # [í•µì‹¬ ìˆ˜ì •] 1. í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ ë‚´ìš©ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©)
                            # í…ìŠ¤íŠ¸ ì—ì–´ë¦¬ì–´ì˜ í‚¤ë¥¼ í†µí•´ í˜„ì¬ ìƒíƒœ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                            current_prompt_key = f"prompt_edit_{index}"
                            if current_prompt_key in st.session_state:
                                final_prompt = st.session_state[current_prompt_key]
                            else:
                                final_prompt = item['prompt']

                            # [í•µì‹¬ ìˆ˜ì •] 2. generate_prompt(AIìƒì„±) ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³  ë°”ë¡œ ì´ë¯¸ì§€ ìƒì„±
                            # ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•¨
                            
                            new_path = generate_image(
                                client, final_prompt, item['filename'], 
                                IMAGE_OUTPUT_DIR, SELECTED_IMAGE_MODEL,
                                TARGET_RATIO 
                            )
                            
                            if new_path and "ERROR_DETAILS" not in new_path:
                                # 3. ê²°ê³¼ ì—…ë°ì´íŠ¸
                                st.session_state['generated_results'][index]['path'] = new_path
                                st.session_state['generated_results'][index]['prompt'] = final_prompt # í”„ë¡¬í”„íŠ¸ë„ ìµœì‹  ìƒíƒœ ìœ ì§€
                                st.success("ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!")
                                time.sleep(0.5)
                                st.rerun()
                            else:
                                err_msg = new_path.replace("ERROR_DETAILS:", "") if new_path else "Unknown Error"
                                st.error(f"ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: {err_msg}")

            # [ì˜¤ë¥¸ìª½] ì •ë³´ ë° í”„ë¡¬í”„íŠ¸ ìˆ˜ì •
            with cols[1]:
                st.subheader(f"Scene {item['scene']:02d}")
                st.caption(f"íŒŒì¼ëª…: {item['filename']}")
                
                st.write(f"**ëŒ€ë³¸:** {item['script']}")
                
                st.markdown("---")

                # [ìˆ˜ì •ë¨] í”„ë¡¬í”„íŠ¸ í™•ì¸ ë° ìˆ˜ì • ì˜ì—­
                with st.expander("í”„ë¡¬í”„íŠ¸ í™•ì¸ ë° ìˆ˜ì • (ì—¬ê¸°ì„œ ìˆ˜ì • í›„ ì¬ìƒì„± ê°€ëŠ¥)", expanded=False):
                    # st.text_areaë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
                    # keyë¥¼ ë¶€ì—¬í•˜ì—¬ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
                    prompt_key = f"prompt_edit_{index}"
                    
                    # ì´ˆê¸°ê°’ ì„¤ì • (ì„¸ì…˜ ìŠ¤í…Œì´íŠ¸ì— ì•„ì§ ì—†ë‹¤ë©´)
                    if prompt_key not in st.session_state:
                        st.session_state[prompt_key] = item['prompt']
                        
                    edited_prompt = st.text_area(
                        label="í”„ë¡¬í”„íŠ¸ (ìˆ˜ì • í›„ ì™¼ìª½ 'ë‹¤ì‹œ ìƒì„±' ë²„íŠ¼ í´ë¦­)",
                        value=st.session_state[prompt_key],
                        key=prompt_key,
                        height=300
                    )
                    
                    # í…ìŠ¤íŠ¸ ì˜ì—­ì´ ìˆ˜ì •ë  ë•Œë§ˆë‹¤ ë©”ì¸ ë°ì´í„°ì—ë„ ë™ê¸°í™” (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¶Œì¥)
                    st.session_state['generated_results'][index]['prompt'] = edited_prompt

                try:
                    with open(item['path'], "rb") as file:
                        st.download_button("â¬‡ï¸ ì´ë¯¸ì§€ ì €ì¥", data=file, file_name=item['filename'], mime="image/png", key=f"btn_down_{item['scene']}")
                except: pass

