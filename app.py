import streamlit as st
import random
import time
import os
import re
import shutil
import zipfile
import gc
import uuid
from io import BytesIO
from concurrent.futures import ThreadPoolExecutor, as_completed
from PIL import Image
from google import genai
from google.genai import types

# ==========================================
# [ì„¤ì •] í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
# ==========================================
st.set_page_config(
    page_title="ì—´ì •í”¼ë”” AI ì´ë¯¸ì§€ ìƒì„±ê¸° VER.2 (Final)",
    layout="wide",
    page_icon="ğŸ¨",
    initial_sidebar_state="expanded"
)

# ì‚¬ìš©ìë³„ ê³ ìœ  ì„¸ì…˜ ID ìƒì„±
if 'user_id' not in st.session_state:
    st.session_state['user_id'] = str(uuid.uuid4())

# ==========================================
# [ë””ìì¸] ë‹¤í¬ëª¨ë“œ & ê°€ë…ì„± ì™„ë²½ íŒ¨ì¹˜
# ==========================================
st.markdown("""
    <style>
    /* 1. ìƒë‹¨ í—¤ë” */
    header[data-testid="stHeader"] {
        background-color: #0E1117 !important;
        z-index: 1 !important;
    }

    /* 2. ì½˜í…ì¸  ì˜ì—­ ì—¬ë°± */
    .block-container {
        padding-top: 6rem !important; 
        padding-bottom: 5rem !important;
    }

    /* 3. ì „ì²´ ë°°ê²½ ë° í°íŠ¸ */
    .stApp {
        background-color: #0E1117;
        color: #FFFFFF !important;
        font-family: 'Pretendard', sans-serif;
    }

    /* í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°•í™” */
    p, div, label, span, li, h1, h2, h3, h4, h5, h6 {
        color: #FFFFFF !important;
    }
     
    h1, h2 {
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    /* 4. ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
    .student-banner {
        background: linear-gradient(90deg, #00C6FF 0%, #0072FF 100%);
        color: white !important;
        padding: 30px 20px;
        border-radius: 15px;
        text-align: center;
        font-size: 2.0rem;
        font-weight: 800;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        letter-spacing: 1px;
    }

    /* 5. ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .stTextInput label p, .stTextArea label p, .stSelectbox label p, .stRadio label p {
        font-size: 1.2rem !important;
        font-weight: 700 !important;
        color: #FFD700 !important;
        margin-bottom: 8px !important;
    }

    .stTextInput input, .stTextArea textarea {
        background-color: #1F2128 !important;
        color: #FFFFFF !important;
        border: 1px solid #4A4A4A !important;
        border-radius: 10px !important;
        font-size: 1.1rem !important;
    }
    .stTextInput input:focus, .stTextArea textarea:focus {
        border-color: #0072FF !important;
        box-shadow: 0 0 8px rgba(0, 114, 255, 0.5);
    }

    /* 6. Selectbox ìŠ¤íƒ€ì¼ */
    div[data-testid="stSelectbox"] > div > div {
        background-color: #1F2128 !important;
        color: #FFFFFF !important;
        border: 1px solid #4A4A4A !important;
    }
    div[data-testid="stSelectbox"] * {
        color: #FFFFFF !important;
    }
    div[data-testid="stSelectbox"] svg {
        fill: #FFFFFF !important;
    }
    div[data-baseweb="popover"], div[data-baseweb="menu"], ul[data-testid="stSelectboxVirtualDropdown"] {
        background-color: #1F2128 !important;
    }
    li[role="option"] {
        color: #FFFFFF !important;
        background-color: #1F2128 !important;
    }
    li[role="option"]:hover, li[aria-selected="true"] {
        background-color: #333 !important;
        color: #00BFFF !important; 
    }

    /* 7. ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .stButton > button {
        width: 100%;
        background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
        color: white !important;
        border: none;
        padding: 15px 20px;
        font-size: 1.2rem !important;
        font-weight: bold;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    .stButton > button:hover {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
    }

    [data-testid="stDownloadButton"] button {
        background-color: #2C2F38 !important;
        border: 1px solid #555 !important;
        color: white !important;
    }
    [data-testid="stDownloadButton"] button:hover {
        border-color: #00BFFF !important;
        color: #00BFFF !important;
    }

    /* 8. Expander ìŠ¤íƒ€ì¼ */
    div[data-testid="stExpander"] details {
        background-color: #1F2128 !important;
        border: 1px solid #4A4A4A !important;
        border-radius: 8px !important;
        color: #FFFFFF !important;
    }
    div[data-testid="stExpander"] details > summary {
        background-color: #1F2128 !important;
        color: #FFFFFF !important;
    }
    div[data-testid="stExpander"] details > summary:hover {
        background-color: #2C2F38 !important;
        color: #FFD700 !important;
    }
    div[data-testid="stExpander"] details > summary span {
        color: inherit !important;
    }
    div[data-testid="stExpander"] details > summary svg {
        fill: #FFFFFF !important;
    }
    div[data-testid="stExpander"] details > summary:hover svg {
        fill: #FFD700 !important;
    }
    div[data-testid="stExpander"] details > div {
        background-color: #1F2128 !important;
        color: #FFFFFF !important;
    }
     
    /* 9. Status Widget ìŠ¤íƒ€ì¼ */
    div[data-testid="stStatusWidget"] {
        background-color: #1F2128 !important;
        border: 1px solid #4A4A4A !important;
        color: #FFFFFF !important;
    }
    div[data-testid="stStatusWidget"] p, 
    div[data-testid="stStatusWidget"] span, 
    div[data-testid="stStatusWidget"] div, 
    div[data-testid="stStatusWidget"] label {
        color: #FFFFFF !important;
    }
    div[data-testid="stStatusWidget"] svg {
        fill: #FFFFFF !important;
        color: #FFFFFF !important;
    }

    /* [ê¸´ê¸‰ íŒ¨ì¹˜] ë¡œê·¸ ë°•ìŠ¤(Code Block) ê°€ë…ì„± í•´ê²° */
    div[data-testid="stStatusWidget"] pre {
        background-color: #000000 !important; /* ë°°ê²½ì„ ì™„ì „ ê²€ì€ìƒ‰ìœ¼ë¡œ ê°•ì œ */
        border: 1px solid #333 !important;
        border-radius: 8px !important;
        color: #00FF00 !important; /* í…ìŠ¤íŠ¸ë¥¼ í„°ë¯¸ë„ ë…¹ìƒ‰ìœ¼ë¡œ ê°•ì œ */
    }
    div[data-testid="stStatusWidget"] code {
        background-color: transparent !important;
        color: #00FF00 !important; /* ì½”ë“œ í…ìŠ¤íŠ¸ë„ ë…¹ìƒ‰ */
        font-family: 'Courier New', monospace !important;
    }
    /* Bash í•˜ì´ë¼ì´íŒ…ìœ¼ë¡œ ì¸í•œ ìƒ‰ìƒ ë®ì–´ì“°ê¸° ë°©ì§€ */
    div[data-testid="stStatusWidget"] span {
        color: #00FF00 !important;
    }

    /* ì‚¬ì´ë“œë°” */
    [data-testid="stSidebar"] {
        background-color: #12141C;
        border-right: 1px solid #2C2F38;
    }
    
    /* [NEW] ë¡œê·¸ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .log-text {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #00FF00 !important;
    }
    </style>

    <div class="student-banner">
        ğŸ¨ ì—´ì •í”¼ë”” AI ì´ë¯¸ì§€ ìƒì„±ê¸° (Final)
    </div>
""", unsafe_allow_html=True)

# íŒŒì¼ ì €ì¥ ê²½ë¡œ
BASE_PATH = "./web_result_files"

# ==========================================
# [í•¨ìˆ˜] 1. ìœ í‹¸ë¦¬í‹°
# ==========================================
def split_script_by_time(script, chars_per_chunk=100):
    # [ìˆ˜ì •ë¨] ì¼ë³¸ì–´ êµ¬ë‘ì (ã€‚, ï¼Ÿ, ï¼)ë„ ì¸ì‹í•˜ë„ë¡ ë³€ê²½
    temp_sentences = script.replace(".", ".|").replace("?", "?|").replace("!", "!|") \
                            .replace("ã€‚", "ã€‚|").replace("ï¼Ÿ", "ï¼Ÿ|").replace("ï¼", "ï¼|").split("|")
                            
    chunks = []
    current_chunk = ""
    MIN_LENGTH = 30 

    for sentence in temp_sentences:
        sentence = sentence.strip()
        if not sentence: continue
        
        if current_chunk:
            temp_combined = current_chunk + " " + sentence
        else:
            temp_combined = sentence

        if len(temp_combined) < chars_per_chunk:
            current_chunk = temp_combined
        else:
            if len(current_chunk) < MIN_LENGTH:
                current_chunk = temp_combined
            else:
                chunks.append(current_chunk.strip())
                current_chunk = sentence
    
    if current_chunk.strip():
        if len(current_chunk) < MIN_LENGTH and chunks:
            chunks[-1] += " " + current_chunk.strip()
        else:
            chunks.append(current_chunk.strip())
            
    return chunks

def make_filename(scene_num, text_chunk):
    clean_line = text_chunk.replace("\n", " ").strip()
    clean_line = re.sub(r'[\\/:*?"<>|]', "", clean_line)
    
    if len(clean_line) <= 20:
        summary = clean_line
    else:
        summary = f"{clean_line[:9]}...{clean_line[-9:]}"
        
    return f"S{scene_num:03d}_{summary}.png"

def create_zip_buffer(source_dir):
    buffer = BytesIO()
    with zipfile.ZipFile(buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        for root, dirs, files in os.walk(source_dir):
            for file in files:
                file_path = os.path.join(root, file)
                zip_file.write(file_path, os.path.basename(file_path))
    buffer.seek(0)
    return buffer

# ==========================================
# [í•¨ìˆ˜] 2. í”„ë¡¬í”„íŠ¸ ìƒì„± (ìˆ˜ì •: gemini-2.5-pro ì ìš©)
# ==========================================
def generate_prompt(api_key, index, text_chunk, style_instruction, video_title, genre_mode="info", target_language="Korean"):
    scene_num = index + 1
    client = genai.Client(api_key=api_key)

    # 1. ì–¸ì–´ ì„¤ì •
    if target_language == "Korean":
        lang_guide = "í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ 'í•œê¸€'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤. (ë‹¤ë¥¸ ì–¸ì–´ ì ˆëŒ€ ê¸ˆì§€)"
        lang_example = "(ì˜ˆ: 'New York' -> 'ë‰´ìš•', 'Tokyo' -> 'ë„ì¿„')"
    elif target_language == "English":
        lang_guide = "í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ 'ì˜ì–´'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤."
        lang_example = "(ì˜ˆ: 'ì„œìš¸' -> 'Seoul', 'ë…ë„' -> 'Dokdo')"
    elif target_language == "Japanese":
        lang_guide = "í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ 'ì¼ë³¸ì–´'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤."
        lang_example = "(ì˜ˆ: 'ì„œìš¸' -> 'ã‚½ã‚¦ãƒ«', 'New York' -> 'ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯')"
    else:
        lang_guide = f"í™”ë©´ ì† ê¸€ì”¨ëŠ” **ë¬´ì¡°ê±´ '{target_language}'ë¡œ í‘œê¸°**í•˜ì‹­ì‹œì˜¤."
        lang_example = ""

    # 2. ì¥ë¥´ë³„ í”„ë¡¬í”„íŠ¸ ë¶„ê¸°
    if genre_mode == "history":
        full_instruction = f"""
    [ì—­í• ]
    ë‹¹ì‹ ì€ **ì„¸ê³„ì‚¬ì˜ ê²°ì •ì ì¸ ìˆœê°„ë“¤(í•œêµ­ì‚¬, ì„œì–‘ì‚¬, ë™ì–‘ì‚¬ ë“±)**ì„ í•œêµ­ ì‹œì²­ìì—ê²Œ ì „ë‹¬í•˜ëŠ” 'ì‹œëŒ€ê·¹ ì• ë‹ˆë©”ì´ì…˜ ê°ë…'ì…ë‹ˆë‹¤.
    ì—­ì‚¬ì  ë¹„ê·¹ì„ ë‹¤ë£¨ì§€ë§Œ, ì ˆëŒ€ë¡œ ì”ì¸í•˜ê±°ë‚˜ í˜ì˜¤ìŠ¤ëŸ¬ìš´ ë¬˜ì‚¬ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ê·¸ë¦¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ìœ ì € ì§€ì • (ìµœìš°ì„  ì¤€ìˆ˜)] {style_instruction}
    
    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **[ë§¤ìš° ì¤‘ìš”] ë§¤ì²´(Medium):** ë¬´ì¡°ê±´ **í‰ë©´ì ì¸ '2D ìŠ¤í‹±ë§¨ ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´ì…˜'** ìŠ¤íƒ€ì¼ë¡œ í‘œí˜„í•˜ì‹­ì‹œì˜¤. (3D, ì‹¤ì‚¬, ëª¨ë¸ë§ ëŠë‚Œ ì ˆëŒ€ ê¸ˆì§€)
    2. **[ë§¤ìš° ì¤‘ìš”] í…ìŠ¤íŠ¸ í˜„ì§€í™”(Localization):** ë°°ê²½ì´ ì„œì–‘, ì¤‘êµ­, ì¼ë³¸ ë“± ì–´ë””ë“  ìƒê´€ì—†ì´, {lang_guide}
        - **ê¸ˆì§€:** ì§€ì •ëœ ì–¸ì–´ ì™¸ì˜ ë¬¸ì ì‚¬ìš©ì„ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤.
        - **ì˜ˆì‹œ:** {lang_example}
    3. **[ë§¤ìš° ì¤‘ìš” - ìˆœí™”ëœ í‘œí˜„] ë¹„ê·¹ì˜ ìƒì§•í™”(Symbolization of Tragedy):** ì „ìŸ, ì£½ìŒ, ê³ í†µê³¼ ê°™ì€ ë¹„ê·¹ì ì¸ ìƒí™©ì€ **ì ˆëŒ€ë¡œ ì§ì ‘ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** ë¬¼ë¦¬ì  í­ë ¥ ëŒ€ì‹ , **ìƒì‹¤ê°, í—ˆë¬´í•¨, ì• ë„**ì˜ ì •ì„œì— ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤.
        - **í•µì‹¬:** íŒŒê´´ëœ ì‹ ì²´ë‚˜ ì§ì ‘ì ì¸ ë¬´ê¸° ì‚¬ìš© ì¥ë©´ ëŒ€ì‹ , **ë‚¨ê²¨ì§„ ë¬¼ê±´(ì£¼ì¸ ì—†ëŠ” ì‹ ë°œ, ê¹¨ì§„ ì•ˆê²½), ë“œë¦¬ìš°ëŠ” ê·¸ë¦¼ì, ì‹œë“¤ì–´ë²„ë¦° ìì—°ë¬¼, í˜¹ì€ ë¹›ì´ ì‚¬ë¼ì§€ëŠ” ì—°ì¶œ** ë“±ì„ í†µí•´ ê°„ì ‘ì ìœ¼ë¡œ ìŠ¬í””ì„ í‘œí˜„í•˜ì‹­ì‹œì˜¤.
    4. **[í•µì‹¬] ë‹¤ì–‘í•œ ì¥ì†Œì™€ ì‹œëŒ€ ì—°ì¶œ(Diverse Locations):** ëŒ€ë³¸ì— ë‚˜ì˜¤ëŠ” **íŠ¹ì • ì‹œëŒ€ì™€ ì¥ì†Œì˜ íŠ¹ì§•(ê±´ì¶• ì–‘ì‹, ì˜ìƒ, ìì—°í™˜ê²½)ì„ ì •í™•íˆ í¬ì°©**í•˜ì—¬ ê·¸ë¦¬ì‹­ì‹œì˜¤.
    5. **[ìˆ˜ì •ë¨] ì ˆì œëœ ìºë¦­í„° ì—°ê¸°(Restrained Acting):** 2D ìŠ¤í‹±ë§¨ ìºë¦­í„°ëŠ” ì‹œëŒ€ì— ë§ëŠ” ì˜ìƒì„ ì…ë˜, **ê³¼ì¥ëœ í‘œì •ë³´ë‹¤ëŠ” 'ëª¸ì§“(Body Language)'ê³¼ 'ë¶„ìœ„ê¸°'ë¡œ ê°ì •ì„ í‘œí˜„**í•´ì•¼ í•©ë‹ˆë‹¤. ë¹„ê·¹ì ì¸ ìƒí™©ì—ì„œë„ ê²©ë ¬í•œ ë¶„ë…¸ë‚˜ ê³µí¬ë³´ë‹¤ëŠ” **ê¹Šì€ ìŠ¬í””, ì²´ë…, í˜¹ì€ ê°„ì ˆí•œ ê¸°ë„**ì™€ ê°™ì€ ì •ì ì¸ ê°ì •ì„ ìš°ì„ ì‹œí•˜ì‹­ì‹œì˜¤.
    6. **ì¡°ëª…(Lighting):** 2D ì‘í™” ë‚´ì—ì„œ ê·¹ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“œëŠ” **'ì‹œë„¤ë§ˆí‹± ì¡°ëª…'**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. (ì‹œëŒ€ê·¹ íŠ¹ìœ ì˜ í†¤)
    7. **[ìˆ˜ì •ë¨] ìƒ‰ê°(Colors):** **ì°¨ë¶„í•˜ê³  ì• ìƒì ì¸ ìƒ‰ê°(Somber & Melancholic Tones)**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. ê¹Šì´ ìˆë˜ ë‹¤ì–‘í•œ ì±„ë„ì˜ ìƒ‰ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬, ì—­ì‚¬ ë‹¤íë©˜í„°ë¦¬ì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ ìœ ì§€í•˜ì‹­ì‹œì˜¤. (ìê·¹ì ì¸ ë¶‰ì€ìƒ‰ ê³¼ë‹¤ ì‚¬ìš© ê¸ˆì§€)
    8. **êµ¬ì„±(Composition):** ì‹œì²­ìê°€ ìƒí™©ì„ í•œëˆˆì— ì´í•´í•  ìˆ˜ ìˆë„ë¡ í•µì‹¬ í”¼ì‚¬ì²´ë¥¼ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜í•˜ì‹­ì‹œì˜¤. ë¶„í™œí™”ë©´(Split screen)ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.
    - **[ì ˆëŒ€ ê¸ˆì§€]:** í…ìŠ¤íŠ¸ê°€ í™”ë©´ì˜ ë„¤ ëª¨ì„œë¦¬(Corners)ë‚˜ ê°€ì¥ìë¦¬ì— ë°°ì¹˜ë˜ëŠ” ê²ƒì„ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤. (ìë§‰ ê³µê°„ í™•ë³´)
    9. **[ë§¤ìš° ì¤‘ìš”] ë°°ê²½ë³´ë‹¤ **'ì¸ë¬¼(Character)'ì´ ë¬´ì¡°ê±´ ìš°ì„ **ì…ë‹ˆë‹¤. ìºë¦­í„°ê°€ í™”ë©´ì„ ì¥ì•…í•´ì•¼ í•©ë‹ˆë‹¤.
    10. ìƒí˜¸ì‘ìš©í•˜ëŠ” ì†Œí’ˆ (Interactive Props): ìŠ¤í‹±ë§¨ ìºë¦­í„°ê°€ ëŒ€ë³¸ ì† ì¤‘ìš”í•œ ì‚¬ë¬¼ê³¼ ì–´ë–»ê²Œ ìƒí˜¸ì‘ìš©í•˜ëŠ”ì§€ ëª…í™•íˆ ê·¸ë¦¬ì‹­ì‹œì˜¤. ì‚¬ë¬¼ì€ ë‹¨ìˆœí•˜ì§€ë§Œ ê·¸ íŠ¹ì§•ì´ ëª…í™•í•´ì•¼ í•©ë‹ˆë‹¤.
    11. ìºë¦­í„° ì—°ì¶œ : ìŠ¤í‹±ë§¨ì€ ì‹œëŒ€ë¥¼ ë°˜ì˜í•˜ëŠ” ì˜ìƒê³¼ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì—°ì¶œí•œë‹¤.

    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ë°”íƒ•ìœ¼ë¡œ, ì´ë¯¸ì§€ ìƒì„± AIê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì¸ ë¬˜ì‚¬ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± ìš”êµ¬ì‚¬í•­]
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - **í¬í•¨ ìš”ì†Œ:**
        - **í…ìŠ¤íŠ¸ ì§€ì‹œ:** (ì¤‘ìš”) ì´ë¯¸ì§€ì— ë“¤ì–´ê°ˆ í…ìŠ¤íŠ¸ë¥¼ ë°˜ë“œì‹œ **'{target_language}'**ë¡œ ëª…ì‹œí•˜ì‹­ì‹œì˜¤.
        - **ì•ˆì „í•œ ë¬˜ì‚¬:** ì”ì¸í•œ ì¥ë©´ì€ ì€ìœ ì ìœ¼ë¡œ í‘œí˜„í•˜ì—¬ í•„í„°ë§ì„ í”¼í•˜ì‹­ì‹œì˜¤.
        - **ì‹œëŒ€ì  ë°°ê²½:** ëŒ€ë³¸ì˜ ì‹œëŒ€(ê³ ëŒ€/ì¤‘ì„¸/ê·¼ëŒ€)ì™€ ì¥ì†Œ(ë™ì–‘/ì„œì–‘)ë¥¼ ëª…í™•íˆ ë°˜ì˜í•œ ë°°ê²½ ë¬˜ì‚¬.
        - **ìºë¦­í„° ì—°ê¸°:** ìƒí™©ì— ë”°ë¥¸ ìºë¦­í„°ì˜ ê°ì • í‘œì •ê³¼ ë™ì‘(ì–¼êµ´ì˜ ëˆˆ,ì… í•„ìˆ˜ ì—°ì¶œ)
            - ë‹¨ìˆœí•œ ìŠ¤í‹±ë§¨ì´ë¼ë„ ìƒí™©ì— ë”°ë¥¸ ê°ì • í‘œí˜„ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
            - **ì–¼êµ´ ë””í…Œì¼:** **'ëˆˆ'ê³¼ 'ì…'ì˜ ëª¨ì–‘ì„ ë°˜ë“œì‹œ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬**í•˜ì‹­ì‹œì˜¤. (ì˜ˆ: ê³µí¬ì— ì§ˆë ¤ ëœëœ ë–¨ë¦¬ëŠ” ì…, ë¶„ë…¸ë¡œ ì´ê°€ ê°ˆë¦¬ë„ë¡ ê½‰ ë‹¤ë¬¸ ì…, í­í¬ìˆ˜ì²˜ëŸ¼ ìŸì•„ì§€ëŠ” ëˆˆë¬¼ ë“±)
            - **ì—­ë™ì  ëª¸ì§“:** ì •ì ì¸ ìì„¸ ëŒ€ì‹  ê°ì •ì„ ì˜¨ëª¸ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ë™ì‘ì„ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤. 
        - ë°°ê²½ ë³´ë‹¤ëŠ” ì¸ë¬¼ê³¼ ìƒí™©ì— ë” ì´ˆì ì„ ë§ì¶˜ë‹¤.
        - ìë§‰ ê°™ì€ ì—°ì¶œ í•˜ì§€ ì•ŠëŠ”ë‹¤. ("í™”ë©´ í•˜ë‹¨ ì¤‘ì•™ì—ëŠ” ëª…ì¡°ì²´ë¡œ **'í•„ë¦¬í•€, 1944ë…„'**ì´ë¼ëŠ” í•œê¸€ í…ìŠ¤íŠ¸ê°€ ì„ ëª…í•˜ê²Œ ìƒˆê²¨ì ¸ ìˆë‹¤" ì´ëŸ° ì—°ì¶œ í•˜ë©´ ì•ˆëœë‹¤) 

    [ğŸ­ ìºë¦­í„° ê°ì • ì—°ê¸° ì§€ì¹¨ (Character Acting Guide) - ì¤‘ìš”]
    ì–¼êµ´ í‘œì •ì´ ë‹¨ìˆœí•œ ìŠ¤í‹±ë§¨ì´ë¯€ë¡œ, **ëª¸ì§“ê³¼ í‘œì •(Body Language)**ìœ¼ë¡œ ê°ì •ì„ í‘œí˜„í•˜ì‹­ì‹œì˜¤.
    
    - ê¸ˆì§€: í”¼(Blood), ì¶œí˜ˆ, ì‹œì²´(Corpse, Dead body), ì˜ë¦° ë¨¸ë¦¬(Decapitation), ê³ ë¬¸, ìì‚´, ë¼ˆ/í•´ê³¨(Skeleton), ë‚´ì¥, ë¦¬ì–¼í•œ ì´/ì¹¼(Weapon).
    - ê¸ˆì§€: ë‚˜ì¹˜(Nazi), ìš±ì¼ê¸° ë“± ì •ì¹˜ì ìœ¼ë¡œ ê·¹ë„ë¡œ ë¯¼ê°í•œ ì‹¬ë³¼.

    [ğŸ›¡ï¸ ê²€ì—´ íšŒí”¼ë¥¼ ìœ„í•œ 'ì‹œê°ì  ì€ìœ (Visual Metaphors)' ê°€ì´ë“œ]
    ëŒ€ë³¸ ë‚´ìš©ì´ ì”ì¸í•˜ê±°ë‚˜ í­ë ¥ì ì¼ ê²½ìš°, ë°˜ë“œì‹œ ì•„ë˜ì˜ **ìƒì§•ë¬¼**ë¡œ ëŒ€ì²´í•˜ì—¬ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    
    [ì¶œë ¥ í˜•ì‹]
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´(í•œê¸€)**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - ë¶€ê°€ì ì¸ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """
        
    elif genre_mode == "webtoon":
        full_instruction = f"""
    [ì—­í• ]
    ë‹¹ì‹ ì€ ë„¤ì´ë²„ ì›¹íˆ° ìŠ¤íƒ€ì¼ì˜ **'ì¸ê¸° ì›¹íˆ° ë©”ì¸ ì‘í™”ê°€'**ì…ë‹ˆë‹¤.
    ë…ìë“¤ì´ 1ì´ˆ ë§Œì— ì´í•´í•˜ê³  í´ë¦­í•˜ê³  ì‹¶ê²Œ ë§Œë“œëŠ” **'íŠ¸ë Œë””í•˜ê³  ì—­ë™ì ì¸ ì›¹íˆ° ì»·'**ì„ ê·¸ë ¤ì•¼ í•©ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ê·¸ë¦¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] {style_instruction}

    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **ì‘í™” ìŠ¤íƒ€ì¼:** í•œêµ­ ì›¹íˆ°(K-Webtoon) íŠ¹ìœ ì˜ **ì„ ëª…í•œ ì™¸ê³½ì„ (Sharp Outlines)**ê³¼ **í™”ë ¤í•œ ì±„ìƒ‰(Vibrant Coloring)**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
    2. **ìºë¦­í„° ë””ìì¸:** **ìŠ¤í‹±ë§¨ ì ˆëŒ€ ê¸ˆì§€.** 8ë“±ì‹  ë¹„ìœ¨ì˜ **'ë§¤ë ¥ì ì¸ ì›¹íˆ° ì£¼ì¸ê³µ(Anime/Manhwa Style)'**ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    3. **[í•µì‹¬ - ë°°ê²½ ë° ìƒí™© ê°•í™”]:**
       - ìºë¦­í„° ì–¼êµ´ë§Œ í¬ê²Œ ê·¸ë¦¬ì§€ ë§ê³ , ìºë¦­í„°ê°€ ì–´ë””ì— ìˆëŠ”ì§€, ì£¼ë³€ì— ë¬´ì—‡ì´ ìˆëŠ”ì§€ **'ë°°ê²½ê³¼ ìƒí™©(Context & Background)'ì„ ë§¤ìš° êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬**í•˜ì‹­ì‹œì˜¤.
       - ì˜ˆ: ë°© ì•ˆì´ë¼ë©´ ê°€êµ¬ì™€ ì¡°ëª…, ê±°ë¦¬ë¼ë©´ ê±´ë¬¼ê³¼ í–‰ì¸ë“¤, ì‚¬ë¬´ì‹¤ì´ë¼ë©´ ì±…ìƒ ìœ„ì˜ ì„œë¥˜ê¹Œì§€ ë””í…Œì¼í•˜ê²Œ ê·¸ë¦¬ì‹­ì‹œì˜¤.
    4. **[í•µì‹¬ - íš¨ê³¼ ì ˆì œ]:**
       - **ì§‘ì¤‘ì„ (Speed lines)ì´ë‚˜ ê³¼ë„í•œ ì´í™íŠ¸ëŠ” ë‚¨ë°œí•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** (ì •ë§ ì¶©ê²©ì ì¸ ì¥ë©´ì—ì„œë§Œ ê°€ë” ì‚¬ìš©)
       - ëŒ€ì‹  **ê³µê°„ê°(Depth of Field)**ê³¼ **í˜„ì‹¤ì ì¸ ë°°ê²½ ë””í…Œì¼**ë¡œ ìƒí™©ì„ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
    5. **ì¹´ë©”ë¼ ì•µê¸€:** í•˜ì´ ì•µê¸€, ë¡œìš° ì•µê¸€, ê´‘ê° ë Œì¦ˆ ë“±ì„ ì‚¬ìš©í•˜ë˜, ë°°ê²½ì´ ì˜ ë³´ì´ë„ë¡ êµ¬ë„ë¥¼ ì¡ìœ¼ì‹­ì‹œì˜¤.
    6. **í…ìŠ¤íŠ¸ ì²˜ë¦¬:** {lang_guide} {lang_example}
       - ì›¹íˆ° ë§í’ì„  ëŠë‚Œì´ë‚˜ ë°°ê²½ ì˜¤ë¸Œì íŠ¸(ê°„íŒ, ìŠ¤ë§ˆíŠ¸í°)ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì‹­ì‹œì˜¤.

    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ì„ ë°”íƒ•ìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤. (í•œê¸€ ì¶œë ¥)
    - "ì§‘ì¤‘ì„ ì´ ë°°ê²½ì— ê¹”ë¦¬ë©°..." ê°™ì€ í‘œí˜„ì€ ìì œí•˜ê³ , **"ë””í…Œì¼í•œ ì‚¬ë¬´ì‹¤ ë°°ê²½ì„ ë’¤ë¡œ í•˜ê³ ...", "ë¹„ ë‚´ë¦¬ëŠ” ê±°ë¦¬ í•œë³µíŒì—ì„œ..."** ì²˜ëŸ¼ ê³µê°„ ë¬˜ì‚¬ë¥¼ ìš°ì„ í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "news":
        full_instruction = f"""
    [ì—­í• ]
    ë‹¹ì‹ ì€ ë‰´ìŠ¤ ë³´ë„ ë° ë‹¤íë©˜í„°ë¦¬ ì œì‘ì„ ìœ„í•œ **'ì‹¤ì‚¬ ìë£Œí™”ë©´(Stock Footage) ì „ë¬¸ ë””ë ‰í„°'**ì…ë‹ˆë‹¤.
    ëŒ€ë³¸ ë‚´ìš©ì„ ì‹œê°ì ìœ¼ë¡œ ë’·ë°›ì¹¨í•˜ëŠ” **'ê³ í’ˆì§ˆ ì‹¤ì‚¬ ì‚¬ì§„(Hyper-Realistic Photo)'**ì„ ê¸°íší•´ì•¼ í•©ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] {style_instruction}

    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **ì™„ë²½í•œ ì‹¤ì‚¬(Photorealism Only):**
       - **ì ˆëŒ€ ê·¸ë¦¼, ì¼ëŸ¬ìŠ¤íŠ¸, 3D ë Œë”ë§, ë§Œí™” ëŠë‚Œ ê¸ˆì§€.**
       - ì‹¤ì œ DSLR ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•œ ë“¯í•œ **'ë‰´ìŠ¤ ë³´ë„ ì‚¬ì§„'** í˜¹ì€ **'ë‹¤íë©˜í„°ë¦¬ ìŠ¤í‹¸ì»·'**ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
    2. **[ë§¤ìš° ì¤‘ìš” - ë¶„í•  í™”ë©´ ì ˆëŒ€ ê¸ˆì§€]:**
       - í™”ë©´ì„ ì—¬ëŸ¬ ê°œë¡œ ë‚˜ëˆ„ëŠ” **'ì½œë¼ì£¼(Collage)'ë‚˜ 'ë¶„í•  í™”ë©´(Split Screen)' ì—°ì¶œì„ ì ˆëŒ€ ê¸ˆì§€**í•©ë‹ˆë‹¤.
       - ë¬´ì¡°ê±´ **'ë‹¨ì¼ í™”ë©´(Single Shot)'**ìœ¼ë¡œ í•˜ë‚˜ì˜ ì¥ë©´ì—ë§Œ ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤.
    3. **ìë£Œí™”ë©´ ì—°ì¶œ(Stock Footage Style):**
       - ì•µì»¤ê°€ ì•‰ì•„ìˆëŠ” ìŠ¤íŠœë””ì˜¤ ëª¨ìŠµì´ **ì•„ë‹™ë‹ˆë‹¤.**
       - ëŒ€ë³¸ì˜ ë‚´ìš©ì„ ì„¤ëª…í•˜ëŠ” **í˜„ì¥ ìŠ¤ì¼€ì¹˜, ì¸ì„œíŠ¸ ì»·, ì‚¬ë¬¼ í´ë¡œì¦ˆì—…, í’ê²½** ë“±ì„ ì‹¤ì‚¬ë¡œ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    4. **ì¶”ìƒì  ê°œë…ì˜ ì‹œê°í™”:**
       - ì˜ˆ: 'ë¶€ë™ì‚° í­ë½' -> (X) ì§‘ì´ ë¬´ë„ˆì§€ëŠ” ë§Œí™” (O) 'ë§¤ë§¤' ìŠ¤í‹°ì»¤ê°€ ë¶™ì€ ì•„íŒŒíŠ¸ ë‹¨ì§€ì˜ ì“¸ì“¸í•œ ì „ê²½ ë˜ëŠ” ë¶€ë™ì‚° ì¤‘ê°œì†Œì˜ í…… ë¹ˆ ìœ ë¦¬ì°½.
       - ì˜ˆ: 'ì €ì¶œì‚°' -> (X) ìš°ëŠ” ì•„ê¸° ì²œì‚¬ (O) í…… ë¹ˆ ë†€ì´í„°ì˜ ê·¸ë„¤ê°€ í”ë“¤ë¦¬ëŠ” ëª¨ìŠµ.
    5. **í…ìŠ¤íŠ¸ ì²˜ë¦¬:** {lang_guide} {lang_example}
       - í…ìŠ¤íŠ¸ëŠ” ì¸ìœ„ì ìœ¼ë¡œ ë„ìš°ì§€ ë§ê³ , ê±°ë¦¬ì˜ ê°„íŒ, ì‹ ë¬¸ í—¤ë“œë¼ì¸, ìŠ¤ë§ˆíŠ¸í° í™”ë©´, ì„œë¥˜ ë‚´ìš©ì²˜ëŸ¼ **ì‹¤ì œ ì‚¬ë¬¼ì— í•©ì„±**ëœ ê²ƒì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    6. **ì¡°ëª… ë° í†¤ì•¤ë§¤ë„ˆ:**
       - ë‰´ìŠ¤ ë³´ë„ì— ì í•©í•œ **ì„ ëª…í•˜ê³  ì‚¬ì‹¤ì ì¸ ì¡°ëª…(Natural & Sharp Lighting)**.
       - ê³¼ë„í•œ ì˜ˆìˆ ì  í•„í„°ë³´ë‹¤ëŠ” ì‚¬ì‹¤ ì „ë‹¬ì— ì§‘ì¤‘í•œ í†¤.
    7. **ì¸ë¬¼ ì—°ì¶œ:**
        - ëŒ€ë³¸ì— ì–´ìš¸ë¦¬ëŠ” ì¸ë¬¼ë“¤ì˜ í–‰ë™ ì—°ì¶œ.
    8. ë¶„í™œí™”ë©´ìœ¼ë¡œ ì—°ì¶œí•˜ì§€ ë§ê³  í•˜ë‚˜ì˜ í™”ë©´ìœ¼ë¡œ ì—°ì¶œí•œë‹¤.

    [ì„ë¬´]
    ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ AIê°€ ìƒì„±í•  ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì¸ ì‹¤ì‚¬ ì‚¬ì§„ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - "Photorealistic, 8k resolution, cinematic lighting, depth of field" ë“±ì˜ í€„ë¦¬í‹° í‚¤ì›Œë“œ í¬í•¨.
    - ì¸ë¬¼ ë¬˜ì‚¬ ì‹œ 'Korean' í˜¹ì€ êµ¬ì²´ì ì¸ ì¸ì¢…/ë‚˜ì´ëŒ€ë¥¼ ëª…ì‹œí•˜ì—¬ ì‚¬ì‹¤ì„± ë¶€ì—¬.
    - **í•œê¸€**ë¡œë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "manga":
        full_instruction = f"""
    [ì—­í• ]
    ë‹¹ì‹ ì€ **ì‘í™” í€„ë¦¬í‹°ê°€ ê·¹ë„ë¡œ ë†’ì€ 'ëŒ€ì‘ ì§€ë¸Œë¦¬í’ ì• ë‹ˆë©”ì´ì…˜'ì˜ ì´ê´„ ì‘í™” ê°ë…**ì…ë‹ˆë‹¤.
    ë‹¨ìˆœíˆ ì˜ˆìœ ê·¸ë¦¼ì´ ì•„ë‹ˆë¼, **ëŒ€ë³¸ì˜ ìƒí™©, í–‰ë™, ê°ì •ì„ 'ì†Œë¦„ ë‹ì„ ì •ë„ë¡œ êµ¬ì²´ì ì´ê³  ë””í…Œì¼í•˜ê²Œ' ë¬˜ì‚¬**í•´ì•¼ í•©ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] {style_instruction}

    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **ì‘í™” ìŠ¤íƒ€ì¼ (High Detail):**
       - **ì„œì •ì ì´ê³  ëª½í™˜ì ì¸ ëŠë‚Œ ê¸ˆì§€.** ëŒ€ì‹  **ì„ ëª…í•˜ê³ , ë‚ ì¹´ë¡­ê³ , ì •ë³´ëŸ‰ì´ ë§ì€(High Information Density)** ì‘í™”ë¥¼ ì¶”êµ¬í•˜ì‹­ì‹œì˜¤.
       - ë°°ê²½ì€ íë¦¿í•˜ê²Œ ì²˜ë¦¬í•˜ì§€ ë§ê³ , ê°„íŒì˜ ê¸€ì”¨, ì±…ìƒì˜ ì†Œí’ˆ, ë²½ì˜ ì§ˆê°ê¹Œì§€ **ì§‘ìš”í•  ì •ë„ë¡œ ë””í…Œì¼í•˜ê²Œ** ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤. (ì˜ˆ: 'MAPPA', 'Ufotable' ì œì‘ì‚¬ì˜ ê³ í€„ë¦¬í‹° ì‘í™” ìŠ¤íƒ€ì¼)
    2. **í–‰ë™ ë° ê°ì • ë¬˜ì‚¬ (Action & Emotion):**
       - ëŒ€ë³¸ì— ë¬˜ì‚¬ëœ ìºë¦­í„°ì˜ í–‰ë™ì„ **'ìˆœê°„ í¬ì°©'** í•˜ë“¯ ì—­ë™ì ìœ¼ë¡œ ê·¸ë¦¬ì‹­ì‹œì˜¤.
       - **í‘œì • ì—°ê¸°:** ëˆˆì¹ì˜ ê°ë„, ì… ëª¨ì–‘, ëˆˆë™ìì˜ í”ë“¤ë¦¼ê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ ì§€ì‹œí•˜ì—¬ ìºë¦­í„°ì˜ ì‹¬ë¦¬ë¥¼ ì™„ë²½í•˜ê²Œ í‘œí˜„í•˜ì‹­ì‹œì˜¤.
    3. **ëŒ€ë³¸ ì¶©ì‹¤ë„ (Script Fidelity):**
       - ëŒ€ë³¸ì— ìˆëŠ” ì‘ì€ ì§€ë¬¸ í•˜ë‚˜ë„ ë†“ì¹˜ì§€ ë§ê³  ì‹œê°í™”í•˜ì‹­ì‹œì˜¤.
       - "ì»µì„ ë–¨êµ°ë‹¤"ëŠ” ëŒ€ë³¸ì´ë¼ë©´, ì»µì´ ì†ì—ì„œ ë– ë‚˜ ê³µì¤‘ì— ìˆëŠ” ìˆœê°„ê³¼ íŠ€ì–´ ì˜¤ë¥´ëŠ” ë¬¼ë°©ìš¸ê¹Œì§€ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    4. **í…ìŠ¤íŠ¸ ì²˜ë¦¬:** {lang_guide} {lang_example}
      
    [ì‘ì„± ìš”êµ¬ì‚¬í•­]
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - ì ˆëŒ€ ë¶„í™œí™”ë©´ ì—°ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤. ì „ì²´ ëŒ€ë³¸ ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ë¬˜ì‚¬.

    [ì„ë¬´]
    ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ AIê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” **ìµœìƒê¸‰ ì§€ë¸Œë¦¬í’ í€„ë¦¬í‹°ì˜ ì• ë‹ˆë©”ì´ì…˜ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - "Masterpiece, best quality, ultra-detailed, intricate background, dynamic pose, expressive face" ë“±ì˜ í‚¤ì›Œë“œê°€ ë°˜ì˜ë˜ë„ë¡ í•˜ì‹­ì‹œì˜¤.
    - **í•œê¸€**ë¡œë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    elif genre_mode == "paint_explainer":
        # [NEW] The Paint Explainer ìŠ¤íƒ€ì¼ (í° ë°°ê²½ + ìŠ¤í‹±ë§¨ + ë‹¨ìˆœí•¨ + ëª…í™•í•œ ì‚¬ë¬¼ í‘œí˜„)
        full_instruction = f"""
    [ì—­í• ]
    ë‹¹ì‹ ì€ ìœ íŠœë¸Œ 'The Paint Explainer' ì±„ë„ ìŠ¤íƒ€ì¼ì˜ **'ì´ˆì‹¬í”Œ ìŠ¤í‹±ë§¨ ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°'**ì…ë‹ˆë‹¤.
    ë³µì¡í•œ ì„¸ìƒì˜ ì´ì•¼ê¸°ë¥¼ **'í°ìƒ‰ ë°°ê²½ ìœ„, ê²€ì€ìƒ‰ ì„ ìœ¼ë¡œ ëœ ì¡¸ë¼ë§¨(Stickman)'ê³¼ 'ì§ê´€ì ì¸ ì‚¬ë¬¼ ê·¸ë¦¼'**ìœ¼ë¡œ ì•„ì£¼ ë‹¨ìˆœí•˜ê³  ëª…ì¾Œí•˜ê²Œ ì„¤ëª…í•´ì•¼ í•©ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] {style_instruction}

    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **[í•µì‹¬ - ë°°ê²½] ë°°ê²½ì€ ë¬´ì¡°ê±´ 'ì™„ì „í•œ í°ìƒ‰(Pure White Background)'**ì…ë‹ˆë‹¤.
       - ë°°ê²½ì— í’ê²½, í•˜ëŠ˜, ê·¸ë¼ë°ì´ì…˜, ì¢…ì´ ì§ˆê° ë“±ì„ ì ˆëŒ€ ë„£ì§€ ë§ˆì‹­ì‹œì˜¤. ê·¸ëƒ¥ í•˜ì–€ ì—¬ë°±ì…ë‹ˆë‹¤.
    2. **[í•µì‹¬ - ìºë¦­í„°] ì™„ë²½í•œ 'ì¡¸ë¼ë§¨(Stick Figure)' ìŠ¤íƒ€ì¼:**
       - ë¨¸ë¦¬ëŠ” ë™ê·¸ë¼ë¯¸(Circle head).
       - ëª¸í†µê³¼ íŒ”ë‹¤ë¦¬ëŠ” **ë‹¨ìˆœí•œ ê²€ì€ ë§‰ëŒ€ê¸° ì„ (Stick limbs)**.
       - í‘œì •ì€ ì  ëˆˆ(. .)ê³¼ ì„  ì…(__)ìœ¼ë¡œ ë‹¨ìˆœí•˜ì§€ë§Œ ìƒí™©(ê¸°ì¨, ìŠ¬í””, ë‹¹í™©)ì„ ëª…í™•íˆ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
    3. **[í•µì‹¬ - ì†Œí’ˆ ë° ìƒí™© ì—°ì¶œ (Props & Context) - ê°•í™”ë¨]:**
       - ëŒ€ë³¸ ì† ì¤‘ìš”í•œ ì‚¬ë¬¼ë“¤ì„ **ë‹¨ìˆœí•˜ì§€ë§Œ ê·¸ íŠ¹ì§•ì´ ê°€ì¥ ì˜ ë“œëŸ¬ë‚˜ê²Œ ê³¼ì¥í•˜ì—¬** ê·¸ë¦¬ì‹­ì‹œì˜¤.
       - **ì‹œê°ì  ì€ìœ (Visual Metaphor)ë¥¼ ì ê·¹ í™œìš©í•˜ì‹­ì‹œì˜¤.**
         - (ì˜ˆ: 'ì—„ì²­ë‚œ ë¹š' -> ìŠ¤í‹±ë§¨ì„ ì§“ëˆ„ë¥´ëŠ” ê±´ë¬¼ë§Œ í•œ ë°”ìœ„ ë©ì–´ë¦¬ì— 'ë¹š(DEBT)'ì´ë¼ê³  ì”€)
         - (ì˜ˆ: 'ëˆì„ ë²Œë‹¤' -> ìŠ¤í‹±ë§¨ ì†ìœ¼ë¡œ ìì„ì„ ë“¤ê³  ëˆë‹¤ë°œì„ ëŒì–´ë‹¹ê¸°ëŠ” ëª¨ìŠµ)
       - ìƒí™© ì„¤ëª…ë ¥ì„ ë†’ì´ê¸° ìœ„í•´ **í™”ì‚´í‘œ(â†’), ë¬¼ìŒí‘œ(?), ëŠë‚Œí‘œ(!), ë‹¹í™© í‘œì‹œ(ë•€ë°©ìš¸ ğŸ’¦), ë°˜ì§ì„(âœ¨) ë“±ì˜ ê¸°í˜¸**ë¥¼ ì ê·¹ì ìœ¼ë¡œ ê·¸ë¦¼ ì˜†ì— ì¶”ê°€í•˜ì‹­ì‹œì˜¤.
       - ì‚¬ë¬¼ë¼ë¦¬ì˜ ê´€ê³„(ì›ì¸->ê²°ê³¼)ë¥¼ í™”ì‚´í‘œë¡œ ì—°ê²°í•˜ì—¬ ë³´ì—¬ì£¼ì‹­ì‹œì˜¤.
    4. **[ì‘í™” ìŠ¤íƒ€ì¼] MS ê·¸ë¦¼íŒ(MS Paint) ê°ì„±:**
       - ê³ í€„ë¦¬í‹° ì˜ˆìˆ  ì‘í’ˆì´ ì•„ë‹™ë‹ˆë‹¤. ë§ˆìš°ìŠ¤ë¡œ ëŒ€ì¶© ê·¸ë¦° ë“¯í•œ(Rough sketch, scribbles, crude drawing) ëŠë‚Œì„ ì‚´ë¦¬ì‹­ì‹œì˜¤.
       - ê·¸ë¦¼ìëŠ” ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤(No shading). ì™„ì „í•œ í‰ë©´(Flat)ì…ë‹ˆë‹¤.
    5. **[ìƒ‰ìƒ ì‚¬ìš©]:**
       - ê¸°ë³¸ì€ **í‘ë°±(Black lines on White)**ì…ë‹ˆë‹¤.
       - ê°•ì¡°í•˜ê³  ì‹¶ì€ í•µì‹¬ ì‚¬ë¬¼(ëˆ, êµ­ê¸°, ì¤‘ìš”í•œ ë²„íŠ¼ ë“±)ì—ë§Œ **ë¹¨ê°•, íŒŒë‘, ë…¸ë‘ ê°™ì€ ì›ìƒ‰(Primary Colors)**ì„ í¬ì¸íŠ¸ë¡œ ì‚¬ìš©í•˜ì—¬ ì‹œì„ ì„ ì§‘ì¤‘ì‹œí‚¤ì‹­ì‹œì˜¤.
    6. **[í…ìŠ¤íŠ¸ ì²˜ë¦¬]:** {lang_guide} {lang_example}
       - ì‚ëš¤ë¹¼ëš¤í•œ ë§ˆìš°ìŠ¤ ì†ê¸€ì”¨ ëŠë‚Œìœ¼ë¡œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤. í…ìŠ¤íŠ¸ ë°•ìŠ¤ë³´ë‹¤ëŠ” ê·¸ë¦¼ ì˜†ì— ìì—°ìŠ¤ëŸ½ê²Œ ì“°ì¸ ëŠë‚Œì´ ì¢‹ìŠµë‹ˆë‹¤.
    7. **[êµ¬ë„]:**
       - ë¶„í•  í™”ë©´ ê¸ˆì§€. í•˜ë‚˜ì˜ í° í™”ë©´ ìœ„ì— ìºë¦­í„°ì™€ ê´€ë ¨ ì‚¬ë¬¼ë“¤ì„ ë°°ì¹˜í•˜ì—¬ í•˜ë‚˜ì˜ ìƒí™©ê·¹ì²˜ëŸ¼ ë§Œë“œì‹­ì‹œì˜¤.

    [ì„ë¬´]
    ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ AIê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” **'The Paint Explainer ìŠ¤íƒ€ì¼'ì˜ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - "Minimalist stick figure, crude ms paint style, pure white background, simple line drawing, visual metaphor, infographic elements (arrows, symbols)" ë“±ì˜ í‚¤ì›Œë“œê°€ ë°˜ì˜ë˜ë„ë¡ í•˜ì‹­ì‹œì˜¤.
    - **í•œê¸€**ë¡œë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    # ---------------------------------------------------------
    # [ëª¨ë“œ NEW] ìŠ¤í‹±ë§¨ ì‚¬ì‹¤ì  ì—°ì¶œ (Realistic Stickman Drama)
    # ---------------------------------------------------------
    elif genre_mode == "realistic_stickman":
        full_instruction = f"""
    [ì—­í• ]
    ë‹¹ì‹ ì€ **'ë„·í”Œë¦­ìŠ¤ 2D ì• ë‹ˆë©”ì´ì…˜ ê°ë…'**ì…ë‹ˆë‹¤. 
    **ë°˜ë“œì‹œ '2D ê·¸ë¦¼(Digital Art)' ìŠ¤íƒ€ì¼**ì´ì–´ì•¼ í•˜ë©°, **ì‹¤ì‚¬(Photorealism)ë‚˜ 3D ë Œë”ë§ ëŠë‚Œì´ ë‚˜ë©´ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.**
    ë‹¨ìˆœí•œ ì–¼êµ´ì´ ë‘¥ê·¼ ìŠ¤í‹±ë§¨ë“¤ì„ ì£¼ì¸ê³µìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬, ë°°ê²½ê³¼ ì¡°ëª…ë§Œ ì˜í™”ì²˜ëŸ¼ ë¶„ìœ„ê¸° ìˆê²Œ ì—°ì¶œí•©ë‹ˆë‹¤.
    
    [ì „ì²´ ì˜ìƒ ì£¼ì œ] "{video_title}"
    [ìœ ì € ìŠ¤íƒ€ì¼ ì„ í˜¸] {style_instruction}

    [ğŸš« í•µì‹¬ ê¸ˆì§€ ì‚¬í•­ - ì ˆëŒ€ ì–´ê¸°ì§€ ë§ˆì‹œì˜¤]
    - **ì‹¤ì‚¬ ì‚¬ì§„(Real Photo), 3D ë Œë”ë§(Unreal Engine), ì‚¬ëŒ í”¼ë¶€ ì§ˆê°(Skin texture) ì ˆëŒ€ ê¸ˆì§€.**
    - ì‚¬ëŒì˜ ì½”, ì…, ê·€, ì†í†± ë“±ì„ ë¦¬ì–¼í•˜ê²Œ ë¬˜ì‚¬í•˜ì§€ ë§ˆì‹œì˜¤.
    - ë¬´ì¡°ê±´ **'ê·¸ë¦¼(Illustration/Drawing/Manhwa)'** ëŠë‚Œì´ ë‚˜ì•¼ í•©ë‹ˆë‹¤.

    [í•µì‹¬ ë¹„ì£¼ì–¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    1. **ìºë¦­í„°(Character):** - **ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ ìŠ¤í‹±ë§¨(Round-headed white stickman)**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
       - í•˜ì§€ë§Œ ì„ ì€ êµµê³  ë¶€ë“œëŸ¬ìš°ë©°, **ê·¸ë¦¼ì(Shading)**ê°€ ë“¤ì–´ê°€ ì…ì²´ê°ì´ ëŠê»´ì ¸ì•¼ í•©ë‹ˆë‹¤.
       - **ì˜ìƒ:** ëŒ€ë³¸ ìƒí™©ì— ë§ëŠ” í˜„ì‹¤ì ì¸ ì˜ìƒ(ì •ì¥, êµ°ë³µ, ì ì˜·, ì‘ì—…ë³µ ë“±)ì„ ìŠ¤í‹±ë§¨ ìœ„ì— ì…í˜€ 'ìºë¦­í„°ì„±'ì„ ë¶€ì—¬í•˜ì‹­ì‹œì˜¤.
       - ì–¼êµ´ì´ í¬ê²Œ ì˜ ë³´ì´ê²Œ ì—°ì¶œ. ì¥ë©´ë„ ì˜ ë“œëŸ¬ë‚˜ê²Œ.
       
    2. **ë°°ê²½(Background) - ê°€ì¥ ì¤‘ìš”:**
       - ë‹¨ìˆœí•œ ê·¸ë¼ë°ì´ì…˜ì´ë‚˜ ë‹¨ìƒ‰ ë°°ê²½ì„ **ì ˆëŒ€ ê¸ˆì§€**í•©ë‹ˆë‹¤.
       - **ê³ í•´ìƒë„ ì»¨ì…‰ ì•„íŠ¸(High-quality Concept Art)** ìˆ˜ì¤€ìœ¼ë¡œ ë°°ê²½ì„ ê·¸ë¦¬ì‹­ì‹œì˜¤.
       - ì˜ˆ: ì‚¬ë¬´ì‹¤ì´ë¼ë©´ ì±…ìƒì˜ ì„œë¥˜ ë”ë¯¸, ì°½ë°–ì˜ í’ê²½, ì»¤í”¼ì”ì˜ ê¹€, ë²½ì˜ ì§ˆê°ê¹Œì§€ ë¬˜ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤.
       
    3. **ì¡°ëª…(Lighting):**
       - 2Dì§€ë§Œ **ì…ì²´ì ì¸ ì¡°ëª…(Volumetric Lighting)**ê³¼ ê·¸ë¦¼ìë¥¼ ì‚¬ìš©í•˜ì—¬ ê¹Šì´ê°ì„ ë§Œë“œì‹­ì‹œì˜¤.
       - ìƒí™©ì— ë”°ë¼ ë”°ëœ»í•œ í–‡ì‚´, ì°¨ê°€ìš´ ë„¤ì˜¨ì‚¬, ì–´ë‘ìš´ ë°©ì˜ ìŠ¤íƒ ë“œ ì¡°ëª… ë“±ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì‹­ì‹œì˜¤.
       
    4. **ì—°ê¸°(Acting):**
       - ì¸í¬ê·¸ë˜í”½ì²˜ëŸ¼ ì •ë³´ë¥¼ ë‚˜ì—´í•˜ì§€ ë§ê³ , **ìºë¦­í„°ê°€ í–‰ë™(Action)í•˜ëŠ” ì¥ë©´**ì„ í¬ì°©í•˜ì‹­ì‹œì˜¤.
       - ê°ì • í‘œí˜„: ì–¼êµ´ í‘œì •ì€ ë‹¨ìˆœí•˜ê²Œ ê°€ë˜, **ì–´ê¹¨ì˜ ì²˜ì§, ì£¼ë¨¹ ì¥” ì†, ë‹¤ê¸‰í•œ ë‹¬ë¦¬ê¸°, ë¬´ë¦ ê¿‡ê¸° ë“± 'ëª¸ì§“(Body Language)'**ìœ¼ë¡œ ê°ì •ì„ ì „ë‹¬í•˜ì‹­ì‹œì˜¤.

    5. **ì–¸ì–´(Text):** {lang_guide} {lang_example} (ìë§‰ ì—°ì¶œë³´ë‹¤ëŠ” ë°°ê²½ ì† ê°„íŒ, ì„œë¥˜, í™”ë©´ ë“± ìì—°ìŠ¤ëŸ¬ìš´ í…ìŠ¤íŠ¸ ìœ„ì£¼ë¡œ)
    6. **êµ¬ë„:** ë¶„í•  í™”ë©´(Split Screen) ê¸ˆì§€. 16:9 ê½‰ ì°¬ ì‹œë„¤ë§ˆí‹± êµ¬ë„ ì‚¬ìš©.

    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ì½ê³ , ê·¸ ìƒí™©ì„ ê°€ì¥ ì˜ ë³´ì—¬ì£¼ëŠ” **í•œ ì¥ë©´ì˜ ì˜í™” ìŠ¤í‹¸ì»·** ê°™ì€ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± íŒ]
    - "A cinematic 2D shot of a round-headed stickman..." ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëŠë‚Œìœ¼ë¡œ ì‘ì„±.
    - ëŒ€ë³¸ì´ ì¶”ìƒì (ì˜ˆ: ê²½ì œ ìœ„ê¸°)ì´ë¼ë©´, ìŠ¤í‹±ë§¨ì´ í…… ë¹ˆ ì§€ê°‘ì„ ë³´ë©° ì¢Œì ˆí•˜ëŠ” êµ¬ì²´ì ì¸ ìƒí™©ìœ¼ë¡œ ì¹˜í™˜í•˜ì—¬ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - ìë§‰ ê°™ì€ ì—°ì¶œ í•˜ì§€ ì•ŠëŠ”ë‹¤. ("í™”ë©´ í•˜ë‹¨ ì¤‘ì•™ì—ëŠ” ëª…ì¡°ì²´ë¡œ **'í•„ë¦¬í•€, 1944ë…„'**ì´ë¼ëŠ” í•œê¸€ í…ìŠ¤íŠ¸ê°€ ì„ ëª…í•˜ê²Œ ìƒˆê²¨ì ¸ ìˆë‹¤" ì´ëŸ° ì—°ì¶œ í•˜ë©´ ì•ˆëœë‹¤) 

    
    [ì¶œë ¥ í˜•ì‹]
    - **ë¶„ëŸ‰:** ìµœì†Œ 7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´(í•œê¸€)**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - ë¶€ê°€ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    else:
        # [ëª¨ë“œ 1] ë°ì€ ì •ë³´/ì´ìŠˆ
        full_instruction = f"""
    [ì—­í• ]
    ë‹¹ì‹ ì€ ë³µì¡í•œ ìƒí™©ì„ ì•„ì£¼ ì‰½ê³  ì§ê´€ì ì¸ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” 'ë¹„ì£¼ì–¼ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ë¬¸ê°€'ì´ì 'êµìœ¡ìš© ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°'ì…ë‹ˆë‹¤.

    [ì „ì²´ ì˜ìƒ ì£¼ì œ]
    "{video_title}"

    [ê·¸ë¦¼ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ - ì ˆëŒ€ ì¤€ìˆ˜]
    {style_instruction}
    
    [í•„ìˆ˜ ì—°ì¶œ ì§€ì¹¨]
    1. **ì¡°ëª…(Lighting):** ë¬´ì¡°ê±´ **'ë°ê³  í™”ì‚¬í•œ ì¡°ëª…(High Key Lighting)'**ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. ê·¸ë¦¼ìê°€ ì§™ê±°ë‚˜ ì–´ë‘ìš´ ë¶€ë¶„ì€ ì—†ì–´ì•¼ í•©ë‹ˆë‹¤.
    2. **ìƒ‰ê°(Colors):** ì±„ë„ê°€ ë†’ê³  ì„ ëª…í•œ ìƒ‰ìƒì„ ì‚¬ìš©í•˜ì—¬ ì‹œì¸ì„±ì„ ë†’ì´ì‹­ì‹œì˜¤. (ì¹™ì¹™í•˜ê±°ë‚˜ íšŒìƒ‰ì¡° í†¤ ê¸ˆì§€)
    3. **êµ¬ì„±(Composition):** ì‹œì²­ìê°€ ìƒí™©ì„ í•œëˆˆì— ì´í•´í•  ìˆ˜ ìˆë„ë¡ í”¼ì‚¬ì²´ë¥¼ í™”ë©´ ì¤‘ì•™ì— ëª…í™•í•˜ê²Œ ë°°ì¹˜í•˜ì‹­ì‹œì˜¤.
    4. **ë¶„ìœ„ê¸°(Mood):** êµìœ¡ì ì´ê³ , ì¤‘ë¦½ì ì´ë©°, ì‚°ëœ»í•œ ë¶„ìœ„ê¸°ì—¬ì•¼ í•©ë‹ˆë‹¤. **(ì ˆëŒ€ ìš°ìš¸í•˜ê±°ë‚˜, ë¬´ì„­ê±°ë‚˜, ê¸°ê´´í•œ ëŠë‚Œ ê¸ˆì§€)**
    5. ë¶„í™œí™”ë©´ìœ¼ë¡œ ì—°ì¶œí•˜ì§€ ë§ê³  í•˜ë‚˜ì˜ í™”ë©´ìœ¼ë¡œ ì—°ì¶œí•œë‹¤.
    6. **[í…ìŠ¤íŠ¸ ì–¸ì–´]:** {lang_guide} {lang_example}
    - **[ì ˆëŒ€ ê¸ˆì§€]:** í™”ë©´ì˜ ë„¤ ëª¨ì„œë¦¬(Corners)ë‚˜ ê°€ì¥ìë¦¬(Edges)ì— ê¸€ìë¥¼ ë°°ì¹˜í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ê¸€ìëŠ” ë°˜ë“œì‹œ ì¤‘ì•™ í”¼ì‚¬ì²´ ì£¼ë³€ì—ë§Œ ì—°ì¶œí•˜ì‹­ì‹œì˜¤.
    7. ìºë¦­í„°ì˜ ê°ì •ë„ ëŠê»´ì§„ë‹¤.

    [ì„ë¬´]
    ì œê³µëœ ëŒ€ë³¸ ì¡°ê°(Script Segment)ì„ ë°”íƒ•ìœ¼ë¡œ, ì´ë¯¸ì§€ ìƒì„± AIê°€ ê·¸ë¦´ ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì¸ ë¬˜ì‚¬ í”„ë¡¬í”„íŠ¸**ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
    [ì‘ì„± ìš”êµ¬ì‚¬í•­]
    - **ë¶„ëŸ‰:** ìµœì†Œ 5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬.
    - **í¬í•¨ ìš”ì†Œ:**
        - **ìºë¦­í„° í–‰ë™:** ëŒ€ë³¸ì˜ ìƒí™©ì„ ì—°ê¸°í•˜ëŠ” ìºë¦­í„°ì˜ êµ¬ì²´ì ì¸ ë™ì‘.
        - **ë°°ê²½:** ìƒí™©ì„ ì„¤ëª…í•˜ëŠ” ì†Œí’ˆì´ë‚˜ ì¥ì†Œ (ë°°ê²½ì€ ê¹”ë”í•˜ê²Œ).
        - **ì‹œê°ì  ì€ìœ :** ì¶”ìƒì ì¸ ë‚´ìš©ì¼ ê²½ìš°, ì´ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆëŠ” ì‹œê°ì  ì•„ì´ë””ì–´ (ì˜ˆ: ëˆì´ ë‚ ì•„ê°€ëŠ” ëª¨ìŠµ, ê·¸ë˜í”„ê°€ í•˜ë½í•˜ëŠ” ëª¨ìŠµ ë“±).
    
    [ì¶œë ¥ í˜•ì‹]
    - **ë¬´ì¡°ê±´ í•œêµ­ì–´(í•œê¸€)**ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    - ë¶€ê°€ì ì¸ ì„¤ëª… ì—†ì´ **ì˜¤ì§ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë§Œ** ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
        """

    max_retries = 3
    # [ìˆ˜ì •ë¨] ìš”ì²­í•˜ì‹  ëŒ€ë¡œ gemini-2.5-proë¥¼ 1ìˆœìœ„ë¡œ ì„¤ì •
    # ì•ˆì •ì„±ì„ ìœ„í•´ Flashë¥¼ 2ìˆœìœ„ ë°±ì—…ìœ¼ë¡œ ë°°ì¹˜
    target_models = ["gemini-2.5-pro", "gemini-2.5-flash"]

    for attempt in range(1, max_retries + 1):
        for model_name in target_models:
            try:
                # Pro ëª¨ë¸ ì†ë„ ì œí•œ(Rate Limit) ë°©ì§€ë¥¼ ìœ„í•´ ëŒ€ê¸° ì‹œê°„ ì¡°ì ˆ
                time.sleep(random.uniform(0.1, 0.3))
                
                response = client.models.generate_content(
                    model=model_name,
                    contents=full_instruction + f'\n\n[ëŒ€ë³¸ ë‚´ìš©]\n"{text_chunk}"',
                    config=types.GenerateContentConfig(
                        temperature=0.75,
                        max_output_tokens=1000, # ì†ë„ ìµœì í™”ë¥¼ ìœ„í•´ í† í° ìˆ˜ ì œí•œ
                        safety_settings=[
                            types.SafetySetting(category="HARM_CATEGORY_DANGEROUS_CONTENT", threshold="BLOCK_ONLY_HIGH"),
                            types.SafetySetting(category="HARM_CATEGORY_HARASSMENT", threshold="BLOCK_ONLY_HIGH"),
                            types.SafetySetting(category="HARM_CATEGORY_HATE_SPEECH", threshold="BLOCK_ONLY_HIGH"),
                            types.SafetySetting(category="HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold="BLOCK_ONLY_HIGH"),
                        ]
                    )
                )

                if response.text:
                    result = response.text.strip()
                    if len(result) < 5 or result == text_chunk: continue
                    return (scene_num, result)

            except Exception as e:
                # ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ ì¶œë ¥ í›„ ì ì‹œ ëŒ€ê¸°
                print(f"âš ï¸ ëª¨ë¸ ì§€ì—° ({model_name}): {e}")
                time.sleep(1)

    return (scene_num, f"ì£¼ì œ '{video_title}'ì— ì–´ìš¸ë¦¬ëŠ” ë°°ê²½ ì¼ëŸ¬ìŠ¤íŠ¸ (Fallback).")

# ==========================================
# [í•¨ìˆ˜] 3. ì´ë¯¸ì§€ ìƒì„± (ìˆ˜ì •ë¨: ì˜¤ë¥˜ ë””ë²„ê¹… ì¶”ê°€)
# ==========================================
def generate_image(client, prompt, filename, output_dir, selected_model_name, style_instruction):
    full_path = os.path.join(output_dir, filename)
    
    # [ìˆ˜ì •] í”„ë¡¬í”„íŠ¸ê°€ ë„ˆë¬´ ê¸¸ë©´ ì˜ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, í•µì‹¬ë§Œ ì „ë‹¬
    final_prompt = f"{style_instruction}\n\n[ì¥ë©´ ë¬˜ì‚¬]: {prompt}"
    
    safety_settings = [
        types.SafetySetting(category="HARM_CATEGORY_DANGEROUS_CONTENT", threshold="BLOCK_ONLY_HIGH"),
        types.SafetySetting(category="HARM_CATEGORY_HARASSMENT", threshold="BLOCK_ONLY_HIGH"),
        types.SafetySetting(category="HARM_CATEGORY_HATE_SPEECH", threshold="BLOCK_ONLY_HIGH"),
        types.SafetySetting(category="HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold="BLOCK_ONLY_HIGH"),
    ]

    print(f"ğŸ”„ ìƒì„± ì‹œë„: {filename} / Model: {selected_model_name}") # ë¡œê·¸ ì¶œë ¥

    try:
        response = client.models.generate_content(
            model=selected_model_name,
            contents=[final_prompt],
            config=types.GenerateContentConfig(
                image_config=types.ImageConfig(aspect_ratio="16:9"),
                safety_settings=safety_settings
            )
        )
        
        if response.parts:
            for part in response.parts:
                # 1. ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ëœ ê²½ìš°
                if part.inline_data:
                    img_data = part.inline_data.data
                    image = Image.open(BytesIO(img_data))
                    image.save(full_path)
                    print(f"âœ… ì €ì¥ ì„±ê³µ: {full_path}")
                    return full_path
                
                # 2. [ì¤‘ìš”] ì´ë¯¸ì§€ê°€ ì•„ë‹ˆë¼ í…ìŠ¤íŠ¸(ê±°ì ˆ ë©”ì‹œì§€)ê°€ ì˜¨ ê²½ìš°
                if part.text:
                    print(f"âš ï¸ ëª¨ë¸ ê±°ì ˆ(Safety/Refusal): {part.text}")
                    # ë¹ˆ ì´ë¯¸ì§€ë‚˜ ì—ëŸ¬ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì„œë¼ë„ ë°˜í™˜í•´ì•¼ UIê°€ ê¹¨ì§€ì§€ ì•ŠìŒ
                    return None 

    except Exception as e:
        print(f"âŒ API ì—ëŸ¬ ë°œìƒ ({filename}): {str(e)}")
        # API í‚¤ ì˜¤ë¥˜ë‚˜ ëª¨ë¸ëª… ì˜¤ë¥˜ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
        return None

    return None

# ==========================================
# [UI] ì‚¬ì´ë“œë°” ì„¤ì •
# ==========================================
with st.sidebar:
    st.title("âš™ï¸ ì„¤ì •")

    # API Key
    api_key = ""
    try:
        if "general" in st.secrets and "google_api_key" in st.secrets["general"]:
            api_key = st.secrets["general"]["google_api_key"]
    except: pass

    if api_key:
        st.success("ğŸ”‘ API Key ë¡œë“œ ì™„ë£Œ")
    else:
        api_key = st.text_input("ğŸ”‘ Google API Key", type="password")

    st.markdown("---")
    
    # 1. ëª¨ë¸ ì„ íƒ
    st.subheader("ğŸ–¼ï¸ ëª¨ë¸ ì„ íƒ")
    model_choice = st.radio(
        "ëª¨ë¸ ì„ íƒ", 
        ("ë‚˜ë…¸ë°”ë‚˜ë‚˜ í”„ë¡œ (Gemini 3)", "ë‚˜ë…¸ë°”ë‚˜ë‚˜ (Gemini 2.5)"), 
        index=0,
        label_visibility="collapsed"
    )
    if "í”„ë¡œ" in model_choice:
        SELECTED_IMAGE_MODEL = "gemini-3-pro-image-preview"
    else:
        SELECTED_IMAGE_MODEL = "gemini-2.5-flash-image"

    st.markdown("---")

    # 2. ì˜ìƒ ì¥ë¥´ ì„ íƒ
    st.subheader("ğŸ¨ ì˜ìƒ ì¥ë¥´(Mood)")
    
    PRESET_INFO = """ëŒ€ì‚¬ì— ì–´ìš¸ë¦¬ëŠ” 2d ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ ìŠ¤í‹±ë§¨ ì—°ì¶œë¡œ ì„¤ëª…ê³¼ ì´í•´ê°€ ì˜ë˜ëŠ” í™”ë©´ ìë£Œ ëŠë‚Œìœ¼ë¡œ ê·¸ë ¤ì¤˜ ìƒí™©ì„ ì˜ ë‚˜íƒ€ë‚´ê²Œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ë§ê³  í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ
ë„ˆë¬´ ì–´ì§€ëŸ½ì§€ ì•Šê²Œ, ê¸€ì”¨ëŠ” í•µì‹¬ í‚¤ì›Œë“œ 2~3ë§Œ ë‚˜ì˜¤ê²Œ í•œë‹¤
ê¸€ì”¨ê°€ ë„ˆë¬´ ë§ì§€ ì•Šê²Œ í•µì‹¬ë§Œ. 2D ìŠ¤í‹±ë§¨ì„ í™œìš©í•´ ëŒ€ë³¸ì„ ì„¤ëª…ì´ ì˜ë˜ê²Œ ì„¤ëª…í•˜ëŠ” ì—°ì¶œì„ í•œë‹¤. ìë§‰ ìŠ¤íƒ€ì¼ ì—°ì¶œì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
ê¸€ì”¨ê°€ ë‚˜ì˜¬ê²½ìš° í•µì‹¬ í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œë§Œ ë‚˜ì˜¤ê²Œ ë„ˆë¬´ ê¸€ì´ ë§ì§€ ì•Šë„ë¡ í•œë‹¤, ê¸€ìëŠ” ë°°ê²½ê³¼ ì„œë¬¼ì— ìì—°ìŠ¤ëŸ½ê²Œ ì—°ì¶œ, ì „ì²´ ë°°ê²½ ì—°ì¶œì€ 2Dë¡œ ë””í…Œì¼í•˜ê²Œ ëª°ì…ê° ìˆê²Œ ì—°ì¶œí•´ì„œ ê·¸ë ¤ì¤˜ (16:9)
ë‹¤ì–‘í•œ ì¥ì†Œì™€ ìƒí™© ì—°ì¶œë¡œ ë°°ê²½ì„ ë””í…Œì¼í•˜ê²Œ í•œë‹¤. ë¬´ì¡°ê±´ 2D ìŠ¤í‹±ë§¨ ì—°ì¶œ"""
    
    PRESET_HISTORY = """ì—­ì‚¬ì  ì‚¬ì‹¤ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ '2D ì‹œë„¤ë§ˆí‹± ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ ìŠ¤í‹±ë§¨ ì• ë‹ˆë©”ì´ì…˜' ìŠ¤íƒ€ì¼.
ê¹Šì´ ìˆëŠ” ìƒ‰ê°(Dark & Rich Tone)ê³¼ ê·¹ì ì¸ ì¡°ëª… ì‚¬ìš©.
ìºë¦­í„°ëŠ” 2D ì‹¤ë£¨ì—£ì´ë‚˜ ìŠ¤í‹±ë§¨ì´ì§€ë§Œ ì‹œëŒ€ì— ë§ëŠ” ì˜ìƒê³¼ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì°©ìš©.
2D ìŠ¤í‹±ë§¨ì„ í™œìš©í•´ ëŒ€ë³¸ì„ ì„¤ëª…ì´ ì˜ë˜ê²Œ ì„¤ëª…í•˜ëŠ” ì—°ì¶œì„ í•œë‹¤. ìë§‰ ìŠ¤íƒ€ì¼ ì—°ì¶œì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
ì „ìŸ, ê¸°ê·¼ ë“±ì˜ ë¬˜ì‚¬ëŠ” ìƒì§•ì ì´ê³  ì€ìœ ì ìœ¼ë¡œ í‘œí˜„. ë„ˆë¬´ ê³ ì–´í‹±í•œ ì—°ì¶œì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
ë°°ê²½ ë¬˜ì‚¬ì— ë””í…Œì¼ì„ ì‚´ë ¤ ì‹œëŒ€ì  ë¶„ìœ„ê¸°ë¥¼ ê°•ì¡°. ë¬´ì¡°ê±´ ì–¼êµ´ì´ ë‘¥ê·¼ 2D ìŠ¤í‹±ë§¨ ì—°ì¶œ."""

    PRESET_WEBTOON = """í•œêµ­ ì¸ê¸° ì›¹íˆ° ìŠ¤íƒ€ì¼ì˜ ê³ í€„ë¦¬í‹° 2D ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´ì…˜ (Korean Webtoon Style).
ì„ ëª…í•œ íœì„ ê³¼ í™”ë ¤í•œ ì±„ìƒ‰. ì§‘ì¤‘ì„ (Speed lines)ì€ ì •ë§ ì¤‘ìš”í•œ ìˆœê°„ì—ë§Œ ê°€ë” ì‚¬ìš©.
ìºë¦­í„°ëŠ” 8ë“±ì‹  ì›¹íˆ° ì£¼ì¸ê³µ ìŠ¤íƒ€ì¼. ìºë¦­í„° ì£¼ë³€ì˜ 'ìƒí™©'ê³¼ 'ë°°ê²½(ì¥ì†Œ)'ì„ ì•„ì£¼ êµ¬ì²´ì ì´ê³  ë°€ë„ ìˆê²Œ ë¬˜ì‚¬.
ë‹¨ìˆœ ì¸ë¬¼ ì»·ë³´ë‹¤ëŠ” ì£¼ë³€ ì‚¬ë¬¼ê³¼ ë°°ê²½ì´ í•¨ê»˜ ë³´ì´ëŠ” êµ¬ë„ ì„ í˜¸. 
ì „ì²´ì ìœ¼ë¡œ ë°°ê²½ ë””í…Œì¼ì´ ì‚´ì•„ìˆëŠ” ë„¤ì´ë²„ ì›¹íˆ° ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼. (16:9)"""

    PRESET_NEWS = """'ê³ í™”ì§ˆ ì‹¤ì‚¬ ìë£Œí™”ë©´(Photorealistic Stock Footage)'.
ê·¸ë¦¼ì´ë‚˜ ë§Œí™” ëŠë‚Œì´ ì „í˜€ ì—†ëŠ”, ì‹¤ì œ DSLR ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•œ ë“¯í•œ 4K ì‹¤ì‚¬(Real Photo) í€„ë¦¬í‹°.
ë‰´ìŠ¤ ìŠ¤íŠœë””ì˜¤ê°€ ì•„ë‹Œ, ëŒ€ë³¸ ë‚´ìš©ì„ ì„¤ëª…í•˜ëŠ” ì‚¬ì‹¤ì ì¸ 'í˜„ì¥ ìŠ¤ì¼€ì¹˜', 'ì¸ì„œíŠ¸ ì»·', 'ì‚¬ë¬¼ í´ë¡œì¦ˆì—…'.
ì¸ë¬¼ì€ ì‹¤ì œ í•œêµ­ ì‚¬ëŒ(Korean)ì²˜ëŸ¼, ë°°ê²½ì€ ì‹¤ì œ ì¥ì†Œì²˜ëŸ¼ ì‚¬ì‹¤ì ìœ¼ë¡œ ë¬˜ì‚¬.
ì¶”ìƒì ì¸ ë‚´ìš©ì€ ì€ìœ ì ì¸ ì‹¤ì‚¬ ìë£Œí™”ë©´ ëŠë‚Œìœ¼ë¡œ ì—°ì¶œ. (16:9, Cinematic Lighting).
ì¸ë¬¼ë“¤ ë“±ì¥ì‹œ ëŒ€ë³¸ì— ì–´ìš¸ë¦¬ëŠ” ì¸ë¬¼ë“¤ì˜ í–‰ë™ ë˜ëŠ” ê°ì • ì—°ì¶œ.
ëŒ€ë³¸ì— ì–´ìš¸ë¦¬ëŠ” ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„í™œí™”ë©´ìœ¼ë¡œ ì—°ì¶œí•˜ì§€ ë§ê³  í•˜ë‚˜ì˜ í™”ë©´ìœ¼ë¡œ ì—°ì¶œí•œë‹¤."""

    PRESET_MANGA = """ì¼ë³¸ ëŒ€ì‘ ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ (High-Budget Anime Style).
ì„œì •ì ì¸ ëŠë‚Œë³´ë‹¤ëŠ” 'ì •ë³´ëŸ‰ì´ ë§ê³  ì¹˜ë°€í•œ' ê³ ë°€ë„ ë°°ê²½ ì‘í™” (High Detail Backgrounds).
ìºë¦­í„°ì˜ í‘œì •ê³¼ í–‰ë™ì„ 'ìˆœê°„ í¬ì°©'í•˜ë“¯ ì—­ë™ì ìœ¼ë¡œ ë¬˜ì‚¬.
ëŒ€ë³¸ì˜ ì§€ë¬¸ì„ í•˜ë‚˜ë„ ë†“ì¹˜ì§€ ì•Šê³  ì‹œê°í™”í•˜ëŠ” 'ì² ì €í•œ ë””í…Œì¼' ìœ„ì£¼. (16:9)
ì „ì²´ ëŒ€ë³¸ì— ì–´ìš¸ë¦¬ëŠ” í•˜ë‚˜ì˜ ì¥ë©´ìœ¼ë¡œ ì—°ì¶œ."""

    # [NEW] í˜ì¸íŠ¸ ìµìŠ¤í”Œë ˆì´ë„ˆ í”„ë¦¬ì…‹
    PRESET_PAINT = """'The Paint Explainer' ìœ íŠœë¸Œ ì±„ë„ ìŠ¤íƒ€ì¼ (Minimalist Stickman).
ë‹¨ìƒ‰ ëŠë‚Œì˜ ë°°ê²½(Pure White Background). ë°°ê²½ ë¬˜ì‚¬ ìˆìŒ.
ê²€ì€ìƒ‰ ì„ ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ë‹¨ìˆœí•œ ì¡¸ë¼ë§¨(Stick Figure) ìºë¦­í„°. (ë‘¥ê·¼ ë¨¸ë¦¬, ë§‰ëŒ€ê¸° íŒ”ë‹¤ë¦¬).
MS ê·¸ë¦¼íŒ(MS Paint)ìœ¼ë¡œ ê·¸ë¦° ë“¯í•œ í‚¤ì¹˜í•˜ê³  ë‹¨ìˆœí•œ ëŠë‚Œ.
ì±„ìƒ‰ì€ ì ë‹¹íˆ í•˜ê³  íŠ¹ì • ì‚¬ë¬¼(êµ­ê¸°, ëˆ ë“±)ì—ë§Œ ì›ìƒ‰ í¬ì¸íŠ¸ ì»¬ëŸ¬ ì‚¬ìš©.
ë³µì¡í•œ ì˜ˆìˆ ì  ê¸°êµë‚˜ ëª…ì•”(Shading) ì ˆëŒ€ ê¸ˆì§€. ë‹¨ìˆœí•˜ê³  ì§ê´€ì ì¸ ì„¤ëª…í™”."""

    # [NEW] ìŠ¤í‹±ë§¨ ì‚¬ì‹¤ì  ì—°ì¶œ í”„ë¦¬ì…‹ (ìƒí™©/ê°ì •/ë°°ê²½ ë””í…Œì¼ ê°•ì¡°)
    PRESET_REALISTIC = """ê³ í€„ë¦¬í‹° ì–¼êµ´ì´ ë‘¥ê·¼ 2D ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼, ì‚¬ì‹¤ì ì¸ ë°°ê²½ê³¼ ì¡°ëª… ì—°ì¶œ.
ìºë¦­í„°: ì–¼êµ´ì´ ë‘¥ê·¼ í•˜ì–€ìƒ‰ 2D ìŠ¤í‹±ë§¨ë“¤. ë‹¨ìˆœí•œ ë‚™ì„œê°€ ì•„ë‹ˆë¼, ëª…ì•”ê³¼ ë©ì–´ë¦¬ê°ì´ ëŠê»´ì§€ëŠ” 'ê³ ê¸‰ ìŠ¤í‹±ë§¨' ìŠ¤íƒ€ì¼. ì–¼êµ´ì´ í¬ê²Œ ì˜ë³´ì´ê²Œ ì—°ì¶œ.
ë°°ê²½: ë‹¨ìˆœí•œ ë‹¨ìƒ‰ ë°°ê²½ ê¸ˆì§€. ëŒ€ë³¸ì˜ ì¥ì†Œ(ì‚¬ë¬´ì‹¤, ê±°ë¦¬, ë°© ì•ˆ, ì „ì¥ ë“±)ë¥¼ 'ì‚¬ì§„'ì²˜ëŸ¼ ë””í…Œì¼í•˜ê³  ì…ì²´ì ìœ¼ë¡œ 2d ë¬˜ì‚¬.
ë¶„ìœ„ê¸°: ì •ë³´ ì „ë‹¬ë³´ë‹¤ëŠ” 'ìƒí™©ê·¹(Drama)'ì— ì§‘ì¤‘. ì˜í™”ì ì¸ ì¡°ëª…(Cinematic Lighting)ê³¼ ì‹¬ë„(Depth) í‘œí˜„.
ì—°ì¶œ: ìŠ¤í‹±ë§¨ ì—¬ëŸ¬ ìºë¦­í„°ë“¤ì´ ëŒ€ë³¸ ì† í–‰ë™ì„ ë¦¬ì–¼í•˜ê²Œ ì—°ê¸°(Acting). ê°ì • í‘œí˜„ì€ í‘œì •ë³´ë‹¤ëŠ” ì—­ë™ì ì¸ ëª¸ì§“(Body Language)ìœ¼ë¡œ ê·¹ëŒ€í™”.
ì ˆëŒ€ ê¸ˆì§€: í™”ë©´ ë¶„í• (Split Screen), í…ìŠ¤íŠ¸ ë‚˜ì—´, ë‹¨ìˆœ ì¸í¬ê·¸ë˜í”½ ìŠ¤íƒ€ì¼."""

    if 'style_prompt_area' not in st.session_state:
        st.session_state['style_prompt_area'] = PRESET_INFO

    def update_style_text():
        selection = st.session_state.genre_radio
        if "ë°ì€ ì •ë³´" in selection:
            st.session_state['style_prompt_area'] = PRESET_INFO
        elif "ì—­ì‚¬/ë‹¤í" in selection:
            st.session_state['style_prompt_area'] = PRESET_HISTORY
        elif "ì›¹íˆ°" in selection:
            st.session_state['style_prompt_area'] = PRESET_WEBTOON
        elif "ì¼ë³¸ ë§Œí™”" in selection:
            st.session_state['style_prompt_area'] = PRESET_MANGA
        elif "í™”ì´íŠ¸ë³´ë“œ" in selection:
            st.session_state['style_prompt_area'] = PRESET_PAINT
        elif "ë¦¬ì–¼ ìŠ¤í‹±ë§¨" in selection: # [NEW] ëª¨ë“œ ì—°ê²°
            st.session_state['style_prompt_area'] = PRESET_REALISTIC
        else:
            st.session_state['style_prompt_area'] = PRESET_NEWS

    genre_select = st.radio(
        "ì¥ë¥´ ì„ íƒ", 
        (
            "ë°ì€ ì •ë³´/ì´ìŠˆ (Bright & Flat)", 
            "ì—­ì‚¬/ë‹¤í (Cinematic & Immersive)", 
            "í•œêµ­ ì›¹íˆ° (K-Webtoon Style)", 
            "ì¼ë³¸ ë§Œí™” (Japanese Manga/Anime)", 
            "ë‰´ìŠ¤/ì‹¤ì‚¬ ìë£Œí™”ë©´ (Realistic Footage)",
            "í™”ì´íŠ¸ë³´ë“œ/ìŠ¤í‹±ë§¨ (The Paint Explainer Style)",
            "ë¦¬ì–¼ ìŠ¤í‹±ë§¨ (Netflix Drama Style)" # [NEW] ì˜µì…˜ ì¶”ê°€
        ), 
        index=0,
        key="genre_radio",
        on_change=update_style_text,
        label_visibility="collapsed"
    )

    if "ë°ì€ ì •ë³´" in genre_select:
        SELECTED_GENRE_MODE = "info"
    elif "ì—­ì‚¬/ë‹¤í" in genre_select:
        SELECTED_GENRE_MODE = "history"
    elif "ì›¹íˆ°" in genre_select:
        SELECTED_GENRE_MODE = "webtoon"
    elif "ì¼ë³¸ ë§Œí™”" in genre_select:
        SELECTED_GENRE_MODE = "manga"
    elif "í™”ì´íŠ¸ë³´ë“œ" in genre_select:
        SELECTED_GENRE_MODE = "paint_explainer"
    elif "ë¦¬ì–¼ ìŠ¤í‹±ë§¨" in genre_select: # [NEW] ëª¨ë“œ ë³€ìˆ˜ ë§¤í•‘
        SELECTED_GENRE_MODE = "realistic_stickman"
    else:
        SELECTED_GENRE_MODE = "news"

    st.markdown("---")

    # 3. ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì–¸ì–´ ì„ íƒ
    st.subheader("ğŸŒ ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì–¸ì–´")
    target_language = st.selectbox(
        "ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì–¸ì–´",
        ("Korean", "English", "Japanese"),
        index=0,
        label_visibility="collapsed"
    )

    st.markdown("---")

    st.subheader("ğŸ–Œï¸ ê·¸ë¦¼ì²´ ì§€ì¹¨ (ìˆ˜ì • ê°€ëŠ¥)")
    style_instruction = st.text_area(
        "ìŠ¤íƒ€ì¼ ì§€ì¹¨", 
        key="style_prompt_area",
        height=250,
        label_visibility="collapsed"
    )

    st.markdown("---")
    st.subheader("â±ï¸ ì„¤ì •")
    chunk_duration = st.slider("ì¥ë©´ ì‹œê°„(ì´ˆ):", 5, 60, 30, 5)
    chars_limit = chunk_duration * 8
    max_workers = st.slider("ì‘ì—… ì†ë„:", 1, 10, 5)

# ==========================================
# [UI] ë©”ì¸ í™”ë©´
# ==========================================
st.title("ğŸ¬ AI ì´ë¯¸ì§€ ìƒì„±ê¸° (Pro)")
st.caption(f"ë‹¤í¬ëª¨ë“œ & ë¹… í…ìŠ¤íŠ¸ | ğŸ¨ Model: {SELECTED_IMAGE_MODEL} | ğŸ­ Mode: {genre_select}")

# ì„¸ì…˜ ì´ˆê¸°í™”
if 'generated_results' not in st.session_state:
    st.session_state['generated_results'] = []
if 'video_title' not in st.session_state:
    st.session_state['video_title'] = ""
if 'logs' not in st.session_state:
    st.session_state['logs'] = []

st.write("")

# 1. ì œëª© ì…ë ¥
col_title_input, col_space = st.columns([3, 1])
with col_title_input:
    st.text_input(
        "ğŸ“Œ ì˜ìƒ ì œëª©/ì£¼ì œ (ì„ íƒì‚¬í•­)",
        key="video_title",
        placeholder="ì˜ˆ: ë¶€ìë“¤ì˜ 3ê°€ì§€ ìŠµê´€ (ì „ì²´ ë¶„ìœ„ê¸° ê²°ì •)",
    )

st.write("")
script_input = st.text_area("ğŸ“œ ëŒ€ë³¸ ì…ë ¥ (ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°)", height=350, placeholder="ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ì€...")

def clear_generated_results():
    st.session_state['generated_results'] = []
    st.session_state['logs'] = []
    gc.collect()

st.write("")
start_btn = st.button("ğŸš€ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘í•˜ê¸°", type="primary", use_container_width=True, on_click=clear_generated_results)

if start_btn:
    if not api_key:
        st.error("âš ï¸ Google API Key í•„ìš”")
    elif not script_input:
        st.warning("âš ï¸ ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        user_id = st.session_state['user_id']
        USER_DIR = os.path.join(BASE_PATH, user_id, "output_images")

        st.session_state['generated_results'] = []
        if os.path.exists(USER_DIR):
            try: shutil.rmtree(USER_DIR)
            except: pass
        os.makedirs(USER_DIR, exist_ok=True)

        client = genai.Client(api_key=api_key)
        
        # [NEW] ìƒíƒœì°½ ë° ë¡œê·¸ ì»¨í…Œì´ë„ˆ ìƒì„±
        status_box = st.status("ì‘ì—… ì¤€ë¹„ ì¤‘...", expanded=True)
        log_placeholder = status_box.empty() # ì‹¤ì‹œê°„ ë¡œê·¸ê°€ í‘œì‹œë  ê³µê°„
        progress_bar = st.progress(0)

        def update_log(message):
            """ë¡œê·¸ë¥¼ ì„¸ì…˜ì— ì¶”ê°€í•˜ê³  í™”ë©´ì— ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜"""
            st.session_state['logs'].append(message)
            # ìµœê·¼ 10ì¤„ë§Œ ë³´ì—¬ì£¼ê¸° (ìŠ¤í¬ë¡¤ ì••ë°• ë°©ì§€)
            log_content = "\n".join(st.session_state['logs'][-10:])
            log_placeholder.markdown(f"```bash\n{log_content}\n```")

        # 1. ëŒ€ë³¸ ë¶„í• 
        status_box.update(label="âœ‚ï¸ ëŒ€ë³¸ ë¶„í•  ì¤‘...", state="running")
        chunks = split_script_by_time(script_input, chars_per_chunk=chars_limit)
        total_scenes = len(chunks)
        update_log(f"âœ… ëŒ€ë³¸ì„ {total_scenes}ê°œ ì¥ë©´ìœ¼ë¡œ ë¶„í• í–ˆìŠµë‹ˆë‹¤.")
        
        current_video_title = st.session_state.get('video_title', "").strip()
        if not current_video_title:
            current_video_title = "ì „ë°˜ì ì¸ ëŒ€ë³¸ ë¶„ìœ„ê¸°ì— ì–´ìš¸ë¦¬ëŠ” ë°°ê²½"

        # 2. í”„ë¡¬í”„íŠ¸ ìƒì„± (ë³‘ë ¬)
        status_box.update(label=f"ğŸ“ í”„ë¡¬í”„íŠ¸ ì‘ì„± ì¤‘... (ì´ {total_scenes}ì¥)", state="running")
        prompts = []

        with ThreadPoolExecutor(max_workers=max_workers) as executor:
            futures = []
            for i, chunk in enumerate(chunks):
                futures.append(executor.submit(
                    generate_prompt,
                    api_key, i, chunk, 
                    style_instruction,
                    current_video_title,
                    SELECTED_GENRE_MODE, # ì¥ë¥´ ì „ë‹¬
                    target_language      # ì–¸ì–´ ì „ë‹¬
                ))
            
            completed_prompts = 0
            for future in as_completed(futures):
                result = future.result()
                prompts.append(result)
                completed_prompts += 1
                progress_bar.progress(completed_prompts / (total_scenes * 2))
                # [NEW] ê°œë³„ ì§„í–‰ìƒí™© ë¡œê·¸ ì¶œë ¥
                update_log(f"ğŸ“ Scene {result[0]} í”„ë¡¬í”„íŠ¸ ì‘ì„± ì™„ë£Œ")

        prompts.sort(key=lambda x: x[0])
        update_log("âœ… ëª¨ë“  í”„ë¡¬í”„íŠ¸ ì‘ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.")

        # 3. ì´ë¯¸ì§€ ìƒì„± (ë³‘ë ¬)
        status_box.update(label=f"ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (Model: {SELECTED_IMAGE_MODEL})", state="running")
        results = []

        with ThreadPoolExecutor(max_workers=max_workers) as executor:
            future_to_meta = {}
            for s_num, prompt_text in prompts:
                idx = s_num - 1
                orig_text = chunks[idx]
                fname = make_filename(s_num, orig_text)
                time.sleep(0.05)
                
                future = executor.submit(
                    generate_image,
                    client, prompt_text, fname, USER_DIR,
                    SELECTED_IMAGE_MODEL, 
                    style_instruction
                )
                future_to_meta[future] = (s_num, fname, orig_text, prompt_text)

            completed_imgs = 0
            for future in as_completed(future_to_meta):
                s_num, fname, orig_text, p_text = future_to_meta[future]
                path = future.result()
                
                if path:
                    results.append({
                        "scene": s_num, "path": path, "filename": fname, 
                        "script": orig_text, "prompt": p_text
                    })
                    # [NEW] ì„±ê³µ ë¡œê·¸
                    update_log(f"ğŸ“¸ Scene {s_num}: ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ ({fname})")
                else:
                    # [NEW] ì‹¤íŒ¨ ë¡œê·¸
                    update_log(f"âš ï¸ Scene {s_num}: ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (ì •ì±…/ì˜¤ë¥˜)")
                
                completed_imgs += 1
                progress_bar.progress(0.5 + (completed_imgs / total_scenes * 0.5))

        results.sort(key=lambda x: x['scene'])
        st.session_state['generated_results'] = results
        
        # ì™„ë£Œ ì²˜ë¦¬
        update_log("âœ¨ ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        status_box.update(label="âœ… ìƒì„± ì™„ë£Œ! ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.", state="complete", expanded=False)

# ==========================================
# [ê²°ê³¼ í™”ë©´]
# ==========================================
if st.session_state['generated_results']:
    user_id = st.session_state['user_id']
    CURRENT_USER_DIR = os.path.join(BASE_PATH, user_id, "output_images")

    st.divider()
    st.markdown(f"## ğŸ“¸ ê²°ê³¼ë¬¼ ({len(st.session_state['generated_results'])}ì¥)")
    
    zip_data = create_zip_buffer(CURRENT_USER_DIR)
    st.download_button("ğŸ“¦ ì „ì²´ ì´ë¯¸ì§€ ZIP ë‹¤ìš´ë¡œë“œ", data=zip_data, file_name="all_images.zip", mime="application/zip", use_container_width=True)
    st.markdown("---")

    for index, item in enumerate(st.session_state['generated_results']):
        with st.container(border=True):
            cols = st.columns([1, 2])
            
            # [ì˜¤ë¥¸ìª½: ì •ë³´ ë° ìˆ˜ì •]
            with cols[1]:
                st.markdown(f"### Scene {item['scene']:02d}")
                st.markdown(f"**ëŒ€ë³¸:**\n\n{item['script']}")
                
                with st.expander("ğŸ“ í”„ë¡¬í”„íŠ¸ ìˆ˜ì • & í™•ì¸", expanded=False):
                    prompt_key = f"prompt_edit_{index}"
                    edited_prompt = st.text_area(
                        "í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ì™¼ìª½ì˜ [ì´ë¯¸ì§€ ë‹¤ì‹œ ìƒì„±] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
                        value=item['prompt'],
                        height=150,
                        key=prompt_key
                    )

            # [ì™¼ìª½: ì´ë¯¸ì§€ ë° ë²„íŠ¼]
            with cols[0]:
                try: st.image(item['path'], use_container_width=True)
                except: st.error("ì´ë¯¸ì§€ ì—†ìŒ")

                if st.button(f"ğŸ”„ ì´ë¯¸ì§€ ë‹¤ì‹œ ìƒì„±", key=f"regen_img_{index}", use_container_width=True):
                    if not api_key: st.error("API Key í•„ìš”")
                    else:
                        current_prompt_text = st.session_state.get(prompt_key, item['prompt'])

                        with st.spinner(f"Scene {item['scene']} ì¬ìƒì„± ì¤‘..."):
                            client = genai.Client(api_key=api_key)
                            
                            new_path = generate_image(
                                client, 
                                current_prompt_text, 
                                item['filename'],
                                CURRENT_USER_DIR, 
                                SELECTED_IMAGE_MODEL, 
                                style_instruction
                            )
                            
                            if new_path:
                                st.session_state['generated_results'][index]['path'] = new_path
                                st.session_state['generated_results'][index]['prompt'] = current_prompt_text
                                st.rerun()
                
                try:
                    with open(item['path'], "rb") as file:
                        st.download_button("â¬‡ï¸ ì´ë¯¸ì§€ ì €ì¥", data=file, file_name=item['filename'], mime="image/png", key=f"btn_down_{item['scene']}")

                except: pass
